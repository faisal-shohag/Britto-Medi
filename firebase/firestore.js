import{_registerComponent as t,registerVersion as e,_getProvider as n,getApp as s,_removeServiceInstance as r,SDK_VERSION as i}from"https://www.gstatic.com/firebasejs/9.14.0/firebase-app.js";const o=function(n){const r=[];let s=0;for(let t=0;t<n.length;t++){let e=n.charCodeAt(t);e<128?r[s++]=e:(e<2048?r[s++]=e>>6|192:(55296==(64512&e)&&t+1<n.length&&56320==(64512&n.charCodeAt(t+1))?(e=65536+((1023&e)<<10)+(1023&n.charCodeAt(++t)),r[s++]=e>>18|240,r[s++]=e>>12&63|128):r[s++]=e>>12|224,r[s++]=e>>6&63|128),r[s++]=63&e|128)}return r},a={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray(r,e){if(!Array.isArray(r))throw Error("encodeByteArray takes an array as a parameter");this.init_();const s=e?this.byteToCharMapWebSafe_:this.byteToCharMap_,i=[];for(let n=0;n<r.length;n+=3){var o=r[n],a=n+1<r.length,u=a?r[n+1]:0,c=n+2<r.length,h=c?r[n+2]:0;let e=(15&u)<<2|h>>6,t=63&h;c||(t=64,a||(e=64)),i.push(s[o>>2],s[(3&o)<<4|u>>4],s[e],s[t])}return i.join("")},encodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?btoa(e):this.encodeByteArray(o(e),t)},decodeString(n,r){if(this.HAS_NATIVE_SUPPORT&&!r)return atob(n);{var s=this.decodeStringToByteArray(n,r);const c=[];let e=0,t=0;for(;e<s.length;){var i,o,a,u=s[e++];u<128?c[t++]=String.fromCharCode(u):191<u&&u<224?(i=s[e++],c[t++]=String.fromCharCode((31&u)<<6|63&i)):239<u&&u<365?(i=((7&u)<<18|(63&s[e++])<<12|(63&s[e++])<<6|63&s[e++])-65536,c[t++]=String.fromCharCode(55296+(i>>10)),c[t++]=String.fromCharCode(56320+(1023&i))):(o=s[e++],a=s[e++],c[t++]=String.fromCharCode((15&u)<<12|(63&o)<<6|63&a))}return c.join("")}},decodeStringToByteArray(t,e){this.init_();const n=e?this.charToByteMapWebSafe_:this.charToByteMap_,r=[];for(let e=0;e<t.length;){var s=n[t.charAt(e++)],i=e<t.length?n[t.charAt(e)]:0,o=++e<t.length?n[t.charAt(e)]:64,a=++e<t.length?n[t.charAt(e)]:64;if(++e,null==s||null==i||null==o||null==a)throw Error();if(r.push(s<<2|i>>4),64!==o){const t=i<<4&240|o>>2;if(r.push(t),64!==a){const t=o<<6&192|a;r.push(t)}}}return r},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let e=0;e<this.ENCODED_VALS.length;e++)this.byteToCharMap_[e]=this.ENCODED_VALS.charAt(e),this.charToByteMap_[this.byteToCharMap_[e]]=e,this.byteToCharMapWebSafe_[e]=this.ENCODED_VALS_WEBSAFE.charAt(e),(this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[e]]=e)>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(e)]=e,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(e)]=e)}}},u=function(e){return function(e){e=o(e);return a.encodeByteArray(e,!0)}(e).replace(/\./g,"")};function c(){return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:""}function h(){return!function(){try{return"[object process]"===Object.prototype.toString.call(global.process)}catch(e){return}}()&&navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")}const l=()=>function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("Unable to locate global object.")}().__FIREBASE_DEFAULTS__,d=()=>{if("undefined"!=typeof document){let e;try{e=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch(e){return}var t=e&&function(e){try{return a.decodeString(e,!0)}catch(e){console.error("base64Decode failed: ",e)}return null}(e[1]);return t&&JSON.parse(t)}},f=()=>{try{return l()||(()=>{var e;if("undefined"!=typeof process&&void 0!==process.env)return e=process.env.__FIREBASE_DEFAULTS__,e?JSON.parse(e):void 0})()||d()}catch(e){return void console.info("Unable to get __FIREBASE_DEFAULTS__ due to: "+e)}},m=e=>{e=e;const t=null==(n=null==(n=f())?void 0:n.emulatorHosts)?void 0:n[e];if(t){var n=t.lastIndexOf(":");if(n<=0||n+1===t.length)throw new Error(`Invalid host ${t} with no separate hostname and port!`);e=parseInt(t.substring(n+1),10);return"["===t[0]?[t.substring(1,n-1),e]:[t.substring(0,n),e]}};class g extends Error{constructor(e,t,n){super(t),this.code=e,this.customData=n,this.name="FirebaseError",Object.setPrototypeOf(this,g.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,p.prototype.create)}}class p{constructor(e,t,n){this.service=e,this.serviceName=t,this.errors=n}create(e,...t){var r,t=t[0]||{},n=this.service+"/"+e,e=this.errors[e],e=e?(r=t,e.replace(y,(e,t)=>{var n=r[t];return null!=n?String(n):`<${t}?>`})):"Error",e=this.serviceName+`: ${e} (${n}).`;return new g(n,e,t)}}const y=/\{\$([^}]+)}/g;function w(e,t){if(e===t)return!0;const n=Object.keys(e),r=Object.keys(t);for(const s of n){if(!r.includes(s))return!1;const n=e[s],i=t[s];if(v(n)&&v(i)){if(!w(n,i))return!1}else if(n!==i)return!1}for(const e of r)if(!n.includes(e))return!1;return!0}function v(e){return null!==e&&"object"==typeof e}function I(e){return e&&e._delegate?e._delegate:e}class b{constructor(e,t,n){this.name=e,this.instanceFactory=t,this.type=n,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(e){return this.instantiationMode=e,this}setMultipleInstances(e){return this.multipleInstances=e,this}setServiceProps(e){return this.serviceProps=e,this}setInstanceCreatedCallback(e){return this.onInstanceCreated=e,this}}var E;!function(e){e[e.DEBUG=0]="DEBUG",e[e.VERBOSE=1]="VERBOSE",e[e.INFO=2]="INFO",e[e.WARN=3]="WARN",e[e.ERROR=4]="ERROR",e[e.SILENT=5]="SILENT"}(E=E||{});const T={debug:E.DEBUG,verbose:E.VERBOSE,info:E.INFO,warn:E.WARN,error:E.ERROR,silent:E.SILENT},S=E.INFO,_={[E.DEBUG]:"log",[E.VERBOSE]:"log",[E.INFO]:"info",[E.WARN]:"warn",[E.ERROR]:"error"},x=(e,t,...n)=>{if(!(t<e.logLevel)){var r=(new Date).toISOString(),s=_[t];if(!s)throw new Error(`Attempted to log a message with an invalid logType (value: ${t})`);console[s](`[${r}]  ${e.name}:`,...n)}};var A,D="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},C=C||{},N=D||self;function k(){}function R(e){var t=typeof e;return"array"==(t="object"!=t?t:e?Array.isArray(e)?"array":t:"null")||"object"==t&&"number"==typeof e.length}function L(e){var t=typeof e;return"object"==t&&null!=e||"function"==t}var M="closure_uid_"+(1e9*Math.random()>>>0),O=0;function V(e,t,n){return e.call.apply(e.bind,arguments)}function F(t,n,e){if(t)return 2<arguments.length?(r=Array.prototype.slice.call(arguments,2),function(){var e=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(e,r),t.apply(n,e)}):function(){return t.apply(n,arguments)};var r;throw Error()}function P(e,t,n){return(P=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?V:F).apply(null,arguments)}function B(t,e){var n=Array.prototype.slice.call(arguments,1);return function(){var e=n.slice();return e.push.apply(e,arguments),t.apply(this,e)}}function U(e,i){function t(){}t.prototype=i.prototype,e.X=i.prototype,e.prototype=new t,(e.prototype.constructor=e).Wb=function(e,t,n){for(var r=Array(arguments.length-2),s=2;s<arguments.length;s++)r[s-2]=arguments[s];return i.prototype[t].apply(e,r)}}function q(){this.s=this.s,this.o=this.o}q.prototype.s=!1,q.prototype.na=function(){this.s||(this.s=!0,this.M())},q.prototype.M=function(){if(this.o)for(;this.o.length;)this.o.shift()()};const G=Array.prototype.indexOf?function(e,t){return Array.prototype.indexOf.call(e,t,void 0)}:function(t,n){if("string"==typeof t)return"string"!=typeof n||1!=n.length?-1:t.indexOf(n,0);for(let e=0;e<t.length;e++)if(e in t&&t[e]===n)return e;return-1};function K(t){var n=t.length;if(0<n){const r=Array(n);for(let e=0;e<n;e++)r[e]=t[e];return r}return[]}function j(t,n){for(let e=1;e<arguments.length;e++){var r=arguments[e];if(R(r)){const n=t.length||0,s=r.length||0;t.length=n+s;for(let e=0;e<s;e++)t[n+e]=r[e]}else t.push(r)}}function $(e,t){this.type=e,this.g=this.target=t,this.defaultPrevented=!1}$.prototype.h=function(){this.defaultPrevented=!0};var Q=function(){if(!N.addEventListener||!Object.defineProperty)return!1;var e=!1,t=Object.defineProperty({},"passive",{get:function(){e=!0}});try{N.addEventListener("test",k,t),N.removeEventListener("test",k,t)}catch(e){}return e}();function z(e){return/^[\s\xa0]*$/.test(e)}var H=String.prototype.trim?function(e){return e.trim()}:function(e){return/^[\s\xa0]*([\s\S]*?)[\s\xa0]*$/.exec(e)[1]};function W(e,t){return e<t?-1:t<e?1:0}function Y(){var e=N.navigator;return(e=e&&e.userAgent)?e:""}function X(e){return-1!=Y().indexOf(e)}function J(e){return J[" "](e),e}J[" "]=k;var Z,tt,et=X("Opera"),nt=X("Trident")||X("MSIE"),st=X("Edge"),rt=st||nt,it=X("Gecko")&&!(-1!=Y().toLowerCase().indexOf("webkit")&&!X("Edge"))&&!(X("Trident")||X("MSIE"))&&!X("Edge"),ot=-1!=Y().toLowerCase().indexOf("webkit")&&!X("Edge");function at(){var e=N.document;return e?e.documentMode:void 0}e:{var ut="",ct=(tt=Y(),it?/rv:([^\);]+)(\)|;)/.exec(tt):st?/Edge\/([\d\.]+)/.exec(tt):nt?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(tt):ot?/WebKit\/(\S+)/.exec(tt):et?/(?:Version)[ \/]?(\S+)/.exec(tt):void 0);if(ct&&(ut=ct?ct[1]:""),nt){var ht=at();if(null!=ht&&ht>parseFloat(ut)){Z=String(ht);break e}}Z=ut}var mt,lt,dt={};function ft(){return e=dt,Object.prototype.hasOwnProperty.call(e,9)?e[9]:e[9]=function(){let t=0;const n=H(String(Z)).split("."),r=H("9").split("."),s=Math.max(n.length,r.length);for(let e=0;0==t&&e<s;e++){var i=n[e]||"",o=r[e]||"";do{if(i=/(\d*)(\D*)(.*)/.exec(i)||["","","",""],o=/(\d*)(\D*)(.*)/.exec(o)||["","","",""],0==i[0].length&&0==o[0].length)break;t=W(0==i[1].length?0:parseInt(i[1],10),0==o[1].length?0:parseInt(o[1],10))||W(0==i[2].length,0==o[2].length)||W(i[2],o[2]),i=i[3],o=o[3]}while(0==t)}return 0<=t}();var e}var gt=lt=N.document&&nt?(mt=at())||parseInt(Z,10)||void 0:void 0;function pt(e,t){if($.call(this,e?e.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,e){var n=this.type=e.type,r=e.changedTouches&&e.changedTouches.length?e.changedTouches[0]:null;if(this.target=e.target||e.srcElement,this.g=t,t=e.relatedTarget){if(it){e:{try{J(t.nodeName);var s=!0;break e}catch(e){}s=!1}s||(t=null)}}else"mouseover"==n?t=e.fromElement:"mouseout"==n&&(t=e.toElement);this.relatedTarget=t,r?(this.clientX=void 0!==r.clientX?r.clientX:r.pageX,this.clientY=void 0!==r.clientY?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0):(this.clientX=void 0!==e.clientX?e.clientX:e.pageX,this.clientY=void 0!==e.clientY?e.clientY:e.pageY,this.screenX=e.screenX||0,this.screenY=e.screenY||0),this.button=e.button,this.key=e.key||"",this.ctrlKey=e.ctrlKey,this.altKey=e.altKey,this.shiftKey=e.shiftKey,this.metaKey=e.metaKey,this.pointerId=e.pointerId||0,this.pointerType="string"==typeof e.pointerType?e.pointerType:yt[e.pointerType]||"",this.state=e.state,(this.i=e).defaultPrevented&&pt.X.h.call(this)}}U(pt,$);var yt={2:"touch",3:"pen",4:"mouse"},wt=(pt.prototype.h=function(){pt.X.h.call(this);var e=this.i;e.preventDefault?e.preventDefault():e.returnValue=!1},"closure_listenable_"+(1e6*Math.random()|0)),vt=0;function It(e,t,n,r,s){this.listener=e,this.proxy=null,this.src=t,this.type=n,this.capture=!!r,this.ha=s,this.key=++vt,this.ba=this.ea=!1}function bt(e){e.ba=!0,e.listener=null,e.proxy=null,e.src=null,e.ha=null}function Et(e,t,n){for(const r in e)t.call(n,e[r],r,e)}function Tt(e){const t={};for(const n in e)t[n]=e[n];return t}const St="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function _t(t,e){let n,r;for(let e=1;e<arguments.length;e++){for(n in r=arguments[e])t[n]=r[n];for(let e=0;e<St.length;e++)n=St[e],Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}}function xt(e){this.src=e,this.g={},this.h=0}function At(e,t){var n,r,s,i=t.type;i in e.g&&(r=e.g[i],(n=0<=(s=G(r,t)))&&Array.prototype.splice.call(r,s,1),n&&(bt(t),0==e.g[i].length&&(delete e.g[i],e.h--)))}function Dt(e,t,n,r){for(var s=0;s<e.length;++s){var i=e[s];if(!i.ba&&i.listener==t&&i.capture==!!n&&i.ha==r)return s}return-1}xt.prototype.add=function(e,t,n,r,s){var i=e.toString(),o=((e=this.g[i])||(e=this.g[i]=[],this.h++),Dt(e,t,r,s));return-1<o?(t=e[o],n||(t.ea=!1)):((t=new It(t,this.src,i,!!r,s)).ea=n,e.push(t)),t};var Ct="closure_lm_"+(1e6*Math.random()|0),Nt={};function kt(e,t,n,r,s){if(r&&r.once)return Lt(e,t,n,r,s);if(Array.isArray(t)){for(var i=0;i<t.length;i++)kt(e,t[i],n,r,s);return null}return n=Ut(n),e&&e[wt]?e.N(t,n,L(r)?!!r.capture:!!r,s):Rt(e,t,n,!1,r,s)}function Rt(e,t,n,r,s,i){if(!t)throw Error("Invalid event type");var o=L(s)?!!s.capture:!!s,a=Pt(e);if(a||(e[Ct]=a=new xt(e)),(n=a.add(t,n,r,o,i)).proxy)return n;if(r=function(){const n=Ft;return function e(t){return n.call(e.src,e.listener,t)}}(),(n.proxy=r).src=e,r.listener=n,e.addEventListener)void 0===(s=Q?s:o)&&(s=!1),e.addEventListener(t.toString(),r,s);else if(e.attachEvent)e.attachEvent(Vt(t.toString()),r);else{if(!e.addListener||!e.removeListener)throw Error("addEventListener and attachEvent are unavailable.");e.addListener(r)}return n}function Lt(e,t,n,r,s){if(Array.isArray(t)){for(var i=0;i<t.length;i++)Lt(e,t[i],n,r,s);return null}return n=Ut(n),e&&e[wt]?e.O(t,n,L(r)?!!r.capture:!!r,s):Rt(e,t,n,!0,r,s)}function Mt(e,t,n,r,s){if(Array.isArray(t))for(var i=0;i<t.length;i++)Mt(e,t[i],n,r,s);else r=L(r)?!!r.capture:!!r,n=Ut(n),e&&e[wt]?(e=e.i,(t=String(t).toString())in e.g&&-1<(n=Dt(i=e.g[t],n,r,s))&&(bt(i[n]),Array.prototype.splice.call(i,n,1),0==i.length&&(delete e.g[t],e.h--))):(e=e&&Pt(e))&&(t=e.g[t.toString()],(n=(e=-1)<(e=t?Dt(t,n,r,s):e)?t[e]:null)&&Ot(n))}function Ot(e){var t,n,r;"number"!=typeof e&&e&&!e.ba&&((t=e.src)&&t[wt]?At(t.i,e):(n=e.type,r=e.proxy,t.removeEventListener?t.removeEventListener(n,r,e.capture):t.detachEvent?t.detachEvent(Vt(n),r):t.addListener&&t.removeListener&&t.removeListener(r),(n=Pt(t))?(At(n,e),0==n.h&&(n.src=null,t[Ct]=null)):bt(e)))}function Vt(e){return e in Nt?Nt[e]:Nt[e]="on"+e}function Ft(e,t){var n,r;return e=!!e.ba||(t=new pt(t,this),n=e.listener,r=e.ha||e.src,e.ea&&Ot(e),n.call(r,t))}function Pt(e){return(e=e[Ct])instanceof xt?e:null}var Bt="__closure_events_fn_"+(1e9*Math.random()>>>0);function Ut(t){return"function"==typeof t?t:(t[Bt]||(t[Bt]=function(e){return t.handleEvent(e)}),t[Bt])}function qt(){q.call(this),this.i=new xt(this),(this.P=this).I=null}function Gt(e,t){var n,r=e.I;if(r)for(n=[];r;r=r.I)n.push(r);if(e=e.P,r=t.type||t,"string"==typeof t?t=new $(t,e):t instanceof $?t.target=t.target||e:(o=t,_t(t=new $(r,e),o)),o=!0,n)for(var s=n.length-1;0<=s;s--)var i=t.g=n[s],o=Kt(i,r,!0,t)&&o;if(o=Kt(i=t.g=e,r,!0,t)&&o,o=Kt(i,r,!1,t)&&o,n)for(s=0;s<n.length;s++)o=Kt(i=t.g=n[s],r,!1,t)&&o}function Kt(e,t,n,r){if(!(t=e.i.g[String(t)]))return!0;t=t.concat();for(var s=!0,i=0;i<t.length;++i){var o,a,u=t[i];u&&!u.ba&&u.capture==n&&(o=u.listener,a=u.ha||u.src,u.ea&&At(e.i,u),s=!1!==o.call(a,r)&&s)}return s&&!r.defaultPrevented}U(qt,q),qt.prototype[wt]=!0,qt.prototype.removeEventListener=function(e,t,n,r){Mt(this,e,t,n,r)},qt.prototype.M=function(){if(qt.X.M.call(this),this.i){var e,t=this.i;for(e in t.g){for(var n=t.g[e],r=0;r<n.length;r++)bt(n[r]);delete t.g[e],t.h--}}this.I=null},qt.prototype.N=function(e,t,n,r){return this.i.add(String(e),t,!1,n,r)},qt.prototype.O=function(e,t,n,r){return this.i.add(String(e),t,!0,n,r)};var jt=N.JSON.stringify;function $t(){var e=Jt;let t=null;return e.g&&(t=e.g,e.g=e.g.next,e.g||(e.h=null),t.next=null),t}var Qt,zt=new class{constructor(e,t){this.i=e,this.j=t,this.h=0,this.g=null}get(){let e;return 0<this.h?(this.h--,e=this.g,this.g=e.next,e.next=null):e=this.i(),e}}(()=>new Ht,e=>e.reset());class Ht{constructor(){this.next=this.g=this.h=null}set(e,t){this.h=e,this.g=t,this.next=null}reset(){this.next=this.g=this.h=null}}function Wt(e){N.setTimeout(()=>{throw e},0)}function Yt(e,t){var n;Qt||(n=N.Promise.resolve(void 0),Qt=function(){n.then(Zt)}),Xt||(Qt(),Xt=!0),Jt.add(e,t)}var Xt=!1,Jt=new class{constructor(){this.h=this.g=null}add(e,t){const n=zt.get();n.set(e,t),this.h?this.h.next=n:this.g=n,this.h=n}};function Zt(){for(var e;e=$t();){try{e.h.call(e.g)}catch(e){Wt(e)}var t=zt;t.j(e),t.h<100&&(t.h++,e.next=t.g,t.g=e)}Xt=!1}function te(e,t){qt.call(this),this.h=e||1,this.g=t||N,this.j=P(this.lb,this),this.l=Date.now()}function ee(e){e.ca=!1,e.R&&(e.g.clearTimeout(e.R),e.R=null)}function ne(e,t,n){if("function"==typeof e)n&&(e=P(e,n));else{if(!e||"function"!=typeof e.handleEvent)throw Error("Invalid listener argument");e=P(e.handleEvent,e)}return 2147483647<Number(t)?-1:N.setTimeout(e,t||0)}function se(e){e.g=ne(()=>{e.g=null,e.i&&(e.i=!1,se(e))},e.j);var t=e.h;e.h=null,e.m.apply(null,t)}U(te,qt),(A=te.prototype).ca=!1,A.R=null,A.lb=function(){var e;this.ca&&(0<(e=Date.now()-this.l)&&e<.8*this.h?this.R=this.g.setTimeout(this.j,this.h-e):(this.R&&(this.g.clearTimeout(this.R),this.R=null),Gt(this,"tick"),this.ca&&(ee(this),this.start())))},A.start=function(){this.ca=!0,this.R||(this.R=this.g.setTimeout(this.j,this.h),this.l=Date.now())},A.M=function(){te.X.M.call(this),ee(this),delete this.g};class re extends q{constructor(e,t){super(),this.m=e,this.j=t,this.h=null,this.i=!1,this.g=null}l(e){this.h=arguments,this.g?this.i=!0:se(this)}M(){super.M(),this.g&&(N.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function ie(e){q.call(this),this.h=e,this.g={}}U(ie,q);var oe=[];function ae(e,t,n,r){Array.isArray(n)||(n&&(oe[0]=n.toString()),n=oe);for(var s=0;s<n.length;s++){var i=kt(t,n[s],r||e.handleEvent,!1,e.h||e);if(!i)break;e.g[i.key]=i}}function ue(e){Et(e.g,function(e,t){this.g.hasOwnProperty(t)&&Ot(e)},e),e.g={}}function ce(){this.g=!0}function he(e,t,n,r){e.info(function(){return"XMLHTTP TEXT ("+t+"): "+function(e,t){if(!e.g)return t;if(!t)return null;try{var n=JSON.parse(t);if(n)for(e=0;e<n.length;e++)if(Array.isArray(n[e])){var r=n[e];if(!(r.length<2)){var s=r[1];if(Array.isArray(s)&&!(s.length<1)){var i=s[0];if("noop"!=i&&"stop"!=i&&"close"!=i)for(var o=1;o<s.length;o++)s[o]=""}}}return jt(n)}catch(e){return t}}(e,n)+(r?" "+r:"")})}ie.prototype.M=function(){ie.X.M.call(this),ue(this)},ie.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")},ce.prototype.Aa=function(){this.g=!1},ce.prototype.info=function(){};var le={},de=null;function fe(){return de=de||new qt}function me(e){$.call(this,le.Pa,e)}function ge(e){var t=fe();Gt(t,new me(t))}function pe(e,t){$.call(this,le.STAT_EVENT,e),this.stat=t}function ye(e){var t=fe();Gt(t,new pe(t,e))}function we(e,t){$.call(this,le.Qa,e),this.size=t}function ve(e,t){if("function"!=typeof e)throw Error("Fn must not be null and must be a function");return N.setTimeout(function(){e()},t)}le.Pa="serverreachability",U(me,$),le.STAT_EVENT="statevent",U(pe,$),le.Qa="timingevent",U(we,$);var Ie={NO_ERROR:0,mb:1,zb:2,yb:3,tb:4,xb:5,Ab:6,Ma:7,TIMEOUT:8,Db:9},be={rb:"complete",Nb:"success",Na:"error",Ma:"abort",Fb:"ready",Gb:"readystatechange",TIMEOUT:"timeout",Bb:"incrementaldata",Eb:"progress",ub:"downloadprogress",Vb:"uploadprogress"};function Ee(){}function Te(e){return e.h||(e.h=e.i())}function Se(){}Ee.prototype.h=null;var xe={OPEN:"a",qb:"b",Na:"c",Cb:"d"};function Ae(){$.call(this,"d")}function De(){$.call(this,"c")}function Ce(){}function Ne(e,t,n,r){this.l=e,this.j=t,this.m=n,this.U=r||1,this.S=new ie(this),this.O=Re,this.T=new te(e=rt?125:void 0),this.H=null,this.i=!1,this.s=this.A=this.v=this.K=this.F=this.V=this.B=null,this.D=[],this.g=null,this.C=0,this.o=this.u=null,this.Y=-1,this.I=!1,this.N=0,this.L=null,this.$=this.J=this.Z=this.P=!1,this.h=new ke}function ke(){this.i=null,this.g="",this.h=!1}U(Ae,$),U(De,$),U(Ce,Ee),Ce.prototype.g=function(){return new XMLHttpRequest},Ce.prototype.i=function(){return{}};var _e=new Ce,Re=45e3,Le={},Me={};function Oe(e,t,n){e.K=1,e.v=tn(We(t)),e.s=n,e.P=!0,Ve(e,null)}function Ve(e,t){e.F=Date.now(),Ue(e),e.A=We(e.v);var o,a,u,c,h,l,n=e.A,r=e.U;Array.isArray(r)||(r=[String(r)]),mn(n.i,"t",r),e.C=0,n=e.l.H,e.h=new ke,e.g=fs(e.l,n?t:null,!e.s),0<e.N&&(e.L=new re(P(e.La,e,e.g),e.N)),ae(e.S,e.g,"readystatechange",e.ib),t=e.H?Tt(e.H):{},e.s?(e.u||(e.u="POST"),t["Content-Type"]="application/x-www-form-urlencoded",e.g.da(e.A,e.u,e.s,t)):(e.u="GET",e.g.da(e.A,e.u,null,t)),ge(),o=e.j,a=e.u,u=e.A,c=e.m,h=e.U,l=e.s,o.info(function(){if(o.g)if(l)for(var e="",t=l.split("&"),n=0;n<t.length;n++){var r,s,i=t[n].split("=");1<i.length&&(r=i[0],i=i[1],e=2<=(s=r.split("_")).length&&"type"==s[1]?e+(r+"=")+i+"&":e+(r+"=redacted&"))}else e=null;else e=l;return"XMLHTTP REQ ("+c+") [attempt "+h+"]: "+a+"\n"+u+"\n"+e})}function Fe(e){return!!e.g&&"GET"==e.u&&2!=e.K&&e.l.Da}function Pe(e,t,n){let r,s=!0;for(;!e.I&&e.C<n.length;){if((r=Be(e,n))==Me){4==t&&(e.o=4,ye(14),s=!1),he(e.j,e.m,null,"[Incomplete Response]");break}if(r==Le){e.o=4,ye(15),he(e.j,e.m,n,"[Invalid Chunk]"),s=!1;break}he(e.j,e.m,r,null),$e(e,r)}Fe(e)&&r!=Me&&r!=Le&&(e.h.g="",e.C=0),4!=t||0!=n.length||e.h.h||(e.o=1,ye(16),s=!1),e.i=e.i&&s,s?0<n.length&&!e.$&&(e.$=!0,(t=e.l).g==e&&t.$&&!t.K&&(t.j.info("Great, no buffering proxy detected. Bytes received: "+n.length),is(t),t.K=!0,ye(11))):(he(e.j,e.m,n,"[Invalid Chunked Response]"),je(e),Ke(e))}function Be(e,t){var n=e.C,r=t.indexOf("\n",n);return-1==r?Me:(n=Number(t.substring(n,r)),isNaN(n)?Le:(r+=1)+n>t.length?Me:(t=t.substr(r,n),e.C=r+n,t))}function Ue(e){e.V=Date.now()+e.O,qe(e,e.O)}function qe(e,t){if(null!=e.B)throw Error("WatchDog timer not null");e.B=ve(P(e.gb,e),t)}function Ge(e){e.B&&(N.clearTimeout(e.B),e.B=null)}function Ke(e){0==e.l.G||e.I||us(e.l,e)}function je(e){Ge(e);var t=e.L;t&&"function"==typeof t.na&&t.na(),e.L=null,ee(e.T),ue(e.S),e.g&&(t=e.g,e.g=null,t.abort(),t.na())}function $e(e,t){try{var n=e.l;if(0!=n.G&&(n.g==e||In(n.h,e)))if(!e.J&&In(n.h,e)&&3==n.G){try{var r=n.Fa.g.parse(t)}catch(e){r=null}if(Array.isArray(r)&&3==r.length){var s=r;if(0==s[0]){e:if(!n.u){if(n.g){if(!(n.g.F+3e3<e.F))break e;as(n),Xn(n)}rs(n),ye(18)}}else n.Ba=s[1],0<n.Ba-n.T&&s[2]<37500&&n.L&&0==n.A&&!n.v&&(n.v=ve(P(n.cb,n),6e3));if(vn(n.h)<=1&&n.ja){try{n.ja()}catch(e){}n.ja=void 0}}else hs(n,11)}else if(!e.J&&n.g!=e||as(n),!z(t))for(s=n.Fa.g.parse(t),t=0;t<s.length;t++){var i=s[t];if(n.T=i[0],i=i[1],2==n.G)if("c"==i[0]){n.I=i[1],n.ka=i[2];const t=i[3],s=(null!=t&&(n.ma=t,n.j.info("VER="+n.ma)),i[4]);null!=s&&(n.Ca=s,n.j.info("SVER="+n.Ca));var o,a=i[5];null!=a&&"number"==typeof a&&0<a&&(r=1.5*a,n.J=r,n.j.info("backChannelRequestTimeoutMs_="+r)),r=n;const l=e.g;if(l){const e=l.g?l.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(!e||(o=r.h).g||-1==e.indexOf("spdy")&&-1==e.indexOf("quic")&&-1==e.indexOf("h2")||(o.j=o.l,o.g=new Set,o.h&&(bn(o,o.h),o.h=null)),r.D){const e=l.g?l.g.getResponseHeader("X-HTTP-Session-Id"):null;e&&(r.za=e,Ze(r.F,r.D,e))}}n.G=3,n.l&&n.l.xa(),n.$&&(n.P=Date.now()-e.F,n.j.info("Handshake RTT: "+n.P+"ms"));var u,c,h=e;(r=n).sa=ds(r,r.H?r.ka:null,r.V),h.J?(En(r.h,h),u=h,(c=r.J)&&u.setTimeout(c),u.B&&(Ge(u),Ue(u)),r.g=h):ss(r),0<n.i.length&&Zn(n)}else"stop"!=i[0]&&"close"!=i[0]||hs(n,7);else 3==n.G&&("stop"==i[0]||"close"==i[0]?"stop"==i[0]?hs(n,7):Yn(n):"noop"!=i[0]&&n.l&&n.l.wa(i),n.A=0)}ge()}catch(e){}}function Qe(e,t){if(e.forEach&&"function"==typeof e.forEach)e.forEach(t,void 0);else if(R(e)||"string"==typeof e)Array.prototype.forEach.call(e,t,void 0);else for(var n=function(e){if(e.oa&&"function"==typeof e.oa)return e.oa();if(!e.W||"function"!=typeof e.W){if("undefined"!=typeof Map&&e instanceof Map)return Array.from(e.keys());if(!("undefined"!=typeof Set&&e instanceof Set)){if(R(e)||"string"==typeof e){var t=[];e=e.length;for(var n=0;n<e;n++)t.push(n);return t}t=[],n=0;for(const r in e)t[n++]=r;return t}}}(e),r=function(e){if(e.W&&"function"==typeof e.W)return e.W();if("undefined"!=typeof Map&&e instanceof Map||"undefined"!=typeof Set&&e instanceof Set)return Array.from(e.values());if("string"==typeof e)return e.split("");if(R(e)){for(var t=[],n=e.length,r=0;r<n;r++)t.push(e[r]);return t}for(r in t=[],n=0,e)t[n++]=e[r];return t}(e),s=r.length,i=0;i<s;i++)t.call(void 0,r[i],n&&n[i],e)}(A=Ne.prototype).setTimeout=function(e){this.O=e},A.ib=function(e){e=e.target;const t=this.L;t&&3==jn(e)?t.l():this.La(e)},A.La=function(e){try{if(e==this.g)e:{var t=jn(this.g),n=this.g.Ea();if(this.g.aa(),!(t<3)&&(3!=t||rt||this.g&&(this.h.h||this.g.fa()||$n(this.g)))){this.I||4!=t||7==n||ge(),Ge(this);var r=this.g.aa();this.Y=r;t:if(Fe(this)){var s=$n(this.g),i=(e="",s.length),o=4==jn(this.g);if(!this.h.i){if("undefined"==typeof TextDecoder){je(this),Ke(this);var a="";break t}this.h.i=new N.TextDecoder}for(n=0;n<i;n++)this.h.h=!0,e+=this.h.i.decode(s[n],{stream:o&&n==i-1});s.splice(0,i),this.h.g+=e,this.C=0,a=this.h.g}else a=this.g.fa();if(this.i=200==r,l=this.j,d=this.u,f=this.A,m=this.m,g=this.U,p=t,y=r,l.info(function(){return"XMLHTTP RESP ("+m+") [ attempt "+g+"]: "+d+"\n"+f+"\n"+p+" "+y}),this.i){if(this.Z&&!this.J){t:{if(this.g){var u,c=this.g;if((u=c.g?c.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!z(u)){var h=u;break t}}h=null}if(!(r=h)){this.i=!1,this.o=3,ye(12),je(this),Ke(this);break e}he(this.j,this.m,r,"Initial handshake response via X-HTTP-Initial-Response"),this.J=!0,$e(this,r)}this.P?(Pe(this,t,a),rt&&this.i&&3==t&&(ae(this.S,this.T,"tick",this.hb),this.T.start())):(he(this.j,this.m,a,null),$e(this,a)),4==t&&je(this),this.i&&!this.I&&(4==t?us(this.l,this):(this.i=!1,Ue(this)))}else 400==r&&0<a.indexOf("Unknown SID")?(this.o=3,ye(12)):(this.o=0,ye(13)),je(this),Ke(this)}}}catch(e){}var l,d,f,m,g,p,y},A.hb=function(){var e,t;this.g&&(e=jn(this.g),t=this.g.fa(),this.C<t.length&&(Ge(this),Pe(this,e,t),this.i&&4!=e&&Ue(this)))},A.cancel=function(){this.I=!0,je(this)},A.gb=function(){this.B=null;var e,t,n=Date.now();0<=n-this.V?(e=this.j,t=this.A,e.info(function(){return"TIMEOUT: "+t}),2!=this.K&&(ge(),ye(17)),je(this),this.o=2,Ke(this)):qe(this,this.V-n)};var ze=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function He(e,t){var n;this.g=this.s=this.j="",this.m=null,this.o=this.l="",this.h=!1,e instanceof He?(this.h=void 0!==t?t:e.h,Ye(this,e.j),this.s=e.s,this.g=e.g,Xe(this,e.m),this.l=e.l,t=e.i,(n=new hn).i=t.i,t.g&&(n.g=new Map(t.g),n.h=t.h),Je(this,n),this.o=e.o):e&&(n=String(e).match(ze))?(this.h=!!t,Ye(this,n[1]||"",!0),this.s=en(n[2]||""),this.g=en(n[3]||"",!0),Xe(this,n[4]),this.l=en(n[5]||"",!0),Je(this,n[6]||"",!0),this.o=en(n[7]||"")):(this.h=!!t,this.i=new hn(null,this.h))}function We(e){return new He(e)}function Ye(e,t,n){e.j=n?en(t,!0):t,e.j&&(e.j=e.j.replace(/:$/,""))}function Xe(e,t){if(t){if(t=Number(t),isNaN(t)||t<0)throw Error("Bad port number "+t);e.m=t}else e.m=null}function Je(e,t,n){var r,s;t instanceof hn?(e.i=t,r=e.i,(s=e.h)&&!r.j&&(ln(r),r.i=null,r.g.forEach(function(e,t){var n=t.toLowerCase();t!=n&&(dn(this,t),mn(this,n,e))},r)),r.j=s):(n||(t=nn(t,un)),e.i=new hn(t,e.h))}function Ze(e,t,n){e.i.set(t,n)}function tn(e){return Ze(e,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),e}function en(e,t){return e?t?decodeURI(e.replace(/%25/g,"%2525")):decodeURIComponent(e):""}function nn(e,t,n){return"string"==typeof e?(e=encodeURI(e).replace(t,sn),e=n?e.replace(/%25([0-9a-fA-F]{2})/g,"%$1"):e):null}function sn(e){return"%"+((e=e.charCodeAt(0))>>4&15).toString(16)+(15&e).toString(16)}He.prototype.toString=function(){var e=[],t=this.j,n=(t&&e.push(nn(t,rn,!0),":"),this.g);return!n&&"file"!=t||(e.push("//"),(t=this.s)&&e.push(nn(t,rn,!0),"@"),e.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.m)&&e.push(":",String(n))),(n=this.l)&&(this.g&&"/"!=n.charAt(0)&&e.push("/"),e.push(nn(n,"/"==n.charAt(0)?an:on,!0))),(n=this.i.toString())&&e.push("?",n),(n=this.o)&&e.push("#",nn(n,cn)),e.join("")};var rn=/[#\/\?@]/g,on=/[#\?:]/g,an=/[#\?]/g,un=/[#\?@]/g,cn=/#/g;function hn(e,t){this.h=this.g=null,this.i=e||null,this.j=!!t}function ln(e){if(!e.g&&(e.g=new Map,e.h=0,e.i)){var t=e.i;if(t){t=t.split("&");for(var n=0;n<t.length;n++){var r,s=t[n].indexOf("="),i=null;0<=s?(r=t[n].substring(0,s),i=t[n].substring(s+1)):r=t[n],s=r,i=i?decodeURIComponent(i.replace(/\+/g," ")):"",e.add(decodeURIComponent(s.replace(/\+/g," ")),i)}}}}function dn(e,t){ln(e),t=gn(e,t),e.g.has(t)&&(e.i=null,e.h-=e.g.get(t).length,e.g.delete(t))}function fn(e,t){return ln(e),t=gn(e,t),e.g.has(t)}function mn(e,t,n){dn(e,t),0<n.length&&(e.i=null,e.g.set(gn(e,t),K(n)),e.h+=n.length)}function gn(e,t){return t=String(t),t=e.j?t.toLowerCase():t}function pn(e){this.l=e||yn,e=N.PerformanceNavigationTiming?0<(e=N.performance.getEntriesByType("navigation")).length&&("hq"==e[0].nextHopProtocol||"h2"==e[0].nextHopProtocol):!!(N.g&&N.g.Ga&&N.g.Ga()&&N.g.Ga().$b),this.j=e?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}(A=hn.prototype).add=function(e,t){ln(this),this.i=null,e=gn(this,e);var n=this.g.get(e);return n||this.g.set(e,n=[]),n.push(t),this.h+=1,this},A.forEach=function(n,r){ln(this),this.g.forEach(function(e,t){e.forEach(function(e){n.call(r,e,t,this)},this)},this)},A.oa=function(){ln(this);const e=Array.from(this.g.values()),n=Array.from(this.g.keys()),r=[];for(let t=0;t<n.length;t++){var s=e[t];for(let e=0;e<s.length;e++)r.push(n[t])}return r},A.W=function(t){ln(this);let n=[];if("string"==typeof t)fn(this,t)&&(n=n.concat(this.g.get(gn(this,t))));else{t=Array.from(this.g.values());for(let e=0;e<t.length;e++)n=n.concat(t[e])}return n},A.set=function(e,t){return ln(this),this.i=null,fn(this,e=gn(this,e))&&(this.h-=this.g.get(e).length),this.g.set(e,[t]),this.h+=1,this},A.get=function(e,t){return e&&0<(e=this.W(e)).length?String(e[0]):t},A.toString=function(){if(this.i)return this.i;if(!this.g)return"";const e=[],t=Array.from(this.g.keys());for(var n=0;n<t.length;n++)for(var r=t[n],s=encodeURIComponent(String(r)),i=this.W(r),r=0;r<i.length;r++){var o=s;""!==i[r]&&(o+="="+encodeURIComponent(String(i[r]))),e.push(o)}return this.i=e.join("&")};var yn=10;function wn(e){return!!e.h||!!e.g&&e.g.size>=e.j}function vn(e){return e.h?1:e.g?e.g.size:0}function In(e,t){return e.h?e.h==t:!!e.g&&e.g.has(t)}function bn(e,t){e.g?e.g.add(t):e.h=t}function En(e,t){e.h&&e.h==t?e.h=null:e.g&&e.g.has(t)&&e.g.delete(t)}function Tn(t){if(null!=t.h)return t.i.concat(t.h.D);if(null==t.g||0===t.g.size)return K(t.i);{let e=t.i;for(const n of t.g.values())e=e.concat(n.D);return e}}function Sn(){}function _n(){this.g=new Sn}function xn(e,r,t){const s=t||"";try{Qe(e,function(e,t){let n=e;L(e)&&(n=jt(e)),r.push(s+t+"="+encodeURIComponent(n))})}catch(e){throw r.push(s+"type="+encodeURIComponent("_badmap")),e}}function An(e,t,n,r,s){try{t.onload=null,t.onerror=null,t.onabort=null,t.ontimeout=null,s(r)}catch(e){}}function Dn(e){this.l=e.ac||null,this.j=e.jb||!1}function Cn(e,t){qt.call(this),this.D=e,this.u=t,this.m=void 0,this.readyState=Nn,this.status=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.v=new Headers,this.h=null,this.C="GET",this.B="",this.g=!1,this.A=this.j=this.l=null}pn.prototype.cancel=function(){if(this.i=Tn(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){for(const e of this.g.values())e.cancel();this.g.clear()}},Sn.prototype.stringify=function(e){return N.JSON.stringify(e,void 0)},Sn.prototype.parse=function(e){return N.JSON.parse(e,void 0)},U(Dn,Ee),Dn.prototype.g=function(){return new Cn(this.l,this.j)},Dn.prototype.i=function(e){return function(){return e}}({}),U(Cn,qt);var Nn=0;function kn(e){e.j.read().then(e.Ta.bind(e)).catch(e.ga.bind(e))}function Rn(e){e.readyState=4,e.l=null,e.j=null,e.A=null,Ln(e)}function Ln(e){e.onreadystatechange&&e.onreadystatechange.call(e)}(A=Cn.prototype).open=function(e,t){if(this.readyState!=Nn)throw this.abort(),Error("Error reopening a connection");this.C=e,this.B=t,this.readyState=1,Ln(this)},A.send=function(e){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.g=!0;const t={headers:this.v,method:this.C,credentials:this.m,cache:void 0};e&&(t.body=e),(this.D||N).fetch(new Request(this.B,t)).then(this.Wa.bind(this),this.ga.bind(this))},A.abort=function(){this.response=this.responseText="",this.v=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch(()=>{}),1<=this.readyState&&this.g&&4!=this.readyState&&(this.g=!1,Rn(this)),this.readyState=Nn},A.Wa=function(e){if(this.g&&(this.l=e,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=e.headers,this.readyState=2,Ln(this)),this.g&&(this.readyState=3,Ln(this),this.g)))if("arraybuffer"===this.responseType)e.arrayBuffer().then(this.Ua.bind(this),this.ga.bind(this));else if(void 0!==N.ReadableStream&&"body"in e){if(this.j=e.body.getReader(),this.u){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.A=new TextDecoder;kn(this)}else e.text().then(this.Va.bind(this),this.ga.bind(this))},A.Ta=function(e){var t;this.g&&(this.u&&e.value?this.response.push(e.value):this.u||(t=e.value||new Uint8Array(0),(t=this.A.decode(t,{stream:!e.done}))&&(this.response=this.responseText+=t)),(e.done?Rn:Ln)(this),3==this.readyState&&kn(this))},A.Va=function(e){this.g&&(this.response=this.responseText=e,Rn(this))},A.Ua=function(e){this.g&&(this.response=e,Rn(this))},A.ga=function(){this.g&&Rn(this)},A.setRequestHeader=function(e,t){this.v.append(e,t)},A.getResponseHeader=function(e){return this.h&&this.h.get(e.toLowerCase())||""},A.getAllResponseHeaders=function(){if(!this.h)return"";const e=[],t=this.h.entries();for(var n=t.next();!n.done;)n=n.value,e.push(n[0]+": "+n[1]),n=t.next();return e.join("\r\n")},Object.defineProperty(Cn.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(e){this.m=e?"include":"same-origin"}});var Mn=N.JSON.parse;function On(e){qt.call(this),this.headers=new Map,this.u=e||null,this.h=!1,this.C=this.g=null,this.H="",this.m=0,this.j="",this.l=this.F=this.v=this.D=!1,this.B=0,this.A=null,this.J=Vn,this.K=this.L=!1}U(On,qt);var Vn="",Fn=/^https?$/i,Pn=["POST","PUT"];function Bn(e,t){e.h=!1,e.g&&(e.l=!0,e.g.abort(),e.l=!1),e.j=t,e.m=5,Un(e),Gn(e)}function Un(e){e.D||(e.D=!0,Gt(e,"complete"),Gt(e,"error"))}function qn(e){if(e.h&&void 0!==C&&(!e.C[1]||4!=jn(e)||2!=e.aa()))if(e.v&&4==jn(e))ne(e.Ha,0,e);else if(Gt(e,"readystatechange"),4==jn(e)){e.h=!1;try{var t,n,r,s,i=e.aa();switch(i){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var o=!0;break;default:o=!1}if((t=o)||((n=0===i)&&(!(s=String(e.H).match(ze)[1]||null)&&N.self&&N.self.location&&(s=(r=N.self.location.protocol).substr(0,r.length-1)),n=!Fn.test(s?s.toLowerCase():"")),t=n),t)Gt(e,"complete"),Gt(e,"success");else{e.m=6;try{var a=2<jn(e)?e.g.statusText:""}catch(e){a=""}e.j=a+" ["+e.aa()+"]",Un(e)}}finally{Gn(e)}}}function Gn(e,t){if(e.g){Kn(e);const n=e.g,r=e.C[0]?k:null;e.g=null,e.C=null,t||Gt(e,"ready");try{n.onreadystatechange=r}catch(e){}}}function Kn(e){e.g&&e.K&&(e.g.ontimeout=null),e.A&&(N.clearTimeout(e.A),e.A=null)}function jn(e){return e.g?e.g.readyState:0}function $n(e){try{if(!e.g)return null;if("response"in e.g)return e.g.response;switch(e.J){case Vn:case"text":return e.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in e.g)return e.g.mozResponseArrayBuffer}return null}catch(e){return null}}function Qn(e){let n="";return Et(e,function(e,t){n=(n=n+t+":")+e+"\r\n"}),n}function zn(e,t,n){e:{for(r in n){var r=!1;break e}r=!0}r||(n=Qn(n),"string"==typeof e?null!=n&&encodeURIComponent(String(n)):Ze(e,t,n))}function Hn(e,t,n){return n&&n.internalChannelParams&&n.internalChannelParams[e]||t}function Wn(e){this.Ca=0,this.i=[],this.j=new ce,this.ka=this.sa=this.F=this.V=this.g=this.za=this.D=this.ia=this.o=this.S=this.s=null,this.ab=this.U=0,this.Za=Hn("failFast",!1,e),this.L=this.v=this.u=this.m=this.l=null,this.Y=!0,this.pa=this.Ba=this.T=-1,this.Z=this.A=this.C=0,this.Xa=Hn("baseRetryDelayMs",5e3,e),this.bb=Hn("retryDelaySeedMs",1e4,e),this.$a=Hn("forwardChannelMaxRetries",2,e),this.ta=Hn("forwardChannelRequestTimeoutMs",2e4,e),this.ra=e&&e.xmlHttpFactory||void 0,this.Da=e&&e.Zb||!1,this.J=void 0,this.H=e&&e.supportsCrossDomainXhr||!1,this.I="",this.h=new pn(e&&e.concurrentRequestLimit),this.Fa=new _n,this.O=e&&e.fastHandshake||!1,this.N=e&&e.encodeInitMessageHeaders||!1,this.O&&this.N&&(this.N=!1),this.Ya=e&&e.Xb||!1,e&&e.Aa&&this.j.Aa(),e&&e.forceLongPolling&&(this.Y=!1),this.$=!this.O&&this.Y&&e&&e.detectBufferingProxy||!1,this.ja=void 0,this.P=0,this.K=!1,this.la=this.B=null}function Yn(e){var t,n;Jn(e),3==e.G&&(t=e.U++,Ze(n=We(e.F),"SID",e.I),Ze(n,"RID",t),Ze(n,"TYPE","terminate"),es(e,n),(t=new Ne(e,e.j,t,void 0)).K=2,t.v=tn(We(n)),n=!1,!(n=N.navigator&&N.navigator.sendBeacon?N.navigator.sendBeacon(t.v.toString(),""):n)&&N.Image&&((new Image).src=t.v,n=!0),n||(t.g=fs(t.l,null),t.g.da(t.v)),t.F=Date.now(),Ue(t)),ls(e)}function Xn(e){e.g&&(is(e),e.g.cancel(),e.g=null)}function Jn(e){Xn(e),e.u&&(N.clearTimeout(e.u),e.u=null),as(e),e.h.cancel(),e.m&&("number"==typeof e.m&&N.clearTimeout(e.m),e.m=null)}function Zn(e){wn(e.h)||e.m||(e.m=!0,Yt(e.Ja,e),e.C=0)}function ts(e,t){var n=t?t.m:e.U++,r=We(e.F);Ze(r,"SID",e.I),Ze(r,"RID",n),Ze(r,"AID",e.T),es(e,r),e.o&&e.s&&zn(r,e.o,e.s),n=new Ne(e,e.j,n,e.C+1),null===e.o&&(n.H=e.s),t&&(e.i=t.D.concat(e.i)),t=ns(e,n,1e3),n.setTimeout(Math.round(.5*e.ta)+Math.round(.5*e.ta*Math.random())),bn(e.h,n),Oe(n,r,t)}function es(e,n){e.ia&&Et(e.ia,function(e,t){Ze(n,t,e)}),e.l&&Qe({},function(e,t){Ze(n,t,e)})}function ns(r,e,s){s=Math.min(r.i.length,s);var i=r.l?P(r.l.Ra,r.l,r):null;e:{var o=r.i;let n=-1;for(;;){const r=["count="+s];-1==n?0<s?(n=o[0].h,r.push("ofs="+n)):n=0:r.push("ofs="+n);let t=!0;for(let e=0;e<s;e++){var a=o[e].h,u=o[e].g;if((a-=n)<0)n=Math.max(0,o[e].h-100),t=!1;else try{xn(u,r,"req"+a+"_")}catch(r){i&&i(u)}}if(t){i=r.join("&");break e}}}return r=r.i.splice(0,s),e.D=r,i}function ss(e){e.g||e.u||(e.Z=1,Yt(e.Ia,e),e.A=0)}function rs(e){return!(e.g||e.u||3<=e.A||(e.Z++,e.u=ve(P(e.Ia,e),cs(e,e.A)),e.A++,0))}function is(e){null!=e.B&&(N.clearTimeout(e.B),e.B=null)}function os(e){e.g=new Ne(e,e.j,"rpc",e.Z),null===e.o&&(e.g.H=e.s),e.g.N=0;var t=We(e.sa),n=(Ze(t,"RID","rpc"),Ze(t,"SID",e.I),Ze(t,"CI",e.L?"0":"1"),Ze(t,"AID",e.T),Ze(t,"TYPE","xmlhttp"),es(e,t),e.o&&e.s&&zn(t,e.o,e.s),e.J&&e.g.setTimeout(e.J),e.g);e=e.ka,n.K=1,n.v=tn(We(t)),n.s=null,n.P=!0,Ve(n,e)}function as(e){null!=e.v&&(N.clearTimeout(e.v),e.v=null)}function us(e,t){var n,r,s,i=null;if(e.g==t){as(e),is(e),e.g=null;var o=2}else{if(!In(e.h,t))return;i=t.D,En(e.h,t),o=1}if(0!=e.G)if(e.pa=t.Y,t.i)1==o?(i=t.s?t.s.length:0,t=Date.now()-t.F,n=e.C,Gt(o=fe(),new we(o,i)),Zn(e)):ss(e);else if(3==(n=t.o)||0==n&&0<e.pa||(1!=o||(s=t,vn((r=e).h)>=r.h.j-(r.m?1:0)||(r.m?(r.i=s.D.concat(r.i),0):1==r.G||2==r.G||r.C>=(r.Za?0:r.$a)||(r.m=ve(P(r.Ja,r,s),cs(r,r.C)),r.C++,0))))&&(2!=o||!rs(e)))switch(i&&0<i.length&&(t=e.h,t.i=t.i.concat(i)),n){case 1:hs(e,5);break;case 4:hs(e,10);break;case 3:hs(e,6);break;default:hs(e,2)}}function cs(e,t){let n=e.Xa+Math.floor(Math.random()*e.bb);return e.l||(n*=2),n*t}function hs(e,t){if(e.j.info("Error code "+t),2==t){var n=null,r=(e.l&&(n=null),P(e.kb,e)),n=(n||(n=new He("//www.google.com/images/cleardot.gif"),N.location&&"http"==N.location.protocol||Ye(n,"https"),tn(n)),n.toString()),s=new ce;if(N.Image){const i=new Image;i.onload=B(An,s,i,"TestLoadImage: loaded",!0,r),i.onerror=B(An,s,i,"TestLoadImage: error",!1,r),i.onabort=B(An,s,i,"TestLoadImage: abort",!1,r),i.ontimeout=B(An,s,i,"TestLoadImage: timeout",!1,r),N.setTimeout(function(){i.ontimeout&&i.ontimeout()},1e4),i.src=n}else r(!1)}else ye(2);e.G=0,e.l&&e.l.va(t),ls(e),Jn(e)}function ls(e){var t;e.G=0,e.la=[],e.l&&(0==(t=Tn(e.h)).length&&0==e.i.length||(j(e.la,t),j(e.la,e.i),e.h.i.length=0,K(e.i),e.i.length=0),e.l.ua())}function ds(e,t,n){var r,s,i=n instanceof He?We(n):new He(n,void 0);return""!=i.g?(t&&(i.g=t+"."+i.g),Xe(i,i.m)):(i=(r=N.location).protocol,t=t?t+"."+r.hostname:r.hostname,r=+r.port,s=new He(null,void 0),i&&Ye(s,i),t&&(s.g=t),r&&Xe(s,r),n&&(s.l=n),i=s),n=e.D,t=e.za,n&&t&&Ze(i,n,t),Ze(i,"VER",e.ma),es(e,i),i}function fs(e,t,n){if(t&&!e.H)throw Error("Can't create secondary domain capable XhrIo object.");return(t=n&&e.Da&&!e.ra?new On(new Dn({jb:!0})):new On(e.ra)).Ka(e.H),t}function ms(){}function gs(){if(nt&&!(10<=Number(gt)))throw Error("Environmental error: no available transport.")}function ps(e,t){qt.call(this),this.g=new Wn(t),this.l=e,this.h=t&&t.messageUrlParams||null,e=t&&t.messageHeaders||null,t&&t.clientProtocolHeaderRequired&&(e?e["X-Client-Protocol"]="webchannel":e={"X-Client-Protocol":"webchannel"}),this.g.s=e,e=t&&t.initMessageHeaders||null,t&&t.messageContentType&&(e?e["X-WebChannel-Content-Type"]=t.messageContentType:e={"X-WebChannel-Content-Type":t.messageContentType}),t&&t.ya&&(e?e["X-WebChannel-Client-Profile"]=t.ya:e={"X-WebChannel-Client-Profile":t.ya}),this.g.S=e,(e=t&&t.Yb)&&!z(e)&&(this.g.o=e),this.A=t&&t.supportsCrossDomainXhr||!1,this.v=t&&t.sendRawJson||!1,(t=t&&t.httpSessionIdParam)&&!z(t)&&(this.g.D=t,null!==(e=this.h)&&t in e&&t in(e=this.h)&&delete e[t]),this.j=new vs(this)}function ys(e){Ae.call(this);var t=e.__sm__;if(t){e:{for(const n in t){e=n;break e}e=void 0}(this.i=e)&&(e=this.i,t=null!==t&&e in t?t[e]:void 0),this.data=t}else this.data=e}function ws(){De.call(this),this.status=1}function vs(e){this.g=e}(A=On.prototype).Ka=function(e){this.L=e},A.da=function(e,t,n,r){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.H+"; newUri="+e);t=t?t.toUpperCase():"GET",this.H=e,this.j="",this.m=0,this.D=!1,this.h=!0,this.g=(this.u||_e).g(),this.C=this.u?Te(this.u):Te(_e),this.g.onreadystatechange=P(this.Ha,this);try{this.F=!0,this.g.open(t,String(e),!0),this.F=!1}catch(e){return void Bn(this,e)}if(e=n||"",n=new Map(this.headers),r)if(Object.getPrototypeOf(r)===Object.prototype)for(var s in r)n.set(s,r[s]);else{if("function"!=typeof r.keys||"function"!=typeof r.get)throw Error("Unknown input type for opt_headers: "+String(r));for(const e of r.keys())n.set(e,r.get(e))}r=Array.from(n.keys()).find(e=>"content-type"==e.toLowerCase()),s=N.FormData&&e instanceof N.FormData,0<=G(Pn,t)&&!r&&!s&&n.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(const[e,t]of n)this.g.setRequestHeader(e,t);this.J&&(this.g.responseType=this.J),"withCredentials"in this.g&&this.g.withCredentials!==this.L&&(this.g.withCredentials=this.L);try{Kn(this),0<this.B&&((this.K=(i=this.g,nt&&ft()&&"number"==typeof i.timeout&&void 0!==i.ontimeout))?(this.g.timeout=this.B,this.g.ontimeout=P(this.qa,this)):this.A=ne(this.qa,this.B,this)),this.v=!0,this.g.send(e),this.v=!1}catch(e){Bn(this,e)}var i},A.qa=function(){void 0!==C&&this.g&&(this.j="Timed out after "+this.B+"ms, aborting",this.m=8,Gt(this,"timeout"),this.abort(8))},A.abort=function(e){this.g&&this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1,this.m=e||7,Gt(this,"complete"),Gt(this,"abort"),Gn(this))},A.M=function(){this.g&&(this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1),Gn(this,!0)),On.X.M.call(this)},A.Ha=function(){this.s||(this.F||this.v||this.l?qn(this):this.fb())},A.fb=function(){qn(this)},A.aa=function(){try{return 2<jn(this)?this.g.status:-1}catch(e){return-1}},A.fa=function(){try{return this.g?this.g.responseText:""}catch(e){return""}},A.Sa=function(e){var t;if(this.g)return t=this.g.responseText,e&&0==t.indexOf(e)&&(t=t.substring(e.length)),Mn(t)},A.Ea=function(){return this.m},A.Oa=function(){return"string"==typeof this.j?this.j:String(this.j)},(A=Wn.prototype).ma=8,A.G=1,A.Ja=function(t){if(this.m)if(this.m=null,1==this.G){if(!t){this.U=Math.floor(1e5*Math.random()),t=this.U++;const i=new Ne(this,this.j,t,void 0);let e=this.s;if(this.S&&(e?_t(e=Tt(e),this.S):e=this.S),null!==this.o||this.N||(i.H=e,e=null),this.O)e:{for(var n=0,r=0;r<this.i.length;r++){var s=this.i[r];if(void 0===(s="__data__"in s.g&&"string"==typeof(s=s.g.__data__)?s.length:void 0))break;if(4096<(n+=s)){n=r;break e}if(4096===n||r===this.i.length-1){n=r+1;break e}}n=1e3}else n=1e3;n=ns(this,i,n),Ze(r=We(this.F),"RID",t),Ze(r,"CVER",22),this.D&&Ze(r,"X-HTTP-Session-Id",this.D),es(this,r),e&&(this.N?n="headers="+encodeURIComponent(String(Qn(e)))+"&"+n:this.o&&zn(r,this.o,e)),bn(this.h,i),this.Ya&&Ze(r,"TYPE","init"),this.O?(Ze(r,"$req",n),Ze(r,"SID","null"),i.Z=!0,Oe(i,r,null)):Oe(i,r,n),this.G=2}}else 3==this.G&&(t?ts(this,t):0==this.i.length||wn(this.h)||ts(this))},A.Ia=function(){var e;this.u=null,os(this),this.$&&!(this.K||null==this.g||this.P<=0)&&(e=2*this.P,this.j.info("BP detection timer enabled: "+e),this.B=ve(P(this.eb,this),e))},A.eb=function(){this.B&&(this.B=null,this.j.info("BP detection timeout reached."),this.j.info("Buffering proxy detected and switch to long-polling!"),this.L=!1,this.K=!0,ye(10),Xn(this),os(this))},A.cb=function(){null!=this.v&&(this.v=null,Xn(this),rs(this),ye(19))},A.kb=function(e){e?(this.j.info("Successfully pinged google.com"),ye(2)):(this.j.info("Failed to ping google.com"),ye(1))},(A=ms.prototype).xa=function(){},A.wa=function(){},A.va=function(){},A.ua=function(){},A.Ra=function(){},gs.prototype.g=function(e,t){return new ps(e,t)},U(ps,qt),ps.prototype.m=function(){this.g.l=this.j,this.A&&(this.g.H=!0);var e=this.g,t=this.l,n=this.h||void 0;ye(0),e.V=t,e.ia=n||{},e.L=e.Y,e.F=ds(e,null,e.V),Zn(e)},ps.prototype.close=function(){Yn(this.g)},ps.prototype.u=function(e){var t,n=this.g;"string"==typeof e?((t={}).__data__=e,e=t):this.v&&((t={}).__data__=jt(e),e=t),n.i.push(new class{constructor(e,t){this.h=e,this.g=t}}(n.ab++,e)),3==n.G&&Zn(n)},ps.prototype.M=function(){this.g.l=null,delete this.j,Yn(this.g),delete this.g,ps.X.M.call(this)},U(ys,Ae),U(ws,De),U(vs,ms),vs.prototype.xa=function(){Gt(this.g,"a")},vs.prototype.wa=function(e){Gt(this.g,new ys(e))},vs.prototype.va=function(e){Gt(this.g,new ws)},vs.prototype.ua=function(){Gt(this.g,"b")},gs.prototype.createWebChannel=gs.prototype.g,ps.prototype.send=ps.prototype.u,ps.prototype.open=ps.prototype.m,ps.prototype.close=ps.prototype.close,Ie.NO_ERROR=0,Ie.TIMEOUT=8,Ie.HTTP_ERROR=6,be.COMPLETE="complete",(Se.EventType=xe).OPEN="a",xe.CLOSE="b",xe.ERROR="c",xe.MESSAGE="d",qt.prototype.listen=qt.prototype.N,On.prototype.listenOnce=On.prototype.O,On.prototype.getLastError=On.prototype.Oa,On.prototype.getLastErrorCode=On.prototype.Ea,On.prototype.getStatus=On.prototype.aa,On.prototype.getResponseJson=On.prototype.Sa,On.prototype.getResponseText=On.prototype.fa,On.prototype.send=On.prototype.da,On.prototype.setWithCredentials=On.prototype.Ka;var Jo,Zo,Is=Ie,bs=be,Es=le,Ts=10,Ss=11,_s=Dn,xs=Se,As=On;const Ds="@firebase/firestore";class Cs{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}Cs.UNAUTHENTICATED=new Cs(null),Cs.GOOGLE_CREDENTIALS=new Cs("google-credentials-uid"),Cs.FIRST_PARTY=new Cs("first-party-uid"),Cs.MOCK_USER=new Cs("mock-user");let Ns="9.14.0";const ks=new class{constructor(e){this.name=e,this._logLevel=S,this._logHandler=x,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(e){if(!(e in E))throw new TypeError(`Invalid value "${e}" assigned to \`logLevel\``);this._logLevel=e}setLogLevel(e){this._logLevel="string"==typeof e?T[e]:e}get logHandler(){return this._logHandler}set logHandler(e){if("function"!=typeof e)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e}get userLogHandler(){return this._userLogHandler}set userLogHandler(e){this._userLogHandler=e}debug(...e){this._userLogHandler&&this._userLogHandler(this,E.DEBUG,...e),this._logHandler(this,E.DEBUG,...e)}log(...e){this._userLogHandler&&this._userLogHandler(this,E.VERBOSE,...e),this._logHandler(this,E.VERBOSE,...e)}info(...e){this._userLogHandler&&this._userLogHandler(this,E.INFO,...e),this._logHandler(this,E.INFO,...e)}warn(...e){this._userLogHandler&&this._userLogHandler(this,E.WARN,...e),this._logHandler(this,E.WARN,...e)}error(...e){this._userLogHandler&&this._userLogHandler(this,E.ERROR,...e),this._logHandler(this,E.ERROR,...e)}}("@firebase/firestore");function Rs(){return ks.logLevel}function Ls(e){ks.setLogLevel(e)}function Ms(e,...t){ks.logLevel<=E.DEBUG&&(t=t.map(Fs),ks.debug(`Firestore (${Ns}): `+e,...t))}function Os(e,...t){ks.logLevel<=E.ERROR&&(t=t.map(Fs),ks.error(`Firestore (${Ns}): `+e,...t))}function Vs(e,...t){ks.logLevel<=E.WARN&&(t=t.map(Fs),ks.warn(`Firestore (${Ns}): `+e,...t))}function Fs(t){if("string"==typeof t)return t;try{return JSON.stringify(t)}catch(e){return t}}function Ps(e="Unexpected state"){e=`FIRESTORE (${Ns}) INTERNAL ASSERTION FAILED: `+e;throw Os(e),new Error(e)}function Bs(e,t){e||Ps()}function Us(e,t){e||Ps()}function qs(e,t){return e}const Gs={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class Ks extends g{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: `+this.message}}class js{constructor(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}}class $s{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization","Bearer "+e)}}class Qs{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable(()=>t(Cs.UNAUTHENTICATED))}shutdown(){}}class zs{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable(()=>t(this.token.user))}shutdown(){this.changeListener=null}}class Hs{constructor(e){this.t=e,this.currentUser=Cs.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,n){let r=this.i;const s=e=>this.i!==r?(r=this.i,n(e)):Promise.resolve();let i=new js;this.o=()=>{this.i++,this.currentUser=this.u(),i.resolve(),i=new js,t.enqueueRetryable(()=>s(this.currentUser))};const o=()=>{const e=i;t.enqueueRetryable(async()=>{await e.promise,await s(this.currentUser)})},a=e=>{Ms("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.auth.addAuthTokenListener(this.o),o()};this.t.onInit(e=>a(e)),setTimeout(()=>{var e;this.auth||((e=this.t.getImmediate({optional:!0}))?a(e):(Ms("FirebaseAuthCredentialsProvider","Auth not yet detected"),i.resolve(),i=new js))},0),o()}getToken(){const t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then(e=>this.i!==t?(Ms("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):e?(Bs("string"==typeof e.accessToken),new $s(e.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){var e=this.auth&&this.auth.getUid();return Bs(null===e||"string"==typeof e),new Cs(e)}}class Ws{constructor(e,t,n,r){this.h=e,this.l=t,this.m=n,this.g=r,this.type="FirstParty",this.user=Cs.FIRST_PARTY,this.p=new Map}I(){return this.g?this.g():(Bs(!("object"!=typeof this.h||null===this.h||!this.h.auth||!this.h.auth.getAuthHeaderValueForFirstParty)),this.h.auth.getAuthHeaderValueForFirstParty([]))}get headers(){this.p.set("X-Goog-AuthUser",this.l);var e=this.I();return e&&this.p.set("Authorization",e),this.m&&this.p.set("X-Goog-Iam-Authorization-Token",this.m),this.p}}class Ys{constructor(e,t,n,r){this.h=e,this.l=t,this.m=n,this.g=r}getToken(){return Promise.resolve(new Ws(this.h,this.l,this.m,this.g))}start(e,t){e.enqueueRetryable(()=>t(Cs.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class Xs{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&0<e.length&&this.headers.set("x-firebase-appcheck",this.value)}}class Js{constructor(e){this.T=e,this.forceRefresh=!1,this.appCheck=null,this.A=null}start(t,n){const r=e=>{null!=e.error&&Ms("FirebaseAppCheckTokenProvider","Error getting App Check token; using placeholder token instead. Error: "+e.error.message);var t=e.token!==this.A;return this.A=e.token,Ms("FirebaseAppCheckTokenProvider",`Received ${t?"new":"existing"} token.`),t?n(e.token):Promise.resolve()},s=(this.o=e=>{t.enqueueRetryable(()=>r(e))},e=>{Ms("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.appCheck.addTokenListener(this.o)});this.T.onInit(e=>s(e)),setTimeout(()=>{var e;this.appCheck||((e=this.T.getImmediate({optional:!0}))?s(e):Ms("FirebaseAppCheckTokenProvider","AppCheck not yet detected"))},0)}getToken(){var e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then(e=>e?(Bs("string"==typeof e.token),this.A=e.token,new Xs(e.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}class Zs{getToken(){return Promise.resolve(new Xs(""))}invalidateToken(){}start(e,t){}shutdown(){}}function tr(t){const e="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(t);if(e&&"function"==typeof e.getRandomValues)e.getRandomValues(n);else for(let e=0;e<t;e++)n[e]=Math.floor(256*Math.random());return n}class er{static R(){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=Math.floor(256/t.length)*t.length;let r="";for(;r.length<20;){var s=tr(40);for(let e=0;e<s.length;++e)r.length<20&&s[e]<n&&(r+=t.charAt(s[e]%t.length))}return r}}function nr(e,t){return e<t?-1:t<e?1:0}function sr(e,n,r){return e.length===n.length&&e.every((e,t)=>r(e,n[t]))}function rr(e){return e+"\0"}class ir{constructor(e,t){if(this.seconds=e,(this.nanoseconds=t)<0)throw new Ks(Gs.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(1e9<=t)throw new Ks(Gs.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new Ks(Gs.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(253402300800<=e)throw new Ks(Gs.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return ir.fromMillis(Date.now())}static fromDate(e){return ir.fromMillis(e.getTime())}static fromMillis(e){var t=Math.floor(e/1e3),e=Math.floor(1e6*(e-1e3*t));return new ir(t,e)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?nr(this.nanoseconds,e.nanoseconds):nr(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){var e=this.seconds- -62135596800;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class or{constructor(e){this.timestamp=e}static fromTimestamp(e){return new or(e)}static min(){return new or(new ir(0,0))}static max(){return new or(new ir(253402300799,999999999))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class ar{constructor(e,t,n){void 0===t?t=0:t>e.length&&Ps(),void 0===n?n=e.length-t:n>e.length-t&&Ps(),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===ar.comparator(this,e)}child(e){const t=this.segments.slice(this.offset,this.limit());return e instanceof ar?e.forEach(e=>{t.push(e)}):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return this.construct(this.segments,this.offset+(e=void 0===e?1:e),this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(t){if(t.length<this.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}isImmediateParentOf(t){if(this.length+1!==t.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}forEach(n){for(let e=this.offset,t=this.limit();e<t;e++)n(this.segments[e])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(t,n){const r=Math.min(t.length,n.length);for(let e=0;e<r;e++){const r=t.get(e),s=n.get(e);if(r<s)return-1;if(r>s)return 1}return t.length<n.length?-1:t.length>n.length?1:0}}class ur extends ar{construct(e,t,n){return new ur(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...e){const t=[];for(const n of e){if(0<=n.indexOf("//"))throw new Ks(Gs.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter(e=>0<e.length))}return new ur(t)}static emptyPath(){return new ur([])}}const cr=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class hr extends ar{construct(e,t,n){return new hr(e,t,n)}static isValidIdentifier(e){return cr.test(e)}canonicalString(){return this.toArray().map(e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),e=hr.isValidIdentifier(e)?e:"`"+e+"`")).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new hr(["__name__"])}static fromServerFormat(e){const t=[];let n="",r=0;var s=()=>{if(0===n.length)throw new Ks(Gs.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""};let i=!1;for(;r<e.length;){const t=e[r];if("\\"===t){if(r+1===e.length)throw new Ks(Gs.INVALID_ARGUMENT,"Path has trailing escape character: "+e);const t=e[r+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new Ks(Gs.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,r+=2}else"`"===t?i=!i:"."!==t||i?n+=t:s(),r++}if(s(),i)throw new Ks(Gs.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new hr(t)}static emptyPath(){return new hr([])}}class lr{constructor(e){this.path=e}static fromPath(e){return new lr(ur.fromString(e))}static fromName(e){return new lr(ur.fromString(e).popFirst(5))}static empty(){return new lr(ur.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return 2<=this.path.length&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===ur.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return ur.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new lr(new ur(e.slice()))}}class dr{constructor(e,t,n,r){this.indexId=e,this.collectionGroup=t,this.fields=n,this.indexState=r}}function fr(e){return e.fields.find(e=>2===e.kind)}function mr(e){return e.fields.filter(e=>2!==e.kind)}function gr(t,n){let r=nr(t.collectionGroup,n.collectionGroup);if(0!==r)return r;for(let e=0;e<Math.min(t.fields.length,n.fields.length);++e)if(0!==(r=yr(t.fields[e],n.fields[e])))return r;return nr(t.fields.length,n.fields.length)}dr.UNKNOWN_ID=-1;class pr{constructor(e,t){this.fieldPath=e,this.kind=t}}function yr(e,t){var n=hr.comparator(e.fieldPath,t.fieldPath);return 0!==n?n:nr(e.kind,t.kind)}class wr{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new wr(0,br.min())}}function vr(e,t){var n=e.toTimestamp().seconds,e=e.toTimestamp().nanoseconds+1,n=or.fromTimestamp(1e9===e?new ir(n+1,0):new ir(n,e));return new br(n,lr.empty(),t)}function Ir(e){return new br(e.readTime,e.key,-1)}class br{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new br(or.min(),lr.empty(),-1)}static max(){return new br(or.max(),lr.empty(),-1)}}function Er(e,t){let n=e.readTime.compareTo(t.readTime);return 0!==n?n:0!==(n=lr.comparator(e.documentKey,t.documentKey))?n:nr(e.largestBatchId,t.largestBatchId)}const Tr="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class Sr{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(e=>e())}}async function _r(e){if(e.code!==Gs.FAILED_PRECONDITION||e.message!==Tr)throw e;Ms("LocalStore","Unexpectedly lost primary lease")}class xr{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e(e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)},e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)})}catch(e){return this.next(void 0,e)}next(r,s){return this.callbackAttached&&Ps(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(s,this.error):this.wrapSuccess(r,this.result):new xr((t,n)=>{this.nextCallback=e=>{this.wrapSuccess(r,e).next(t,n)},this.catchCallback=e=>{this.wrapFailure(s,e).next(t,n)}})}toPromise(){return new Promise((e,t)=>{this.next(e,t)})}wrapUserFunction(e){try{var t=e();return t instanceof xr?t:xr.resolve(t)}catch(e){return xr.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction(()=>e(t)):xr.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction(()=>e(t)):xr.reject(t)}static resolve(n){return new xr((e,t)=>{e(n)})}static reject(n){return new xr((e,t)=>{t(n)})}static waitFor(e){return new xr((t,n)=>{let r=0,s=0,i=!1;e.forEach(e=>{++r,e.next(()=>{++s,i&&s===r&&t()},e=>n(e))}),i=!0,s===r&&t()})}static or(e){let t=xr.resolve(!1);for(const n of e)t=t.next(e=>e?xr.resolve(e):n());return t}static forEach(e,n){const r=[];return e.forEach((e,t)=>{r.push(n.call(this,e,t))}),this.waitFor(r)}static mapArray(a,u){return new xr((t,n)=>{const r=a.length,s=new Array(r);let i=0;for(let e=0;e<r;e++){const o=e;u(a[o]).next(e=>{s[o]=e,++i===r&&t(s)},e=>n(e))}})}static doWhile(r,s){return new xr((e,t)=>{const n=()=>{!0===r()?s().next(()=>{n()},t):e()};n()})}}class Ar{constructor(t,e){this.action=t,this.transaction=e,this.aborted=!1,this.P=new js,this.transaction.oncomplete=()=>{this.P.resolve()},this.transaction.onabort=()=>{e.error?this.P.reject(new Nr(t,e.error)):this.P.resolve()},this.transaction.onerror=e=>{e=Or(e.target.error);this.P.reject(new Nr(t,e))}}static open(e,t,n,r){try{return new Ar(t,e.transaction(r,n))}catch(e){throw new Nr(t,e)}}get v(){return this.P.promise}abort(e){e&&this.P.reject(e),this.aborted||(Ms("SimpleDb","Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}V(){const e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){e=this.transaction.objectStore(e);return new Rr(e)}}class Dr{constructor(e,t,n){this.name=e,this.version=t,this.S=n,12.2===Dr.D(c())&&Os("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(e){return Ms("SimpleDb","Removing database:",e),Lr(window.indexedDB.deleteDatabase(e)).toPromise()}static C(){if("object"!=typeof indexedDB)return!1;if(Dr.N())return!0;const e=c(),t=Dr.D(e),n=0<t&&t<10,r=Dr.k(e),s=0<r&&r<4.5;return!(0<e.indexOf("MSIE ")||0<e.indexOf("Trident/")||0<e.indexOf("Edge/")||n||s)}static N(){var e;return"undefined"!=typeof process&&"YES"===(null==(e=process.env)?void 0:e.O)}static M(e,t){return e.store(t)}static D(e){const t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=t?t[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static k(e){const t=e.match(/Android ([\d.]+)/i),n=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async F(s){return this.db||(Ms("SimpleDb","Opening database:",this.name),this.db=await new Promise((t,n)=>{const r=indexedDB.open(this.name,this.version);r.onsuccess=e=>{e=e.target.result;t(e)},r.onblocked=()=>{n(new Nr(s,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},r.onerror=e=>{e=e.target.error;"VersionError"===e.name?n(new Ks(Gs.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===e.name?n(new Ks(Gs.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+e)):n(new Nr(s,e))},r.onupgradeneeded=e=>{Ms("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);var t=e.target.result;this.S.$(t,r.transaction,e.oldVersion,this.version).next(()=>{Ms("SimpleDb","Database upgrade to version "+this.version+" complete")})}})),this.B&&(this.db.onversionchange=e=>this.B(e)),this.db}L(t){this.B=t,this.db&&(this.db.onversionchange=e=>t(e))}async runTransaction(e,t,n,r){var s="readonly"===t;let i=0;for(;;){++i;try{this.db=await this.F(e);const t=Ar.open(this.db,e,s?"readonly":"readwrite",n),i=r(t).next(e=>(t.V(),e)).catch(e=>(t.abort(e),xr.reject(e))).toPromise();return i.catch(()=>{}),await t.v,i}catch(e){const t=e,n="FirebaseError"!==t.name&&i<3;if(Ms("SimpleDb","Transaction failed with error:",t.message,"Retrying:",n),this.close(),!n)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}class Cr{constructor(e){this.U=e,this.q=!1,this.K=null}get isDone(){return this.q}get G(){return this.K}set cursor(e){this.U=e}done(){this.q=!0}j(e){this.K=e}delete(){return Lr(this.U.delete())}}class Nr extends Ks{constructor(e,t){super(Gs.UNAVAILABLE,`IndexedDB transaction '${e}' failed: `+t),this.name="IndexedDbTransactionError"}}function kr(e){return"IndexedDbTransactionError"===e.name}class Rr{constructor(e){this.store=e}put(e,t){let n;return Lr(n=void 0!==t?(Ms("SimpleDb","PUT",this.store.name,e,t),this.store.put(t,e)):(Ms("SimpleDb","PUT",this.store.name,"<auto-key>",e),this.store.put(e)))}add(e){return Ms("SimpleDb","ADD",this.store.name,e,e),Lr(this.store.add(e))}get(t){return Lr(this.store.get(t)).next(e=>(Ms("SimpleDb","GET",this.store.name,t,e=void 0===e?null:e),e))}delete(e){return Ms("SimpleDb","DELETE",this.store.name,e),Lr(this.store.delete(e))}count(){return Ms("SimpleDb","COUNT",this.store.name),Lr(this.store.count())}W(e,n){var t=this.options(e,n);if(t.index||"function"!=typeof this.store.getAll){const e=this.cursor(t),n=[];return this.H(e,(e,t)=>{n.push(t)}).next(()=>n)}{const e=this.store.getAll(t.range);return new xr((t,n)=>{e.onerror=e=>{n(e.target.error)},e.onsuccess=e=>{t(e.target.result)}})}}J(e,t){const r=this.store.getAll(e,null===t?void 0:t);return new xr((t,n)=>{r.onerror=e=>{n(e.target.error)},r.onsuccess=e=>{t(e.target.result)}})}Y(e,t){Ms("SimpleDb","DELETE ALL",this.store.name);const n=this.options(e,t);n.X=!1;e=this.cursor(n);return this.H(e,(e,t,n)=>n.delete())}Z(e,t){let n;t?n=e:(n={},t=e);e=this.cursor(n);return this.H(e,t)}tt(r){const e=this.cursor({});return new xr((n,t)=>{e.onerror=e=>{e=Or(e.target.error);t(e)},e.onsuccess=e=>{const t=e.target.result;t?r(t.primaryKey,t.value).next(e=>{e?t.continue():n()}):n()}})}H(e,i){const o=[];return new xr((s,t)=>{e.onerror=e=>{t(e.target.error)},e.onsuccess=e=>{const t=e.target.result;if(t){const n=new Cr(t),r=i(t.primaryKey,t.value,n);if(r instanceof xr){const e=r.catch(e=>(n.done(),xr.reject(e)));o.push(e)}n.isDone?s():null===n.G?t.continue():t.continue(n.G)}else s()}}).next(()=>xr.waitFor(o))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){const n=this.store.index(e.index);return e.X?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function Lr(e){return new xr((t,n)=>{e.onsuccess=e=>{e=e.target.result;t(e)},e.onerror=e=>{e=Or(e.target.error);n(e)}})}let Mr=!1;function Or(e){const t=Dr.D(c());if(12.2<=t&&t<13){const t="An internal error was encountered in the Indexed Database server";if(0<=e.message.indexOf(t)){const e=new Ks("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return Mr||(Mr=!0,setTimeout(()=>{throw e},0)),e}}return e}class Vr{constructor(e,t){this.asyncQueue=e,this.et=t,this.task=null}start(){this.nt(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}nt(e){Ms("IndexBackiller",`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,async()=>{this.task=null;try{Ms("IndexBackiller","Documents written: "+await this.et.st())}catch(e){kr(e)?Ms("IndexBackiller","Ignoring IndexedDB error during index backfill: ",e):await _r(e)}await this.nt(6e4)})}}class Fr{constructor(e,t){this.localStore=e,this.persistence=t}async st(t=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",e=>this.it(e,t))}it(e,t){const n=new Set;let r=t,s=!0;return xr.doWhile(()=>!0===s&&0<r,()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next(t=>{if(null!==t&&!n.has(t))return Ms("IndexBackiller","Processing collection: "+t),this.rt(e,t,r).next(e=>{r-=e,n.add(t)});s=!1})).next(()=>t-r)}rt(r,s,e){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(r,s).next(n=>this.localStore.localDocuments.getNextDocuments(r,s,n,e).next(e=>{const t=e.changes;return this.localStore.indexManager.updateIndexEntries(r,t).next(()=>this.ot(n,e)).next(e=>(Ms("IndexBackiller","Updating offset: "+e),this.localStore.indexManager.updateCollectionGroup(r,s,e))).next(()=>t.size)}))}ot(e,t){let n=e;return t.changes.forEach((e,t)=>{t=Ir(t);0<Er(t,n)&&(n=t)}),new br(n.readTime,n.documentKey,Math.max(t.batchId,e.largestBatchId))}}class Pr{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.ut(e),this.ct=e=>t.writeSequenceNumber(e))}ut(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){var e=++this.previousValue;return this.ct&&this.ct(e),e}}function Br(e){let t=0;for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function Ur(e,t){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function qr(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}Pr.at=-1;class Gr{constructor(e,t){this.comparator=e,this.root=t||jr.EMPTY}insert(e,t){return new Gr(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,jr.BLACK,null,null))}remove(e){return new Gr(this.comparator,this.root.remove(e,this.comparator).copy(null,null,jr.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){var n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:0<n&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){var r=this.comparator(e,n.key);if(0===r)return t+n.left.size;n=r<0?n.left:(t+=n.left.size+1,n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(n){this.inorderTraversal((e,t)=>(n(e,t),!1))}toString(){const n=[];return this.inorderTraversal((e,t)=>(n.push(e+":"+t),!1)),`{${n.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new Kr(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new Kr(this.root,e,this.comparator,!1)}getReverseIterator(){return new Kr(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new Kr(this.root,e,this.comparator,!0)}}class Kr{constructor(e,t,n,r){this.isReverse=r,this.nodeStack=[];let s=1;for(;!e.isEmpty();)if(s=t?n(e.key,t):1,t&&r&&(s*=-1),s<0)e=this.isReverse?e.left:e.right;else{if(0===s){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop();var t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return 0<this.nodeStack.length}peek(){if(0===this.nodeStack.length)return null;var e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class jr{constructor(e,t,n,r,s){this.key=e,this.value=t,this.color=null!=n?n:jr.RED,this.left=null!=r?r:jr.EMPTY,this.right=null!=s?s:jr.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,r,s){return new jr(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=s?s:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let r=this;var s=n(e,r.key);return(r=s<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===s?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n))).fixUp()}removeMin(){if(this.left.isEmpty())return jr.EMPTY;let e=this;return(e=(e=e.left.isRed()||e.left.left.isRed()?e:e.moveRedLeft()).copy(null,null,null,e.left.removeMin(),null)).fixUp()}remove(e,t){let n,r=this;if(t(e,r.key)<0)r=(r=r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()?r:r.moveRedLeft()).copy(null,null,null,r.left.remove(e,t),null);else{if(0===t(e,(r=(r=r.left.isRed()?r.rotateRight():r).right.isEmpty()||r.right.isRed()||r.right.left.isRed()?r:r.moveRedRight()).key)){if(r.right.isEmpty())return jr.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e=(e=(e=e.right.isRed()&&!e.left.isRed()?e.rotateLeft():e).left.isRed()&&e.left.left.isRed()?e.rotateRight():e).left.isRed()&&e.right.isRed()?e.colorFlip():e}moveRedLeft(){let e=this.colorFlip();return e=e.right.left.isRed()?(e=(e=e.copy(null,null,null,null,e.right.rotateRight())).rotateLeft()).colorFlip():e}moveRedRight(){let e=this.colorFlip();return e=e.left.left.isRed()?(e=e.rotateRight()).colorFlip():e}rotateLeft(){var e=this.copy(null,null,jr.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){var e=this.copy(null,null,jr.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){var e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){var e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw Ps();if(this.right.isRed())throw Ps();var e=this.left.check();if(e!==this.right.check())throw Ps();return e+(this.isRed()?0:1)}}jr.EMPTY=null,jr.RED=!0,jr.BLACK=!1,jr.EMPTY=new class{constructor(){this.size=0}get key(){throw Ps()}get value(){throw Ps()}get color(){throw Ps()}get left(){throw Ps()}get right(){throw Ps()}copy(e,t,n,r,s){return this}insert(e,t,n){return new jr(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class $r{constructor(e){this.comparator=e,this.data=new Gr(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(n){this.data.inorderTraversal((e,t)=>(n(e),!1))}forEachInRange(e,t){const n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){var r=n.getNext();if(0<=this.comparator(r.key,e[1]))return;t(r.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){const t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new Qr(this.data.getIterator())}getIteratorFrom(e){return new Qr(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach(e=>{t=t.add(e)}),t}isEqual(e){if(!(e instanceof $r))return!1;if(this.size!==e.size)return!1;const t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(0!==this.comparator(e,r))return!1}return!0}toArray(){const t=[];return this.forEach(e=>{t.push(e)}),t}toString(){const t=[];return this.forEach(e=>t.push(e)),"SortedSet("+t.toString()+")"}copy(e){const t=new $r(this.comparator);return t.data=e,t}}class Qr{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function zr(e){return e.hasNext()?e.getNext():void 0}class Hr{constructor(e){(this.fields=e).sort(hr.comparator)}static empty(){return new Hr([])}unionWith(e){let t=new $r(hr.comparator);for(const e of this.fields)t=t.add(e);for(const n of e)t=t.add(n);return new Hr(t.toArray())}covers(e){for(const t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return sr(this.fields,e.fields,(e,t)=>e.isEqual(t))}}function Wr(){return"undefined"!=typeof atob}class Yr{constructor(e){this.binaryString=e}static fromBase64String(e){e=atob(e);return new Yr(e)}static fromUint8Array(e){e=function(t){let n="";for(let e=0;e<t.length;++e)n+=String.fromCharCode(t[e]);return n}(e);return new Yr(e)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return e=this.binaryString,btoa(e);var e}toUint8Array(){{var t=this.binaryString;const n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return n}}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return nr(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}Yr.EMPTY_BYTE_STRING=new Yr("");const Xr=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function Jr(t){if(Bs(!!t),"string"!=typeof t)return{seconds:Zr(t.seconds),nanos:Zr(t.nanos)};{let e=0;var n=Xr.exec(t);Bs(!!n),n[1]&&(n=((n=n[1])+"000000000").substr(0,9),e=Number(n));const r=new Date(t);return{seconds:Math.floor(r.getTime()/1e3),nanos:e}}}function Zr(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function ti(e){return"string"==typeof e?Yr.fromBase64String(e):Yr.fromUint8Array(e)}function ei(e){return"server_timestamp"===(null==(e=((null==(e=null==e?void 0:e.mapValue)?void 0:e.fields)||{}).__type__)?void 0:e.stringValue)}function ni(e){e=e.mapValue.fields.__previous_value__;return ei(e)?ni(e):e}function si(e){e=Jr(e.mapValue.fields.__local_write_time__.timestampValue);return new ir(e.seconds,e.nanos)}class ri{constructor(e,t,n,r,s,i,o,a){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=r,this.ssl=s,this.forceLongPolling=i,this.autoDetectLongPolling=o,this.useFetchStreams=a}}class ii{constructor(e,t){this.projectId=e,this.database=t||"(default)"}static empty(){return new ii("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(e){return e instanceof ii&&e.projectId===this.projectId&&e.database===this.database}}function oi(e){return null==e}function ai(e){return 0===e&&1/e==-1/0}function ui(e){return"number"==typeof e&&Number.isInteger(e)&&!ai(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}const ci={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},hi={nullValue:"NULL_VALUE"};function li(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?ei(e)?4:_i(e)?9007199254740991:10:Ps()}function di(e,t){if(e===t)return!0;var n,r,s=li(e);if(s!==li(t))return!1;switch(s){case 0:case 9007199254740991:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return si(e).isEqual(si(t));case 3:var i=t;if("string"==typeof e.timestampValue&&"string"==typeof i.timestampValue&&e.timestampValue.length===i.timestampValue.length)return e.timestampValue===i.timestampValue;var o=Jr(e.timestampValue),i=Jr(i.timestampValue);return o.seconds===i.seconds&&o.nanos===i.nanos;case 5:return e.stringValue===t.stringValue;case 6:return o=t,ti(e.bytesValue).isEqual(ti(o.bytesValue));case 7:return e.referenceValue===t.referenceValue;case 8:return i=t,Zr((r=e).geoPointValue.latitude)===Zr(i.geoPointValue.latitude)&&Zr(r.geoPointValue.longitude)===Zr(i.geoPointValue.longitude);case 2:return r=t,"integerValue"in(n=e)&&"integerValue"in r?Zr(n.integerValue)===Zr(r.integerValue):"doubleValue"in n&&"doubleValue"in r&&((n=Zr(n.doubleValue))===(r=Zr(r.doubleValue))?ai(n)===ai(r):isNaN(n)&&isNaN(r));case 9:return sr(e.arrayValue.values||[],t.arrayValue.values||[],di);case 10:{var a=e;const u=a.mapValue.fields||{},c=t.mapValue.fields||{};if(Br(u)!==Br(c))return!1;for(const a in u)if(u.hasOwnProperty(a)&&(void 0===c[a]||!di(u[a],c[a])))return!1;return!0;return}default:return Ps()}}function fi(e,t){return void 0!==(e.values||[]).find(e=>di(e,t))}function mi(e,t){if(e===t)return 0;var n=li(e),r=li(t);if(n!==r)return nr(n,r);switch(n){case 0:case 9007199254740991:return 0;case 1:return nr(e.booleanValue,t.booleanValue);case 2:return i=t,s=Zr(e.integerValue||e.doubleValue),i=Zr(i.integerValue||i.doubleValue),s<i?-1:i<s?1:s===i?0:isNaN(s)?isNaN(i)?0:-1:1;case 3:return gi(e.timestampValue,t.timestampValue);case 4:return gi(si(e),si(t));case 5:return nr(e.stringValue,t.stringValue);case 6:{var s=e.bytesValue;var i=t.bytesValue;const p=ti(s),y=ti(i);return p.compareTo(y);return}case 7:var o=e.referenceValue,a=t.referenceValue,u=o.split("/"),c=a.split("/");for(let e=0;e<u.length&&e<c.length;e++){const a=nr(u[e],c[e]);if(0!==a)return a}return nr(u.length,c.length);case 8:return o=e.geoPointValue,a=t.geoPointValue,0!==(h=nr(Zr(o.latitude),Zr(a.latitude)))?h:nr(Zr(o.longitude),Zr(a.longitude));case 9:var h=e.arrayValue,l=t.arrayValue,d=h.values||[],f=l.values||[];for(let e=0;e<d.length&&e<f.length;++e){const l=mi(d[e],f[e]);if(l)return l}return nr(d.length,f.length);case 10:{l=e.mapValue;var m=t.mapValue;if(l===ci.mapValue&&m===ci.mapValue)return 0;if(l===ci.mapValue)return 1;if(m===ci.mapValue)return-1;const v=l.fields||{},w=Object.keys(v),I=m.fields||{},b=Object.keys(I);w.sort(),b.sort();for(let e=0;e<w.length&&e<b.length;++e){const m=nr(w[e],b[e]);if(0!==m)return m;var g=mi(v[w[e]],I[b[e]]);if(0!==g)return g}return nr(w.length,b.length);return}default:throw Ps()}}function gi(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return nr(e,t);var e=Jr(e),t=Jr(t),n=nr(e.seconds,t.seconds);return 0!==n?n:nr(e.nanos,t.nanos)}function pi(e){return yi(e)}function yi(n){{if("nullValue"in n)return"null";if("booleanValue"in n)return""+n.booleanValue;if("integerValue"in n)return""+n.integerValue;if("doubleValue"in n)return""+n.doubleValue;if("timestampValue"in n)return`time(${(t=Jr(n.timestampValue)).seconds},${t.nanos})`;if("stringValue"in n)return n.stringValue;if("bytesValue"in n)return ti(n.bytesValue).toBase64();if("referenceValue"in n)return t=n.referenceValue,lr.fromName(t).toString();if("geoPointValue"in n)return`geo(${(e=n.geoPointValue).latitude},${e.longitude})`;if("arrayValue"in n){let e="[",t=!0;for(const s of n.arrayValue.values||[])t?t=!1:e+=",",e+=yi(s);return e+"]"}if("mapValue"in n){var r=n.mapValue;let e="{",t=!0;for(const i of Object.keys(r.fields||{}).sort())t?t=!1:e+=",",e+=i+":"+yi(r.fields[i]);return e+"}"}return Ps()}var e,t}function wi(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/`+t.path.canonicalString()}}function vi(e){return!!e&&"integerValue"in e}function Ii(e){return!!e&&"arrayValue"in e}function bi(e){return!!e&&"nullValue"in e}function Ei(e){return!!e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function Ti(e){return!!e&&"mapValue"in e}function Si(t){if(t.geoPointValue)return{geoPointValue:Object.assign({},t.geoPointValue)};if(t.timestampValue&&"object"==typeof t.timestampValue)return{timestampValue:Object.assign({},t.timestampValue)};if(t.mapValue){const n={mapValue:{fields:{}}};return Ur(t.mapValue.fields,(e,t)=>n.mapValue.fields[e]=Si(t)),n}if(t.arrayValue){const r={arrayValue:{values:[]}};for(let e=0;e<(t.arrayValue.values||[]).length;++e)r.arrayValue.values[e]=Si(t.arrayValue.values[e]);return r}return Object.assign({},t)}function _i(e){return"__max__"===(((e.mapValue||{}).fields||{}).__type__||{}).stringValue}function xi(e){return"nullValue"in e?hi:"booleanValue"in e?{booleanValue:!1}:"integerValue"in e||"doubleValue"in e?{doubleValue:NaN}:"timestampValue"in e?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in e?{stringValue:""}:"bytesValue"in e?{bytesValue:""}:"referenceValue"in e?wi(ii.empty(),lr.empty()):"geoPointValue"in e?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in e?{arrayValue:{}}:"mapValue"in e?{mapValue:{}}:Ps()}function Ai(e){return"nullValue"in e?{booleanValue:!1}:"booleanValue"in e?{doubleValue:NaN}:"integerValue"in e||"doubleValue"in e?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in e?{stringValue:""}:"stringValue"in e?{bytesValue:""}:"bytesValue"in e?wi(ii.empty(),lr.empty()):"referenceValue"in e?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in e?{arrayValue:{}}:"arrayValue"in e?{mapValue:{}}:"mapValue"in e?ci:Ps()}function Di(e,t){var n=mi(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?-1:!e.inclusive&&t.inclusive?1:0}function Ci(e,t){var n=mi(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?1:!e.inclusive&&t.inclusive?-1:0}class Ni{constructor(e){this.value=e}static empty(){return new Ni({mapValue:{}})}field(n){if(n.isEmpty())return this.value;{let t=this.value;for(let e=0;e<n.length-1;++e)if(!Ti(t=(t.mapValue.fields||{})[n.get(e)]))return null;return(t=(t.mapValue.fields||{})[n.lastSegment()])||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=Si(t)}setAll(e){let n=hr.emptyPath(),r={},s=[];e.forEach((e,t)=>{if(!n.isImmediateParentOf(t)){const e=this.getFieldsMap(n);this.applyChanges(e,r,s),r={},s=[],n=t.popLast()}e?r[t.lastSegment()]=Si(e):s.push(t.lastSegment())});e=this.getFieldsMap(n);this.applyChanges(e,r,s)}delete(e){const t=this.field(e.popLast());Ti(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return di(this.value,e.value)}getFieldsMap(n){let r=this.value;r.mapValue.fields||(r.mapValue={fields:{}});for(let t=0;t<n.length;++t){let e=r.mapValue.fields[n.get(t)];Ti(e)&&e.mapValue.fields||(e={mapValue:{fields:{}}},r.mapValue.fields[n.get(t)]=e),r=e}return r.mapValue.fields}applyChanges(n,e,t){Ur(e,(e,t)=>n[e]=t);for(const e of t)delete n[e]}clone(){return new Ni(Si(this.value))}}function ki(e){const r=[];return Ur(e.fields,(e,t)=>{const n=new hr([e]);if(Ti(t)){const e=ki(t.mapValue).fields;if(0===e.length)r.push(n);else for(const t of e)r.push(n.child(t))}else r.push(n)}),new Hr(r)}class Ri{constructor(e,t,n,r,s,i){this.key=e,this.documentType=t,this.version=n,this.readTime=r,this.data=s,this.documentState=i}static newInvalidDocument(e){return new Ri(e,0,or.min(),or.min(),Ni.empty(),0)}static newFoundDocument(e,t,n){return new Ri(e,1,t,or.min(),n,0)}static newNoDocument(e,t){return new Ri(e,2,t,or.min(),Ni.empty(),0)}static newUnknownDocument(e,t){return new Ri(e,3,t,or.min(),Ni.empty(),2)}convertToFoundDocument(e,t){return this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=Ni.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=Ni.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=or.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof Ri&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new Ri(this.key,this.documentType,this.version,this.readTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class Li{constructor(e,t=null,n=[],r=[],s=null,i=null,o=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=s,this.startAt=i,this.endAt=o,this.ht=null}}function Mi(e,t=null,n=[],r=[],s=null,i=null,o=null){return new Li(e,t,n,r,s,i,o)}function Oi(e){const t=qs(e);if(null===t.ht){let e=t.path.canonicalString();null!==t.collectionGroup&&(e+="|cg:"+t.collectionGroup),e=(e=(e+="|f:")+t.filters.map(e=>{return(e=e).field.canonicalString()+e.op.toString()+pi(e.value)}).join(",")+"|ob:")+t.orderBy.map(e=>{return e.field.canonicalString()+e.dir}).join(","),oi(t.limit)||(e=(e+="|l:")+t.limit),t.startAt&&(e=(e=(e+="|lb:")+(t.startAt.inclusive?"b:":"a:"))+t.startAt.position.map(e=>pi(e)).join(",")),t.endAt&&(e=(e=(e+="|ub:")+(t.endAt.inclusive?"a:":"b:"))+t.endAt.position.map(e=>pi(e)).join(",")),t.ht=e}return t.ht}function Vi(t,n){if(t.limit!==n.limit)return!1;if(t.orderBy.length!==n.orderBy.length)return!1;for(let e=0;e<t.orderBy.length;e++)if(!Ji(t.orderBy[e],n.orderBy[e]))return!1;if(t.filters.length!==n.filters.length)return!1;for(let e=0;e<t.filters.length;e++)if(r=t.filters[e],s=n.filters[e],r.op!==s.op||!r.field.isEqual(s.field)||!di(r.value,s.value))return!1;var r,s;return t.collectionGroup===n.collectionGroup&&!!t.path.isEqual(n.path)&&!!to(t.startAt,n.startAt)&&to(t.endAt,n.endAt)}function Fi(e){return lr.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}function Pi(e,t){return e.filters.filter(e=>e instanceof qi&&e.field.isEqual(t))}function Bi(t,n,r){let s=hi,i=!0;for(const r of Pi(t,n)){let e=hi,t=!0;switch(r.op){case"<":case"<=":e=xi(r.value);break;case"==":case"in":case">=":e=r.value;break;case">":e=r.value,t=!1;break;case"!=":case"not-in":e=hi}Di({value:s,inclusive:i},{value:e,inclusive:t})<0&&(s=e,i=t)}if(null!==r)for(let e=0;e<t.orderBy.length;++e)if(t.orderBy[e].field.isEqual(n)){const t=r.position[e];Di({value:s,inclusive:i},{value:t,inclusive:r.inclusive})<0&&(s=t,i=r.inclusive);break}return{value:s,inclusive:i}}function Ui(t,n,r){let s=ci,i=!0;for(const r of Pi(t,n)){let e=ci,t=!0;switch(r.op){case">=":case">":e=Ai(r.value),t=!1;break;case"==":case"in":case"<=":e=r.value;break;case"<":e=r.value,t=!1;break;case"!=":case"not-in":e=ci}0<Ci({value:s,inclusive:i},{value:e,inclusive:t})&&(s=e,i=t)}if(null!==r)for(let e=0;e<t.orderBy.length;++e)if(t.orderBy[e].field.isEqual(n)){const t=r.position[e];0<Ci({value:s,inclusive:i},{value:t,inclusive:r.inclusive})&&(s=t,i=r.inclusive);break}return{value:s,inclusive:i}}class qi extends class{}{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.lt(e,t,n):new Gi(e,t,n):"array-contains"===t?new Qi(e,n):"in"===t?new zi(e,n):"not-in"===t?new Hi(e,n):"array-contains-any"===t?new Wi(e,n):new qi(e,t,n)}static lt(e,t,n){return new("in"===t?Ki:ji)(e,n)}matches(e){e=e.data.field(this.field);return"!="===this.op?null!==e&&this.ft(mi(e,this.value)):null!==e&&li(this.value)===li(e)&&this.ft(mi(e,this.value))}ft(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return 0<e;case">=":return 0<=e;default:return Ps()}}dt(){return 0<=["<","<=",">",">=","!=","not-in"].indexOf(this.op)}}class Gi extends qi{constructor(e,t,n){super(e,t,n),this.key=lr.fromName(n.referenceValue)}matches(e){e=lr.comparator(e.key,this.key);return this.ft(e)}}class Ki extends qi{constructor(e,t){super(e,"in",t),this.keys=$i("in",t)}matches(t){return this.keys.some(e=>e.isEqual(t.key))}}class ji extends qi{constructor(e,t){super(e,"not-in",t),this.keys=$i("not-in",t)}matches(t){return!this.keys.some(e=>e.isEqual(t.key))}}function $i(e,t){return((null==(t=t.arrayValue)?void 0:t.values)||[]).map(e=>lr.fromName(e.referenceValue))}class Qi extends qi{constructor(e,t){super(e,"array-contains",t)}matches(e){e=e.data.field(this.field);return Ii(e)&&fi(e.arrayValue,this.value)}}class zi extends qi{constructor(e,t){super(e,"in",t)}matches(e){e=e.data.field(this.field);return null!==e&&fi(this.value.arrayValue,e)}}class Hi extends qi{constructor(e,t){super(e,"not-in",t)}matches(e){if(fi(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;e=e.data.field(this.field);return null!==e&&!fi(this.value.arrayValue,e)}}class Wi extends qi{constructor(e,t){super(e,"array-contains-any",t)}matches(e){const t=e.data.field(this.field);return!(!Ii(t)||!t.arrayValue.values)&&t.arrayValue.values.some(e=>fi(this.value.arrayValue,e))}}class Yi{constructor(e,t){this.position=e,this.inclusive=t}}class Xi{constructor(e,t="asc"){this.field=e,this.dir=t}}function Ji(e,t){return e.dir===t.dir&&e.field.isEqual(t.field)}function Zi(t,n,r){let s=0;for(let e=0;e<t.position.length;e++){const i=n[e],o=t.position[e];if(s=i.field.isKeyField()?lr.comparator(lr.fromName(o.referenceValue),r.key):mi(o,r.data.field(i.field)),"desc"===i.dir&&(s*=-1),0!==s)break}return s}function to(t,n){if(null===t)return null===n;if(null===n)return!1;if(t.inclusive!==n.inclusive||t.position.length!==n.position.length)return!1;for(let e=0;e<t.position.length;e++)if(!di(t.position[e],n.position[e]))return!1;return!0}class eo{constructor(e,t=null,n=[],r=[],s=null,i="F",o=null,a=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=s,this.limitType=i,this.startAt=o,this.endAt=a,this._t=null,this.wt=null,this.startAt,this.endAt}}function no(e,t,n,r,s,i,o,a){return new eo(e,t,n,r,s,i,o,a)}function so(e){return new eo(e)}function ro(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function io(e){return 0<e.explicitOrderBy.length?e.explicitOrderBy[0].field:null}function oo(e){for(const t of e.filters)if(t.dt())return t.field;return null}function ao(e){return null!==e.collectionGroup}function uo(t){const n=qs(t);if(null===n._t){n._t=[];const t=oo(n),e=io(n);if(null!==t&&null===e)t.isKeyField()||n._t.push(new Xi(t)),n._t.push(new Xi(hr.keyField(),"asc"));else{let e=!1;for(const r of n.explicitOrderBy)n._t.push(r),r.field.isKeyField()&&(e=!0);if(!e){const t=0<n.explicitOrderBy.length?n.explicitOrderBy[n.explicitOrderBy.length-1].dir:"asc";n._t.push(new Xi(hr.keyField(),t))}}}return n._t}function co(e){const t=qs(e);if(!t.wt)if("F"===t.limitType)t.wt=Mi(t.path,t.collectionGroup,uo(t),t.filters,t.limit,t.startAt,t.endAt);else{const e=[];for(const s of uo(t)){const t="desc"===s.dir?"asc":"desc";e.push(new Xi(s.field,t))}var n=t.endAt?new Yi(t.endAt.position,t.endAt.inclusive):null,r=t.startAt?new Yi(t.startAt.position,t.startAt.inclusive):null;t.wt=Mi(t.path,t.collectionGroup,e,t.filters,t.limit,n,r)}return t.wt}function ho(e,t,n){return new eo(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function lo(e,t){return Vi(co(e),co(t))&&e.limitType===t.limitType}function fo(e){return Oi(co(e))+"|lt:"+e.limitType}function mo(e){return`Query(target=${function(e){let t=e.path.canonicalString();return null!==e.collectionGroup&&(t+=" collectionGroup="+e.collectionGroup),0<e.filters.length&&(t+=`, filters: [${e.filters.map(e=>{return`${(e=e).field.canonicalString()} ${e.op} `+pi(e.value)}).join(", ")}]`),oi(e.limit)||(t+=", limit: "+e.limit),0<e.orderBy.length&&(t+=`, orderBy: [${e.orderBy.map(e=>{return`${e.field.canonicalString()} (${e.dir})`}).join(", ")}]`),e.startAt&&(t=(t=(t+=", startAt: ")+(e.startAt.inclusive?"b:":"a:"))+e.startAt.position.map(e=>pi(e)).join(",")),`Target(${t=e.endAt?(t=(t+=", endAt: ")+(e.endAt.inclusive?"a:":"b:"))+e.endAt.position.map(e=>pi(e)).join(","):t})`}(co(e))}; limitType=${e.limitType})`}function go(n,e){return e.isFoundDocument()&&(s=n,o=(i=e).key.path,null!==s.collectionGroup?i.key.hasCollectionId(s.collectionGroup)&&s.path.isPrefixOf(o):lr.isDocumentKey(s.path)?s.path.isEqual(o):s.path.isImmediateParentOf(o))&&function(e){for(const t of n.explicitOrderBy)if(!t.field.isKeyField()&&null===e.data.field(t.field))return!1;return!0}(e)&&function(e){for(const t of n.filters)if(!t.matches(e))return!1;return!0}(e)&&(i=e,!((s=n).startAt&&(t=s.startAt,r=Zi(t,uo(s),i),!(t.inclusive?r<=0:r<0))||s.endAt&&(t=s.endAt,r=Zi(t,uo(s),i),!(t.inclusive?0<=r:0<r))));var t,r,s,i,o}function po(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}function yo(s){return(e,t)=>{let n=!1;for(const r of uo(s)){const s=wo(r,e,t);if(0!==s)return s;n=n||r.field.isKeyField()}return 0}}function wo(e,t,n){var r,s=e.field.isKeyField()?lr.comparator(t.key,n.key):(r=e.field,n=n,t=t.data.field(r),n=n.data.field(r),null!==t&&null!==n?mi(t,n):Ps());switch(e.dir){case"asc":return s;case"desc":return-1*s;default:return Ps()}}function vo(e,t){if(e.gt){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:ai(t)?"-0":t}}function Io(e){return{integerValue:""+e}}function bo(e,t){return ui(t)?Io(t):vo(e,t)}class Eo{constructor(){this._=void 0}}function To(e,t,n){if(e instanceof xo){const r={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:n.seconds,nanos:n.nanoseconds}}}};return t&&(r.fields.__previous_value__=t),{mapValue:r}}return e instanceof Ao?Do(e,t):e instanceof Co?No(e,t):(e=_o(n=e,t),t=Ro(e)+Ro(n.yt),vi(e)&&vi(n.yt)?Io(t):vo(n.It,t))}function So(e,t,n){return e instanceof Ao?Do(e,t):e instanceof Co?No(e,t):n}function _o(e,t){return e instanceof ko?vi(e=t)||e&&"doubleValue"in e?t:{integerValue:0}:null}class xo extends Eo{}class Ao extends Eo{constructor(e){super(),this.elements=e}}function Do(e,t){const n=Lo(t);for(const t of e.elements)n.some(e=>di(e,t))||n.push(t);return{arrayValue:{values:n}}}class Co extends Eo{constructor(e){super(),this.elements=e}}function No(e,t){let n=Lo(t);for(const t of e.elements)n=n.filter(e=>!di(e,t));return{arrayValue:{values:n}}}class ko extends Eo{constructor(e,t){super(),this.It=e,this.yt=t}}function Ro(e){return Zr(e.integerValue||e.doubleValue)}function Lo(e){return Ii(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class Mo{constructor(e,t){this.field=e,this.transform=t}}class Oo{constructor(e,t){this.version=e,this.transformResults=t}}class Vo{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new Vo}static exists(e){return new Vo(void 0,e)}static updateTime(e){return new Vo(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function Fo(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class Po{}function Bo(e,n){if(!e.hasLocalMutations||n&&0===n.fields.length)return null;if(null===n)return e.isNoDocument()?new Wo(e.key,Vo.none()):new jo(e.key,e.data,Vo.none());{const s=e.data,i=Ni.empty();let t=new $r(hr.comparator);for(var r of n.fields)if(!t.has(r)){let e=s.field(r);null===e&&1<r.length&&(r=r.popLast(),e=s.field(r)),null===e?i.delete(r):i.set(r,e),t=t.add(r)}return new $o(e.key,i,new Hr(t.toArray()),Vo.none())}}function Uo(e,t,n){if(e instanceof jo){var r=e,s=t,i=n;const o=r.value.clone(),a=zo(r.fieldTransforms,s,i.transformResults);o.setAll(a),s.convertToFoundDocument(i.version,o).setHasCommittedMutations()}else if(e instanceof $o){r=e,s=t,i=n;if(Fo(r.precondition,s)){const u=zo(r.fieldTransforms,s,i.transformResults),c=s.data;c.setAll(Qo(r)),c.setAll(u),s.convertToFoundDocument(i.version,c).setHasCommittedMutations()}else s.convertToUnknownDocument(i.version)}else t.convertToNoDocument(n.version).setHasCommittedMutations()}function qo(e,t,n,r){if(e instanceof jo){var s=e,i=t,o=n,a=r;if(!Fo(s.precondition,i))return o;const u=s.value.clone(),c=Ho(s.fieldTransforms,a,i);return u.setAll(c),i.convertToFoundDocument(i.version,u).setHasLocalMutations(),null}if(e instanceof $o){o=e,s=t,a=n,i=r;if(!Fo(o.precondition,s))return a;const h=Ho(o.fieldTransforms,i,s),l=s.data;return l.setAll(Qo(o)),l.setAll(h),s.convertToFoundDocument(s.version,l).setHasLocalMutations(),null===a?null:a.unionWith(o.fieldMask.fields).unionWith(o.fieldTransforms.map(e=>e.field))}return r=t,t=n,Fo(e.precondition,r)?(r.convertToNoDocument(r.version).setHasLocalMutations(),null):t}function Go(e,t){let n=null;for(const r of e.fieldTransforms){const e=t.data.field(r.field),s=_o(r.transform,e||null);null!=s&&(n=null===n?Ni.empty():n).set(r.field,s)}return n||null}function Ko(e,t){return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&(n=e.fieldTransforms,r=t.fieldTransforms,!!(void 0===n&&void 0===r||n&&r&&sr(n,r,(e,t)=>{return e.field.isEqual(t.field)&&(e=e.transform,t=t.transform,e instanceof Ao&&t instanceof Ao||e instanceof Co&&t instanceof Co?sr(e.elements,t.elements,di):e instanceof ko&&t instanceof ko?di(e.yt,t.yt):e instanceof xo&&t instanceof xo)})))&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask));var n,r}class jo extends Po{constructor(e,t,n,r=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class $o extends Po{constructor(e,t,n,r,s=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=r,this.fieldTransforms=s,this.type=1}getFieldMask(){return this.fieldMask}}function Qo(n){const r=new Map;return n.fieldMask.fields.forEach(e=>{var t;e.isEmpty()||(t=n.data.field(e),r.set(e,t))}),r}function zo(t,n,r){const s=new Map;Bs(t.length===r.length);for(let e=0;e<r.length;e++){var i=t[e],o=i.transform,a=n.data.field(i.field);s.set(i.field,So(o,a,r[e]))}return s}function Ho(e,t,n){const r=new Map;for(const s of e){const e=s.transform,i=n.data.field(s.field);r.set(s.field,To(e,i,t))}return r}class Wo extends Po{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class Yo extends Po{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class Xo{constructor(e){this.count=e}}function ta(e){switch(e){default:return Ps();case Gs.CANCELLED:case Gs.UNKNOWN:case Gs.DEADLINE_EXCEEDED:case Gs.RESOURCE_EXHAUSTED:case Gs.INTERNAL:case Gs.UNAVAILABLE:case Gs.UNAUTHENTICATED:return!1;case Gs.INVALID_ARGUMENT:case Gs.NOT_FOUND:case Gs.ALREADY_EXISTS:case Gs.PERMISSION_DENIED:case Gs.FAILED_PRECONDITION:case Gs.ABORTED:case Gs.OUT_OF_RANGE:case Gs.UNIMPLEMENTED:case Gs.DATA_LOSS:return!0}}function ea(e){if(void 0===e)return Os("GRPC error has no .code"),Gs.UNKNOWN;switch(e){case Jo.OK:return Gs.OK;case Jo.CANCELLED:return Gs.CANCELLED;case Jo.UNKNOWN:return Gs.UNKNOWN;case Jo.DEADLINE_EXCEEDED:return Gs.DEADLINE_EXCEEDED;case Jo.RESOURCE_EXHAUSTED:return Gs.RESOURCE_EXHAUSTED;case Jo.INTERNAL:return Gs.INTERNAL;case Jo.UNAVAILABLE:return Gs.UNAVAILABLE;case Jo.UNAUTHENTICATED:return Gs.UNAUTHENTICATED;case Jo.INVALID_ARGUMENT:return Gs.INVALID_ARGUMENT;case Jo.NOT_FOUND:return Gs.NOT_FOUND;case Jo.ALREADY_EXISTS:return Gs.ALREADY_EXISTS;case Jo.PERMISSION_DENIED:return Gs.PERMISSION_DENIED;case Jo.FAILED_PRECONDITION:return Gs.FAILED_PRECONDITION;case Jo.ABORTED:return Gs.ABORTED;case Jo.OUT_OF_RANGE:return Gs.OUT_OF_RANGE;case Jo.UNIMPLEMENTED:return Gs.UNIMPLEMENTED;case Jo.DATA_LOSS:return Gs.DATA_LOSS;default:return Ps()}}(Zo=Jo=Jo||{})[Zo.OK=0]="OK",Zo[Zo.CANCELLED=1]="CANCELLED",Zo[Zo.UNKNOWN=2]="UNKNOWN",Zo[Zo.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",Zo[Zo.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",Zo[Zo.NOT_FOUND=5]="NOT_FOUND",Zo[Zo.ALREADY_EXISTS=6]="ALREADY_EXISTS",Zo[Zo.PERMISSION_DENIED=7]="PERMISSION_DENIED",Zo[Zo.UNAUTHENTICATED=16]="UNAUTHENTICATED",Zo[Zo.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",Zo[Zo.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",Zo[Zo.ABORTED=10]="ABORTED",Zo[Zo.OUT_OF_RANGE=11]="OUT_OF_RANGE",Zo[Zo.UNIMPLEMENTED=12]="UNIMPLEMENTED",Zo[Zo.INTERNAL=13]="INTERNAL",Zo[Zo.UNAVAILABLE=14]="UNAVAILABLE",Zo[Zo.DATA_LOSS=15]="DATA_LOSS";class na{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n)for(const[t,r]of n)if(this.equalsFn(t,e))return r}has(e){return void 0!==this.get(e)}set(t,n){const e=this.mapKeyFn(t),r=this.inner[e];if(void 0===r)return this.inner[e]=[[t,n]],void this.innerSize++;for(let e=0;e<r.length;e++)if(this.equalsFn(r[e][0],t))return void(r[e]=[t,n]);r.push([t,n]),this.innerSize++}delete(t){const n=this.mapKeyFn(t),r=this.inner[n];if(void 0===r)return!1;for(let e=0;e<r.length;e++)if(this.equalsFn(r[e][0],t))return 1===r.length?delete this.inner[n]:r.splice(e,1),this.innerSize--,!0;return!1}forEach(r){Ur(this.inner,(e,t)=>{for(const[e,n]of t)r(e,n)})}isEmpty(){return qr(this.inner)}size(){return this.innerSize}}const sa=new Gr(lr.comparator);function ra(){return sa}const ia=new Gr(lr.comparator);function oa(...e){let t=ia;for(const n of e)t=t.insert(n.key,n);return t}function aa(e){let n=ia;return e.forEach((e,t)=>n=n.insert(e,t.overlayedDocument)),n}function ua(){return ha()}function ca(){return ha()}function ha(){return new na(e=>e.toString(),(e,t)=>e.isEqual(t))}const la=new Gr(lr.comparator),da=new $r(lr.comparator);function fa(...e){let t=da;for(const n of e)t=t.add(n);return t}const ma=new $r(nr);function ga(){return ma}class pa{constructor(e,t,n,r,s){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(e,t,n){const r=new Map;return r.set(e,ya.createSynthesizedTargetChangeForCurrentChange(e,t,n)),new pa(or.min(),r,ga(),ra(),fa())}}class ya{constructor(e,t,n,r,s){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(e,t,n){return new ya(n,t,fa(),fa(),fa())}}class wa{constructor(e,t,n,r){this.Tt=e,this.removedTargetIds=t,this.key=n,this.Et=r}}class va{constructor(e,t){this.targetId=e,this.At=t}}class Ia{constructor(e,t,n=Yr.EMPTY_BYTE_STRING,r=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}}class ba{constructor(){this.Rt=0,this.bt=Sa(),this.Pt=Yr.EMPTY_BYTE_STRING,this.vt=!1,this.Vt=!0}get current(){return this.vt}get resumeToken(){return this.Pt}get St(){return 0!==this.Rt}get Dt(){return this.Vt}Ct(e){0<e.approximateByteSize()&&(this.Vt=!0,this.Pt=e)}xt(){let n=fa(),r=fa(),s=fa();return this.bt.forEach((e,t)=>{switch(t){case 0:n=n.add(e);break;case 2:r=r.add(e);break;case 1:s=s.add(e);break;default:Ps()}}),new ya(this.Pt,this.vt,n,r,s)}Nt(){this.Vt=!1,this.bt=Sa()}kt(e,t){this.Vt=!0,this.bt=this.bt.insert(e,t)}Ot(e){this.Vt=!0,this.bt=this.bt.remove(e)}Mt(){this.Rt+=1}Ft(){--this.Rt}$t(){this.Vt=!0,this.vt=!0}}class Ea{constructor(e){this.Bt=e,this.Lt=new Map,this.Ut=ra(),this.qt=Ta(),this.Kt=new $r(nr)}Gt(e){for(const t of e.Tt)e.Et&&e.Et.isFoundDocument()?this.Qt(t,e.Et):this.jt(t,e.key,e.Et);for(const n of e.removedTargetIds)this.jt(n,e.key,e.Et)}Wt(n){this.forEachTarget(n,e=>{const t=this.zt(e);switch(n.state){case 0:this.Ht(e)&&t.Ct(n.resumeToken);break;case 1:t.Ft(),t.St||t.Nt(),t.Ct(n.resumeToken);break;case 2:t.Ft(),t.St||this.removeTarget(e);break;case 3:this.Ht(e)&&(t.$t(),t.Ct(n.resumeToken));break;case 4:this.Ht(e)&&(this.Jt(e),t.Ct(n.resumeToken));break;default:Ps()}})}forEachTarget(e,n){0<e.targetIds.length?e.targetIds.forEach(n):this.Lt.forEach((e,t)=>{this.Ht(t)&&n(t)})}Yt(e){const t=e.targetId,n=e.At.count,r=this.Xt(t);if(r){const e=r.target;if(Fi(e))if(0===n){const n=new lr(e.path);this.jt(t,n,Ri.newNoDocument(n,or.min()))}else Bs(1===n);else this.Zt(t)!==n&&(this.Jt(t),this.Kt=this.Kt.add(t))}}te(r){const s=new Map;this.Lt.forEach((e,t)=>{var n=this.Xt(t);if(n){if(e.current&&Fi(n.target)){const s=new lr(n.target.path);null!==this.Ut.get(s)||this.ee(t,s)||this.jt(t,s,Ri.newNoDocument(s,r))}e.Dt&&(s.set(t,e.xt()),e.Nt())}});let i=fa();this.qt.forEach((e,t)=>{let n=!0;t.forEachWhile(e=>{e=this.Xt(e);return!e||2===e.purpose||(n=!1)}),n&&(i=i.add(e))}),this.Ut.forEach((e,t)=>t.setReadTime(r));var e=new pa(r,s,this.Kt,this.Ut,i);return this.Ut=ra(),this.qt=Ta(),this.Kt=new $r(nr),e}Qt(e,t){var n;this.Ht(e)&&(n=this.ee(e,t.key)?2:0,this.zt(e).kt(t.key,n),this.Ut=this.Ut.insert(t.key,t),this.qt=this.qt.insert(t.key,this.ne(t.key).add(e)))}jt(e,t,n){if(this.Ht(e)){const r=this.zt(e);this.ee(e,t)?r.kt(t,1):r.Ot(t),this.qt=this.qt.insert(t,this.ne(t).delete(e)),n&&(this.Ut=this.Ut.insert(t,n))}}removeTarget(e){this.Lt.delete(e)}Zt(e){var t=this.zt(e).xt();return this.Bt.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}Mt(e){this.zt(e).Mt()}zt(e){let t=this.Lt.get(e);return t||(t=new ba,this.Lt.set(e,t)),t}ne(e){let t=this.qt.get(e);return t||(t=new $r(nr),this.qt=this.qt.insert(e,t)),t}Ht(e){var t=null!==this.Xt(e);return t||Ms("WatchChangeAggregator","Detected inactive target",e),t}Xt(e){var t=this.Lt.get(e);return t&&t.St?null:this.Bt.se(e)}Jt(t){this.Lt.set(t,new ba),this.Bt.getRemoteKeysForTarget(t).forEach(e=>{this.jt(t,e,null)})}ee(e,t){return this.Bt.getRemoteKeysForTarget(e).has(t)}}function Ta(){return new Gr(lr.comparator)}function Sa(){return new Gr(lr.comparator)}const _a={asc:"ASCENDING",desc:"DESCENDING"},xa={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"};class Aa{constructor(e,t){this.databaseId=e,this.gt=t}}function Da(e,t){return e.gt?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function Ca(e,t){return e.gt?t.toBase64():t.toUint8Array()}function Na(e,t){return Da(e,t.toTimestamp())}function ka(e){return Bs(!!e),or.fromTimestamp((e=Jr(e),new ir(e.seconds,e.nanos)))}function Ra(e,t){return e=e,new ur(["projects",e.projectId,"databases",e.database]).child("documents").child(t).canonicalString()}function La(e){e=ur.fromString(e);return Bs(eu(e)),e}function Ma(e,t){return Ra(e.databaseId,t.path)}function Oa(e,t){const n=La(t);if(n.get(1)!==e.databaseId.projectId)throw new Ks(Gs.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new Ks(Gs.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new lr(Ba(n))}function Va(e,t){return Ra(e.databaseId,t)}function Fa(e){e=La(e);return 4===e.length?ur.emptyPath():Ba(e)}function Pa(e){return new ur(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function Ba(e){return Bs(4<e.length&&"documents"===e.get(4)),e.popFirst(5)}function Ua(e,t,n){return{name:Ma(e,t),fields:n.value.mapValue.fields}}function qa(e,t,n){const r=Oa(e,t.name),s=ka(t.updateTime),i=new Ni({mapValue:{fields:t.fields}}),o=Ri.newFoundDocument(r,s,i);return n&&o.setHasCommittedMutations(),n?o.setHasCommittedMutations():o}function Ga(e,t){let n;if(t instanceof jo)n={update:Ua(e,t.key,t.value)};else if(t instanceof Wo)n={delete:Ma(e,t.key)};else if(t instanceof $o)n={update:Ua(e,t.key,t.data),updateMask:tu(t.fieldMask)};else{if(!(t instanceof Yo))return Ps();n={verify:Ma(e,t.key)}}return 0<t.fieldTransforms.length&&(n.updateTransforms=t.fieldTransforms.map(e=>{var t=e.transform;if(t instanceof xo)return{fieldPath:e.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(t instanceof Ao)return{fieldPath:e.field.canonicalString(),appendMissingElements:{values:t.elements}};if(t instanceof Co)return{fieldPath:e.field.canonicalString(),removeAllFromArray:{values:t.elements}};if(t instanceof ko)return{fieldPath:e.field.canonicalString(),increment:t.yt};throw Ps()})),t.precondition.isNone||(n.currentDocument=void 0!==(t=t.precondition).updateTime?{updateTime:Na(e,t.updateTime)}:void 0!==t.exists?{exists:t.exists}:Ps()),n}function Ka(r,t){const e=t.currentDocument?void 0!==(s=t.currentDocument).updateTime?Vo.updateTime(ka(s.updateTime)):void 0!==s.exists?Vo.exists(s.exists):Vo.none():Vo.none(),n=t.updateTransforms?t.updateTransforms.map(t=>{{var n=r;let e=null;if("setToServerValue"in t)Bs("REQUEST_TIME"===t.setToServerValue),e=new xo;else if("appendMissingElements"in t){const n=t.appendMissingElements.values||[];e=new Ao(n)}else if("removeAllFromArray"in t){const n=t.removeAllFromArray.values||[];e=new Co(n)}else"increment"in t?e=new ko(n,t.increment):Ps();return n=hr.fromServerFormat(t.fieldPath),new Mo(n,e)}}):[];if(t.update){t.update.name;var s=Oa(r,t.update.name),i=new Ni({mapValue:{fields:t.update.fields}});if(t.updateMask){const r=function(){const e=t.updateMask.fieldPaths||[];return new Hr(e.map(e=>hr.fromServerFormat(e)))}();return new $o(s,i,r,e,n)}return new jo(s,i,e,n)}if(t.delete){const n=Oa(r,t.delete);return new Wo(n,e)}if(t.verify){const n=Oa(r,t.verify);return new Yo(n,e)}return Ps()}function ja(e,t){return{documents:[Va(e,t.path)]}}function $a(e,t){const n={structuredQuery:{}},r=t.path;null!==t.collectionGroup?(n.parent=Va(e,r),n.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(n.parent=Va(e,r.popLast()),n.structuredQuery.from=[{collectionId:r.lastSegment()}]);var s=function(e){if(0!==e.length)return e=e.map(e=>{if("=="===e.op){if(Ei(e.value))return{unaryFilter:{field:Ya(e.field),op:"IS_NAN"}};if(bi(e.value))return{unaryFilter:{field:Ya(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(Ei(e.value))return{unaryFilter:{field:Ya(e.field),op:"IS_NOT_NAN"}};if(bi(e.value))return{unaryFilter:{field:Ya(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:Ya(e.field),op:Wa(e.op),value:e.value}}}),1===e.length?e[0]:{compositeFilter:{op:"AND",filters:e}}}(t.filters),s=(s&&(n.structuredQuery.where=s),function(e){if(0!==e.length)return e.map(e=>{return{field:Ya(e.field),direction:Ha(e.dir)}})}(t.orderBy)),e=(s&&(n.structuredQuery.orderBy=s),s=t.limit,e.gt||oi(s)?s:{value:s});return null!==e&&(n.structuredQuery.limit=e),t.startAt&&(n.structuredQuery.startAt={before:(s=t.startAt).inclusive,values:s.position}),t.endAt&&(n.structuredQuery.endAt={before:!(e=t.endAt).inclusive,values:e.position}),n}function Qa(e){let t=Fa(e.parent);const n=e.structuredQuery,r=n.from?n.from.length:0;let s=null;if(0<r){Bs(1===r);const e=n.from[0];e.allDescendants?s=e.collectionId:t=t.child(e.collectionId)}let i=[],o=(n.where&&(i=za(n.where)),[]),a=(n.orderBy&&(o=n.orderBy.map(e=>{var t=e;return new Xi(Xa(t.field),function(){switch(t.direction){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}())})),null),u=(n.limit&&(a=function(e){e="object"==typeof e?e.value:e;return oi(e)?null:e}(n.limit)),null);var c;n.startAt&&(u=(e=n.startAt,c=!!e.before,e=e.values||[],new Yi(e,c)));let h=null;return n.endAt&&(h=(e=n.endAt,c=!e.before,e=e.values||[],new Yi(e,c))),no(t,s,o,i,a,"F",u,h)}function za(e){return e?void 0!==e.unaryFilter?[Za(e)]:void 0!==e.fieldFilter?[Ja(e)]:void 0!==e.compositeFilter?e.compositeFilter.filters.map(e=>za(e)).reduce((e,t)=>e.concat(t)):Ps():[]}function Ha(e){return _a[e]}function Wa(e){return xa[e]}function Ya(e){return{fieldPath:e.canonicalString()}}function Xa(e){return hr.fromServerFormat(e.fieldPath)}function Ja(e){return qi.create(Xa(e.fieldFilter.field),function(){switch(e.fieldFilter.op){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return Ps()}}(),e.fieldFilter.value)}function Za(e){switch(e.unaryFilter.op){case"IS_NAN":var t=Xa(e.unaryFilter.field);return qi.create(t,"==",{doubleValue:NaN});case"IS_NULL":t=Xa(e.unaryFilter.field);return qi.create(t,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":t=Xa(e.unaryFilter.field);return qi.create(t,"!=",{doubleValue:NaN});case"IS_NOT_NULL":t=Xa(e.unaryFilter.field);return qi.create(t,"!=",{nullValue:"NULL_VALUE"});default:return Ps()}}function tu(e){const t=[];return e.fields.forEach(e=>t.push(e.canonicalString())),{fieldPaths:t}}function eu(e){return 4<=e.length&&"projects"===e.get(0)&&"databases"===e.get(2)}function nu(t){let n="";for(let e=0;e<t.length;e++)0<n.length&&(n=ru(n)),n=su(t.get(e),n);return ru(n)}function su(t,e){let n=e;const r=t.length;for(let e=0;e<r;e++){const r=t.charAt(e);switch(r){case"\0":n+="";break;case"":n+="";break;default:n+=r}}return n}function ru(e){return e+""}function iu(n){const r=n.length;if(Bs(2<=r),2===r)return Bs(""===n.charAt(0)&&""===n.charAt(1)),ur.emptyPath();r;const s=[];let i="";for(let t=0;t<r;){const r=n.indexOf("",t);switch((r<0||r>o)&&Ps(),n.charAt(r+1)){case"":const o=n.substring(t,r);let e;0===i.length?e=o:(i+=o,e=i,i=""),s.push(e);break;case"":i=i+n.substring(t,r)+"\0";break;case"":i+=n.substring(t,r+1);break;default:Ps()}t=r+2}return new ur(s)}const ou=["userId","batchId"];function au(e,t){return[e,nu(t)]}function uu(e,t,n){return[e,nu(t),n]}const cu={},hu=["prefixPath","collectionGroup","readTime","documentId"],lu=["prefixPath","collectionGroup","documentId"],du=["collectionGroup","readTime","prefixPath","documentId"],fu=["canonicalId","targetId"],mu=["targetId","path"],gu=["path","targetId"],pu=["collectionId","parent"],yu=["indexId","uid"],wu=["uid","sequenceNumber"],vu=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],Iu=["indexId","uid","orderedDocumentKey"],bu=["userId","collectionPath","documentId"],Eu=["userId","collectionPath","largestBatchId"],Tu=["userId","collectionGroup","largestBatchId"],Su=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],_u=[...Su,"documentOverlays"],xu=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],Au=xu,Du=[...Au,"indexConfiguration","indexState","indexEntries"];class Cu extends Sr{constructor(e,t){super(),this.ie=e,this.currentSequenceNumber=t}}function Nu(e,t){e=qs(e);return Dr.M(e.ie,t)}class ku{constructor(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(t,e){var n=e.mutationResults;for(let e=0;e<this.mutations.length;e++){const r=this.mutations[e];r.key.isEqual(t.key)&&Uo(r,t,n[e])}}applyToLocalView(e,t){for(const n of this.baseMutations)n.key.isEqual(e.key)&&(t=qo(n,e,t,this.localWriteTime));for(const r of this.mutations)r.key.isEqual(e.key)&&(t=qo(r,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(i,o){const a=ca();return this.mutations.forEach(e=>{const t=i.get(e.key),n=t.overlayedDocument;let r=this.applyToLocalView(n,t.mutatedFields);r=o.has(e.key)?null:r;var s=Bo(n,r);null!==s&&a.set(e.key,s),n.isValidDocument()||n.convertToNoDocument(or.min())}),a}keys(){return this.mutations.reduce((e,t)=>e.add(t.key),fa())}isEqual(e){return this.batchId===e.batchId&&sr(this.mutations,e.mutations,(e,t)=>Ko(e,t))&&sr(this.baseMutations,e.baseMutations,(e,t)=>Ko(e,t))}}class Ru{constructor(e,t,n,r){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=r}static from(e,t,n){Bs(e.mutations.length===n.length);let r=la;var s=e.mutations;for(let e=0;e<s.length;e++)r=r.insert(s[e].key,n[e].version);return new Ru(e,t,n,r)}}class Lu{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{
      largestBatchId: ${this.largestBatchId},
      mutation: ${this.mutation.toString()}
    }`}}class Mu{constructor(e,t,n,r,s=or.min(),i=or.min(),o=Yr.EMPTY_BYTE_STRING){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=i,this.resumeToken=o}withSequenceNumber(e){return new Mu(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken)}withResumeToken(e,t){return new Mu(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e)}withLastLimboFreeSnapshotVersion(e){return new Mu(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken)}}class Ou{constructor(e){this.re=e}}function Vu(e,t){const n=t.key,r={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:Fu(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument())r.document={name:Ma(e=e.re,(s=t).key),fields:s.data.value.mapValue.fields,updateTime:Da(e,s.version.toTimestamp())};else if(t.isNoDocument())r.noDocument={path:n.path.toArray(),readTime:Pu(t.version)};else{if(!t.isUnknownDocument())return Ps();r.unknownDocument={path:n.path.toArray(),version:Pu(t.version)}}var s;return r}function Fu(e){e=e.toTimestamp();return[e.seconds,e.nanoseconds]}function Pu(e){e=e.toTimestamp();return{seconds:e.seconds,nanoseconds:e.nanoseconds}}function Bu(e){e=new ir(e.seconds,e.nanoseconds);return or.fromTimestamp(e)}function Uu(t,n){const r=(n.baseMutations||[]).map(e=>Ka(t.re,e));for(let e=0;e<n.mutations.length-1;++e){const r=n.mutations[e];if(e+1<n.mutations.length&&void 0!==n.mutations[e+1].transform){const s=n.mutations[e+1];r.updateTransforms=s.transform.fieldTransforms,n.mutations.splice(e+1,1),++e}}const s=n.mutations.map(e=>Ka(t.re,e)),e=ir.fromMillis(n.localWriteTimeMs);return new ku(n.batchId,e,r,s)}function qu(e){var t,n=Bu(e.readTime),r=void 0!==e.lastLimboFreeSnapshotVersion?Bu(e.lastLimboFreeSnapshotVersion):or.min();let s;return s=void 0!==e.query.documents?(Bs(1===(t=e.query).documents.length),co(so(Fa(t.documents[0])))):co(Qa(e.query)),new Mu(s,e.targetId,0,e.lastListenSequenceNumber,n,r,Yr.fromBase64String(e.resumeToken))}function Gu(e,t){var n=Pu(t.snapshotVersion),r=Pu(t.lastLimboFreeSnapshotVersion),e=(Fi(t.target)?ja:$a)(e.re,t.target),s=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:Oi(t.target),readTime:n,resumeToken:s,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:r,query:e}}function Ku(e){var t=Qa({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?ho(t,t.limit,"L"):t}function ju(e,t){return new Lu(t.largestBatchId,Ka(e.re,t.overlayMutation))}function $u(e,t){var n=t.path.lastSegment();return[e,nu(t.path.popLast()),n]}function Qu(e,t,n,r){return{indexId:e,uid:t.uid||"",sequenceNumber:n,readTime:Pu(r.readTime),documentKey:nu(r.documentKey.path),largestBatchId:r.largestBatchId}}class zu{getBundleMetadata(e,t){return Hu(e).get(t).next(e=>{if(e)return{id:(e=e).bundleId,createTime:Bu(e.createTime),version:e.version}})}saveBundleMetadata(e,t){return Hu(e).put({bundleId:(e=t).id,createTime:Pu(ka(e.createTime)),version:e.version})}getNamedQuery(e,t){return Wu(e).get(t).next(e=>{if(e)return{name:(e=e).name,query:Ku(e.bundledQuery),readTime:Bu(e.readTime)}})}saveNamedQuery(e,t){return Wu(e).put({name:(e=t).name,readTime:Pu(ka(e.readTime)),bundledQuery:e.bundledQuery})}}function Hu(e){return Nu(e,"bundles")}function Wu(e){return Nu(e,"namedQueries")}class Yu{constructor(e,t){this.It=e,this.userId=t}static oe(e,t){t=t.uid||"";return new Yu(e,t)}getOverlay(e,t){return Xu(e).get($u(this.userId,t)).next(e=>e?ju(this.It,e):null)}getOverlays(e,t){const n=ua();return xr.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(n,r,e){const s=[];return e.forEach((e,t)=>{t=new Lu(r,t);s.push(this.ue(n,t))}),xr.waitFor(s)}removeOverlaysForBatchId(t,e,n){const r=new Set,s=(e.forEach(e=>r.add(nu(e.getCollectionPath()))),[]);return r.forEach(e=>{e=IDBKeyRange.bound([this.userId,e,n],[this.userId,e,n+1],!1,!0);s.push(Xu(t).Y("collectionPathOverlayIndex",e))}),xr.waitFor(s)}getOverlaysForCollection(e,t,n){const r=ua(),s=nu(t),i=IDBKeyRange.bound([this.userId,s,n],[this.userId,s,Number.POSITIVE_INFINITY],!0);return Xu(e).W("collectionPathOverlayIndex",i).next(e=>{for(const t of e){const e=ju(this.It,t);r.set(e.getKey(),e)}return r})}getOverlaysForCollectionGroup(e,t,n,s){const i=ua();let o;n=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,Number.POSITIVE_INFINITY],!0);return Xu(e).Z({index:"collectionGroupOverlayIndex",range:n},(e,t,n)=>{const r=ju(this.It,t);i.size()<s||r.largestBatchId===o?(i.set(r.getKey(),r),o=r.largestBatchId):n.done()}).next(()=>i)}ue(e,t){return Xu(e).put(function(e,t,n){var[,r,s]=$u(t,n.mutation.key);return{userId:t,collectionPath:r,documentId:s,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:Ga(e.re,n.mutation)}}(this.It,this.userId,t))}}function Xu(e){return Nu(e,"documentOverlays")}class Ju{constructor(){}ce(e,t){this.ae(e,t),t.he()}ae(e,t){var n;"nullValue"in e?this.le(t,5):"booleanValue"in e?(this.le(t,10),t.fe(e.booleanValue?1:0)):"integerValue"in e?(this.le(t,15),t.fe(Zr(e.integerValue))):"doubleValue"in e?(n=Zr(e.doubleValue),isNaN(n)?this.le(t,13):(this.le(t,15),ai(n)?t.fe(0):t.fe(n))):"timestampValue"in e?(n=e.timestampValue,this.le(t,20),"string"==typeof n?t.de(n):(t.de(""+(n.seconds||"")),t.fe(n.nanos||0))):"stringValue"in e?(this._e(e.stringValue,t),this.we(t)):"bytesValue"in e?(this.le(t,30),t.me(ti(e.bytesValue)),this.we(t)):"referenceValue"in e?this.ge(e.referenceValue,t):"geoPointValue"in e?(n=e.geoPointValue,this.le(t,45),t.fe(n.latitude||0),t.fe(n.longitude||0)):"mapValue"in e?_i(e)?this.le(t,Number.MAX_SAFE_INTEGER):(this.ye(e.mapValue,t),this.we(t)):"arrayValue"in e?(this.pe(e.arrayValue,t),this.we(t)):Ps()}_e(e,t){this.le(t,25),this.Ie(e,t)}Ie(e,t){t.de(e)}ye(e,t){var n=e.fields||{};this.le(t,55);for(const e of Object.keys(n))this._e(e,t),this.ae(n[e],t)}pe(e,t){var n=e.values||[];this.le(t,50);for(const e of n)this.ae(e,t)}ge(e,t){this.le(t,37),lr.fromName(e).path.forEach(e=>{this.le(t,60),this.Ie(e,t)})}le(e,t){e.fe(t)}we(e){e.fe(2)}}function Zu(e){if(0===e)return 8;let t=0;return e>>4==0&&(t+=4,e<<=4),e>>6==0&&(t+=2,e<<=2),e>>7==0&&(t+=1),t}function tc(e){e=64-function(t){let n=0;for(let e=0;e<8;++e){var r=Zu(255&t[e]);if(n+=r,8!==r)break}return n}(e);return Math.ceil(e/8)}Ju.Te=new Ju;class ec{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Ee(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Ae(n.value),n=t.next();this.Re()}be(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Pe(n.value),n=t.next();this.ve()}Ve(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Ae(e);else if(e<2048)this.Ae(960|e>>>6),this.Ae(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Ae(480|e>>>12),this.Ae(128|63&e>>>6),this.Ae(128|63&e);else{const e=t.codePointAt(0);this.Ae(240|e>>>18),this.Ae(128|63&e>>>12),this.Ae(128|63&e>>>6),this.Ae(128|63&e)}}this.Re()}Se(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Pe(e);else if(e<2048)this.Pe(960|e>>>6),this.Pe(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Pe(480|e>>>12),this.Pe(128|63&e>>>6),this.Pe(128|63&e);else{const e=t.codePointAt(0);this.Pe(240|e>>>18),this.Pe(128|63&e>>>12),this.Pe(128|63&e>>>6),this.Pe(128|63&e)}}this.ve()}De(t){var n=this.Ce(t),t=tc(n);this.xe(1+t),this.buffer[this.position++]=255&t;for(let e=n.length-t;e<n.length;++e)this.buffer[this.position++]=255&n[e]}Ne(t){var n=this.Ce(t),t=tc(n);this.xe(1+t),this.buffer[this.position++]=~(255&t);for(let e=n.length-t;e<n.length;++e)this.buffer[this.position++]=~(255&n[e])}ke(){this.Oe(255),this.Oe(255)}Me(){this.Fe(255),this.Fe(255)}reset(){this.position=0}seed(e){this.xe(e.length),this.buffer.set(e,this.position),this.position+=e.length}$e(){return this.buffer.slice(0,this.position)}Ce(e){const t=function(e){const t=new DataView(new ArrayBuffer(8));return t.setFloat64(0,e,!1),new Uint8Array(t.buffer)}(e),n=0!=(128&t[0]);t[0]^=n?255:128;for(let e=1;e<t.length;++e)t[e]^=n?255:0;return t}Ae(e){e&=255;0==e?(this.Oe(0),this.Oe(255)):255==e?(this.Oe(255),this.Oe(0)):this.Oe(e)}Pe(e){var t=255&e;0==t?(this.Fe(0),this.Fe(255)):255==t?(this.Fe(255),this.Fe(0)):this.Fe(e)}Re(){this.Oe(0),this.Oe(1)}ve(){this.Fe(0),this.Fe(1)}Oe(e){this.xe(1),this.buffer[this.position++]=e}Fe(e){this.xe(1),this.buffer[this.position++]=~e}xe(t){t+=this.position;if(!(t<=this.buffer.length)){let e=2*this.buffer.length;e<t&&(e=t);const n=new Uint8Array(e);n.set(this.buffer),this.buffer=n}}}class nc{constructor(e){this.Be=e}me(e){this.Be.Ee(e)}de(e){this.Be.Ve(e)}fe(e){this.Be.De(e)}he(){this.Be.ke()}}class sc{constructor(e){this.Be=e}me(e){this.Be.be(e)}de(e){this.Be.Se(e)}fe(e){this.Be.Ne(e)}he(){this.Be.Me()}}class rc{constructor(){this.Be=new ec,this.Le=new nc(this.Be),this.Ue=new sc(this.Be)}seed(e){this.Be.seed(e)}qe(e){return 0===e?this.Le:this.Ue}$e(){return this.Be.$e()}reset(){this.Be.reset()}}class ic{constructor(e,t,n,r){this.indexId=e,this.documentKey=t,this.arrayValue=n,this.directionalValue=r}Ke(){const e=this.directionalValue.length,t=0===e||255===this.directionalValue[e-1]?e+1:e,n=new Uint8Array(t);return n.set(this.directionalValue,0),t!==e?n.set([0],this.directionalValue.length):++n[n.length-1],new ic(this.indexId,this.documentKey,this.arrayValue,n)}}function oc(e,t){let n=e.indexId-t.indexId;return 0!==n?n:0!==(n=ac(e.arrayValue,t.arrayValue))?n:0!==(n=ac(e.directionalValue,t.directionalValue))?n:lr.comparator(e.documentKey,t.documentKey)}function ac(t,n){for(let e=0;e<t.length&&e<n.length;++e){var r=t[e]-n[e];if(0!=r)return r}return t.length-n.length}class uc{constructor(e){this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.Ge=e.orderBy,this.Qe=[];for(const t of e.filters){const e=t;e.dt()?this.je=e:this.Qe.push(e)}}We(e){var t=fr(e);if(void 0!==t&&!this.ze(t))return!1;var n=mr(e);let r=0,s=0;for(;r<n.length&&this.ze(n[r]);++r);if(r===n.length)return!0;if(void 0!==this.je){const e=n[r];if(!this.He(this.je,e)||!this.Je(this.Ge[s++],e))return!1;++r}for(;r<n.length;++r){const e=n[r];if(s>=this.Ge.length||!this.Je(this.Ge[s++],e))return!1}return!0}ze(e){for(const t of this.Qe)if(this.He(t,e))return!0;return!1}He(e,t){if(void 0===e||!e.field.isEqual(t.fieldPath))return!1;e="array-contains"===e.op||"array-contains-any"===e.op;return 2===t.kind==e}Je(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}class cc{constructor(){this.Ye=new hc}addToCollectionParentIndex(e,t){return this.Ye.add(t),xr.resolve()}getCollectionParents(e,t){return xr.resolve(this.Ye.getEntries(t))}addFieldIndex(e,t){return xr.resolve()}deleteFieldIndex(e,t){return xr.resolve()}getDocumentsMatchingTarget(e,t){return xr.resolve(null)}getIndexType(e,t){return xr.resolve(0)}getFieldIndexes(e,t){return xr.resolve([])}getNextCollectionGroupToUpdate(e){return xr.resolve(null)}getMinOffset(e,t){return xr.resolve(br.min())}getMinOffsetFromCollectionGroup(e,t){return xr.resolve(br.min())}updateCollectionGroup(e,t,n){return xr.resolve()}updateIndexEntries(e,t){return xr.resolve()}}class hc{constructor(){this.index={}}add(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new $r(ur.comparator),s=!r.has(n);return this.index[t]=r.add(n),s}has(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t];return r&&r.has(n)}getEntries(e){return(this.index[e]||new $r(ur.comparator)).toArray()}}const lc=new Uint8Array(0);class dc{constructor(e,t){this.user=e,this.databaseId=t,this.Xe=new hc,this.Ze=new na(e=>Oi(e),(e,t)=>Vi(e,t)),this.uid=e.uid||""}addToCollectionParentIndex(e,t){var n,r;return this.Xe.has(t)?xr.resolve():(r=t.lastSegment(),n=t.popLast(),e.addOnCommittedListener(()=>{this.Xe.add(t)}),r={collectionId:r,parent:nu(n)},fc(e).put(r))}getCollectionParents(e,n){const r=[],t=IDBKeyRange.bound([n,""],[rr(n),""],!1,!0);return fc(e).W(t).next(e=>{for(const t of e){if(t.collectionId!==n)break;r.push(iu(t.parent))}return r})}addFieldIndex(e,t){const n=gc(e),r={indexId:t.indexId,collectionGroup:t.collectionGroup,fields:t.fields.map(e=>[e.fieldPath.canonicalString(),e.kind])};delete r.indexId;const s=n.add(r);if(t.indexState){const n=pc(e);return s.next(e=>{n.put(Qu(e,this.user,t.indexState.sequenceNumber,t.indexState.offset))})}return s.next()}deleteFieldIndex(e,t){const n=gc(e),r=pc(e),s=mc(e);return n.delete(t.indexId).next(()=>r.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))).next(()=>s.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))}getDocumentsMatchingTarget(e,c){const h=mc(e);let l=!0;const n=new Map;return xr.forEach(this.tn(c),t=>this.en(e,t).next(e=>{l=l&&!!e,n.set(t,e)})).next(()=>{if(l){let u=fa();const l=[];return xr.forEach(n,(e,t)=>{Ms("IndexedDbIndexManager",`Using index ${n=e,`id=${n.indexId}|cg=${n.collectionGroup}|f=`+n.fields.map(e=>e.fieldPath+":"+e.kind).join(",")} to execute `+Oi(c));var n=function(e,t){var n=fr(t);if(void 0===n)return null;for(const t of Pi(e,n.fieldPath))switch(t.op){case"array-contains-any":return t.value.arrayValue.values||[];case"array-contains":return[t.value]}return null}(t,e),r=function(e,t){const n=new Map;for(const r of mr(t))for(const t of Pi(e,r.fieldPath))switch(t.op){case"==":case"in":n.set(r.fieldPath.canonicalString(),t.value);break;case"not-in":case"!=":return n.set(r.fieldPath.canonicalString(),t.value),Array.from(n.values())}return null}(t,e),s=function(e,t){const n=[];let r=!0;for(const s of mr(t)){const t=(0===s.kind?Bi:Ui)(e,s.fieldPath,e.startAt);n.push(t.value),r=r&&t.inclusive}return new Yi(n,r)}(t,e),i=function(e,t){const n=[];let r=!0;for(const s of mr(t)){const t=(0===s.kind?Ui:Bi)(e,s.fieldPath,e.endAt);n.push(t.value),r=r&&t.inclusive}return new Yi(n,r)}(t,e),o=this.nn(e,t,s),a=this.nn(e,t,i),t=this.sn(e,t,r),r=this.rn(e.indexId,n,o,s.inclusive,a,i.inclusive,t);return xr.forEach(r,e=>h.J(e,c.limit).next(e=>{e.forEach(e=>{e=lr.fromSegments(e.documentKey);u.has(e)||(u=u.add(e),l.push(e))})}))}).next(()=>l)}return xr.resolve(null)})}tn(e){return this.Ze.get(e)||(this.Ze.set(e,e=[e]),e)}rn(t,n,r,s,i,o,a){const u=(null!=n?n.length:1)*Math.max(r.length,i.length),c=u/(null!=n?n.length:1),h=[];for(let e=0;e<u;++e){const u=n?this.on(n[e/c]):lc,l=this.un(t,u,r[e%c],s),d=this.cn(t,u,i[e%c],o),f=a.map(e=>this.un(t,u,e,!0));h.push(...this.createRange(l,d,f))}return h}un(e,t,n,r){const s=new ic(e,lr.empty(),t,n);return r?s:s.Ke()}cn(e,t,n,r){const s=new ic(e,lr.empty(),t,n);return r?s.Ke():s}en(e,t){const r=new uc(t),n=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,n).next(e=>{let t=null;for(const n of e)r.We(n)&&(!t||n.fields.length>t.fields.length)&&(t=n);return t})}getIndexType(e,t){let n=2;return xr.forEach(this.tn(t),t=>this.en(e,t).next(e=>{e?0!==n&&e.fields.length<function(e){let t=new $r(hr.comparator),n=!1;for(const r of e.filters){const e=r;e.field.isKeyField()||("array-contains"===e.op||"array-contains-any"===e.op?n=!0:t=t.add(e.field))}for(const n of e.orderBy)n.field.isKeyField()||(t=t.add(n.field));return t.size+(n?1:0)}(t)&&(n=1):n=0})).next(()=>n)}an(e,t){const n=new rc;for(const s of mr(e)){const e=t.data.field(s.fieldPath);if(null==e)return null;var r=n.qe(s.kind);Ju.Te.ce(e,r)}return n.$e()}on(e){const t=new rc;return Ju.Te.ce(e,t.qe(0)),t.$e()}hn(e,t){const n=new rc;return Ju.Te.ce(wi(this.databaseId,t),n.qe(0===(t=mr(e)).length?0:t[t.length-1].kind)),n.$e()}sn(e,t,n){if(null===n)return[];let r=[],s=(r.push(new rc),0);for(const i of mr(e)){const e=n[s++];for(const n of r)if(this.ln(t,i.fieldPath)&&Ii(e))r=this.fn(r,i,e);else{const t=n.qe(i.kind);Ju.Te.ce(e,t)}}return this.dn(r)}nn(e,t,n){return this.sn(e,t,n.position)}dn(t){const n=[];for(let e=0;e<t.length;++e)n[e]=t[e].$e();return n}fn(e,t,n){const r=[...e],s=[];for(const e of n.arrayValue.values||[])for(const n of r){const r=new rc;r.seed(n.$e()),Ju.Te.ce(e,r.qe(t.kind)),s.push(r)}return s}ln(e,t){return!!e.filters.find(e=>e instanceof qi&&e.field.isEqual(t)&&("in"===e.op||"not-in"===e.op))}getFieldIndexes(e,t){const n=gc(e),i=pc(e);return(t?n.W("collectionGroupIndex",IDBKeyRange.bound(t,t)):n.W()).next(e=>{const s=[];return xr.forEach(e,r=>i.get([r.indexId,this.uid]).next(e=>{var t,n;s.push((t=r,e=(e=e)?new wr(e.sequenceNumber,new br(Bu(e.readTime),new lr(iu(e.documentKey)),e.largestBatchId)):wr.empty(),n=t.fields.map(([e,t])=>new pr(hr.fromServerFormat(e),t)),new dr(t.indexId,t.collectionGroup,n,e)))})).next(()=>s)})}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next(e=>0===e.length?null:(e.sort((e,t)=>{var n=e.indexState.sequenceNumber-t.indexState.sequenceNumber;return 0!=n?n:nr(e.collectionGroup,t.collectionGroup)}),e[0].collectionGroup))}updateCollectionGroup(e,n,r){const s=gc(e),i=pc(e);return this._n(e).next(t=>s.W("collectionGroupIndex",IDBKeyRange.bound(n,n)).next(e=>xr.forEach(e,e=>i.put(Qu(e.indexId,this.user,t,r)))))}updateIndexEntries(s,e){const n=new Map;return xr.forEach(e,(t,r)=>{var e=n.get(t.collectionGroup);return(e?xr.resolve(e):this.getFieldIndexes(s,t.collectionGroup)).next(e=>(n.set(t.collectionGroup,e),xr.forEach(e,n=>this.wn(s,t,n).next(e=>{var t=this.mn(r,n);return e.isEqual(t)?xr.resolve():this.gn(s,r,n,e,t)}))))})}yn(e,t,n,r){return mc(e).put({indexId:r.indexId,uid:this.uid,arrayValue:r.arrayValue,directionalValue:r.directionalValue,orderedDocumentKey:this.hn(n,t.key),documentKey:t.key.path.toArray()})}pn(e,t,n,r){return mc(e).delete([r.indexId,this.uid,r.arrayValue,r.directionalValue,this.hn(n,t.key),t.key.path.toArray()])}wn(e,n,r){const t=mc(e);let s=new $r(oc);return t.Z({index:"documentKeyIndex",range:IDBKeyRange.only([r.indexId,this.uid,this.hn(r,n)])},(e,t)=>{s=s.add(new ic(r.indexId,n,t.arrayValue,t.directionalValue))}).next(()=>s)}mn(e,t){let n=new $r(oc);var r=this.an(t,e);if(null==r)return n;const s=fr(t);if(null!=s){var i=e.data.field(s.fieldPath);if(Ii(i))for(const s of i.arrayValue.values||[])n=n.add(new ic(t.indexId,e.key,this.on(s),r))}else n=n.add(new ic(t.indexId,e.key,lc,r));return n}gn(t,s,i,e,o){Ms("IndexedDbIndexManager","Updating index entries for document '%s'",s.key);const a=[];{var u=oc,c=e=>{a.push(this.yn(t,s,i,e))},h=e=>{a.push(this.pn(t,s,i,e))},l=e.getIterator(),d=o.getIterator();let n=zr(l),r=zr(d);for(;n||r;){let e=!1,t=!1;if(n&&r){const c=u(n,r);c<0?t=!0:0<c&&(e=!0)}else null!=n?t=!0:e=!0;e?(c(r),r=zr(d)):t?(h(n),n=zr(l)):(n=zr(l),r=zr(d))}}return xr.waitFor(a)}_n(e){let r=1;return pc(e).Z({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(e,t,n)=>{n.done(),r=t.sequenceNumber+1}).next(()=>r)}createRange(e,t,n){n=n.sort((e,t)=>oc(e,t)).filter((e,t,n)=>!t||0!==oc(e,n[t-1]));const r=[];r.push(e);for(const s of n){const n=oc(s,e),i=oc(s,t);if(0===n)r[0]=e.Ke();else if(0<n&&i<0)r.push(s),r.push(s.Ke());else if(0<i)break}r.push(t);const s=[];for(let e=0;e<r.length;e+=2)s.push(IDBKeyRange.bound([r[e].indexId,this.uid,r[e].arrayValue,r[e].directionalValue,lc,[]],[r[e+1].indexId,this.uid,r[e+1].arrayValue,r[e+1].directionalValue,lc,[]]));return s}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(yc)}getMinOffset(t,e){return xr.mapArray(this.tn(e),e=>this.en(t,e).next(e=>e||Ps())).next(yc)}}function fc(e){return Nu(e,"collectionParents")}function mc(e){return Nu(e,"indexEntries")}function gc(e){return Nu(e,"indexConfiguration")}function pc(e){return Nu(e,"indexState")}function yc(t){Bs(0!==t.length);let n=t[0].indexState.offset,r=n.largestBatchId;for(let e=1;e<t.length;e++){var s=t[e].indexState.offset;Er(s,n)<0&&(n=s),r<s.largestBatchId&&(r=s.largestBatchId)}return new br(n.readTime,n.documentKey,r)}const wc={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class vc{constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}static withCacheSize(e){return new vc(e,vc.DEFAULT_COLLECTION_PERCENTILE,vc.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function Ic(e,t,n){const r=e.store("mutations"),s=e.store("documentMutations"),i=[],o=IDBKeyRange.only(n.batchId);let a=0;const u=r.Z({range:o},(e,t,n)=>(a++,n.delete())),c=(i.push(u.next(()=>{Bs(1===a)})),[]);for(const e of n.mutations){const r=uu(t,e.key.path,n.batchId);i.push(s.delete(r)),c.push(e.key)}return xr.waitFor(i).next(()=>c)}function bc(e){if(!e)return 0;let t;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw Ps();t=e.noDocument}return JSON.stringify(t).length}vc.DEFAULT_COLLECTION_PERCENTILE=10,vc.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,vc.DEFAULT=new vc(41943040,vc.DEFAULT_COLLECTION_PERCENTILE,vc.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),vc.DISABLED=new vc(-1,0,0);class Ec{constructor(e,t,n,r){this.userId=e,this.It=t,this.indexManager=n,this.referenceDelegate=r,this.In={}}static oe(e,t,n,r){Bs(""!==e.uid);e=e.isAuthenticated()?e.uid:"";return new Ec(e,t,n,r)}checkEmpty(e){let r=!0;var t=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return Sc(e).Z({index:"userMutationsIndex",range:t},(e,t,n)=>{r=!1,n.done()}).next(()=>r)}addMutationBatch(h,l,d,f){const m=_c(h),g=Sc(h);return g.add({}).next(e=>{Bs("number"==typeof e);const t=new ku(e,l,d,f),n=(s=this.It,i=this.userId,o=t,a=o.baseMutations.map(e=>Ga(s.re,e)),u=o.mutations.map(e=>Ga(s.re,e)),{userId:i,batchId:o.batchId,localWriteTimeMs:o.localWriteTime.toMillis(),baseMutations:a,mutations:u}),r=[];var s,i,o,a,u;let c=new $r((e,t)=>nr(e.canonicalString(),t.canonicalString()));for(const h of f){const l=uu(this.userId,h.key.path,e);c=c.add(h.key.path.popLast()),r.push(g.put(n)),r.push(m.put(l,cu))}return c.forEach(e=>{r.push(this.indexManager.addToCollectionParentIndex(h,e))}),h.addOnCommittedListener(()=>{this.In[e]=t.keys()}),xr.waitFor(r).next(()=>t)})}lookupMutationBatch(e,t){return Sc(e).get(t).next(e=>e?(Bs(e.userId===this.userId),Uu(this.It,e)):null)}Tn(e,t){return this.In[t]?xr.resolve(this.In[t]):this.lookupMutationBatch(e,t).next(e=>{return e?(e=e.keys(),this.In[t]=e):null})}getNextMutationBatchAfterBatchId(e,t){const r=t+1,n=IDBKeyRange.lowerBound([this.userId,r]);let s=null;return Sc(e).Z({index:"userMutationsIndex",range:n},(e,t,n)=>{t.userId===this.userId&&(Bs(t.batchId>=r),s=Uu(this.It,t)),n.done()}).next(()=>s)}getHighestUnacknowledgedBatchId(e){var t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let r=-1;return Sc(e).Z({index:"userMutationsIndex",range:t,reverse:!0},(e,t,n)=>{r=t.batchId,n.done()}).next(()=>r)}getAllMutationBatches(e){var t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return Sc(e).W("userMutationsIndex",t).next(e=>e.map(e=>Uu(this.It,e)))}getAllMutationBatchesAffectingDocumentKey(i,o){const e=au(this.userId,o.path),t=IDBKeyRange.lowerBound(e),a=[];return _c(i).Z({range:t},(e,t,n)=>{var[e,r,s]=e,r=iu(r);if(e===this.userId&&o.path.isEqual(r))return Sc(i).get(s).next(e=>{if(!e)throw Ps();Bs(e.userId===this.userId),a.push(Uu(this.It,e))});n.done()}).next(()=>a)}getAllMutationBatchesAffectingDocumentKeys(t,e){let o=new $r(nr);const n=[];return e.forEach(i=>{var e=au(this.userId,i.path),e=IDBKeyRange.lowerBound(e),e=_c(t).Z({range:e},(e,t,n)=>{var[e,r,s]=e,r=iu(r);e===this.userId&&i.path.isEqual(r)?o=o.add(s):n.done()});n.push(e)}),xr.waitFor(n).next(()=>this.En(t,o))}getAllMutationBatchesAffectingQuery(e,t){const i=t.path,o=i.length+1,n=au(this.userId,i),r=IDBKeyRange.lowerBound(n);let a=new $r(nr);return _c(e).Z({range:r},(e,t,n)=>{var[e,r,s]=e,r=iu(r);e===this.userId&&i.isPrefixOf(r)?r.length===o&&(a=a.add(s)):n.done()}).next(()=>this.En(e,a))}En(t,e){const n=[],r=[];return e.forEach(e=>{r.push(Sc(t).get(e).next(e=>{if(null===e)throw Ps();Bs(e.userId===this.userId),n.push(Uu(this.It,e))}))}),xr.waitFor(r).next(()=>n)}removeMutationBatch(t,n){return Ic(t.ie,this.userId,n).next(e=>(t.addOnCommittedListener(()=>{this.An(n.batchId)}),xr.forEach(e,e=>this.referenceDelegate.markPotentiallyOrphaned(t,e))))}An(e){delete this.In[e]}performConsistencyCheck(n){return this.checkEmpty(n).next(e=>{if(!e)return xr.resolve();const t=IDBKeyRange.lowerBound([this.userId]),r=[];return _c(n).Z({range:t},(e,t,n)=>{if(e[0]===this.userId){const t=iu(e[1]);r.push(t)}else n.done()}).next(()=>{Bs(0===r.length)})})}containsKey(e,t){return Tc(e,this.userId,t)}Rn(e){return xc(e).get(this.userId).next(e=>e||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""})}}function Tc(e,s,t){const n=au(s,t.path),i=n[1],r=IDBKeyRange.lowerBound(n);let o=!1;return _c(e).Z({range:r,X:!0},(e,t,n)=>{var[e,r]=e;e===s&&r===i&&(o=!0),n.done()}).next(()=>o)}function Sc(e){return Nu(e,"mutations")}function _c(e){return Nu(e,"documentMutations")}function xc(e){return Nu(e,"mutationQueues")}class Ac{constructor(e){this.bn=e}next(){return this.bn+=2,this.bn}static Pn(){return new Ac(0)}static vn(){return new Ac(-1)}}class Dc{constructor(e,t){this.referenceDelegate=e,this.It=t}allocateTargetId(n){return this.Vn(n).next(e=>{const t=new Ac(e.highestTargetId);return e.highestTargetId=t.next(),this.Sn(n,e).next(()=>e.highestTargetId)})}getLastRemoteSnapshotVersion(e){return this.Vn(e).next(e=>or.fromTimestamp(new ir(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(e){return this.Vn(e).next(e=>e.highestListenSequenceNumber)}setTargetsMetadata(t,n,r){return this.Vn(t).next(e=>(e.highestListenSequenceNumber=n,r&&(e.lastRemoteSnapshotVersion=r.toTimestamp()),n>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=n),this.Sn(t,e)))}addTargetData(t,n){return this.Dn(t,n).next(()=>this.Vn(t).next(e=>(e.targetCount+=1,this.Cn(n,e),this.Sn(t,e))))}updateTargetData(e,t){return this.Dn(e,t)}removeTargetData(t,e){return this.removeMatchingKeysForTargetId(t,e.targetId).next(()=>Cc(t).delete(e.targetId)).next(()=>this.Vn(t)).next(e=>(Bs(0<e.targetCount),--e.targetCount,this.Sn(t,e)))}removeTargets(n,r,s){let i=0;const o=[];return Cc(n).Z((e,t)=>{t=qu(t);t.sequenceNumber<=r&&null===s.get(t.targetId)&&(i++,o.push(this.removeTargetData(n,t)))}).next(()=>xr.waitFor(o)).next(()=>i)}forEachTarget(e,n){return Cc(e).Z((e,t)=>{t=qu(t);n(t)})}Vn(e){return Nc(e).get("targetGlobalKey").next(e=>(Bs(null!==e),e))}Sn(e,t){return Nc(e).put("targetGlobalKey",t)}Dn(e,t){return Cc(e).put(Gu(this.It,t))}Cn(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.Vn(e).next(e=>e.targetCount)}getTargetData(e,r){var t=Oi(r),t=IDBKeyRange.bound([t,Number.NEGATIVE_INFINITY],[t,Number.POSITIVE_INFINITY]);let s=null;return Cc(e).Z({range:t,index:"queryTargetsIndex"},(e,t,n)=>{t=qu(t);Vi(r,t.target)&&(s=t,n.done())}).next(()=>s)}addMatchingKeys(n,e,r){const s=[],i=kc(n);return e.forEach(e=>{var t=nu(e.path);s.push(i.put({targetId:r,path:t})),s.push(this.referenceDelegate.addReference(n,r,e))}),xr.waitFor(s)}removeMatchingKeys(n,e,r){const s=kc(n);return xr.forEach(e,e=>{var t=nu(e.path);return xr.waitFor([s.delete([r,t]),this.referenceDelegate.removeReference(n,r,e)])})}removeMatchingKeysForTargetId(e,t){const n=kc(e),r=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(e,t){const n=IDBKeyRange.bound([t],[t+1],!1,!0),r=kc(e);let s=fa();return r.Z({range:n,X:!0},(e,t,n)=>{e=iu(e[1]),e=new lr(e);s=s.add(e)}).next(()=>s)}containsKey(e,t){t=nu(t.path),t=IDBKeyRange.bound([t],[rr(t)],!1,!0);let r=0;return kc(e).Z({index:"documentTargetsIndex",X:!0,range:t},([e],t,n)=>{0!==e&&(r++,n.done())}).next(()=>0<r)}se(e,t){return Cc(e).get(t).next(e=>e?qu(e):null)}}function Cc(e){return Nu(e,"targets")}function Nc(e){return Nu(e,"targetGlobal")}function kc(e){return Nu(e,"targetDocuments")}function Rc([e,t],[n,r]){e=nr(e,n);return 0===e?nr(t,r):e}class Lc{constructor(e){this.xn=e,this.buffer=new $r(Rc),this.Nn=0}kn(){return++this.Nn}On(e){var t=[e,this.kn()];if(this.buffer.size<this.xn)this.buffer=this.buffer.add(t);else{const e=this.buffer.last();Rc(t,e)<0&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class Mc{constructor(e,t,n){this.garbageCollector=e,this.asyncQueue=t,this.localStore=n,this.Mn=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.Fn(6e4)}stop(){this.Mn&&(this.Mn.cancel(),this.Mn=null)}get started(){return null!==this.Mn}Fn(e){Ms("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this.Mn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,async()=>{this.Mn=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){kr(e)?Ms("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",e):await _r(e)}await this.Fn(3e5)})}}class Oc{constructor(e,t){this.$n=e,this.params=t}calculateTargetCount(e,t){return this.$n.Bn(e).next(e=>Math.floor(t/100*e))}nthSequenceNumber(e,t){if(0===t)return xr.resolve(Pr.at);const n=new Lc(t);return this.$n.forEachTarget(e,e=>n.On(e.sequenceNumber)).next(()=>this.$n.Ln(e,e=>n.On(e))).next(()=>n.maxValue)}removeTargets(e,t,n){return this.$n.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.$n.removeOrphanedDocuments(e,t)}collect(t,n){return-1===this.params.cacheSizeCollectionThreshold?(Ms("LruGarbageCollector","Garbage collection skipped; disabled"),xr.resolve(wc)):this.getCacheSize(t).next(e=>e<this.params.cacheSizeCollectionThreshold?(Ms("LruGarbageCollector",`Garbage collection skipped; Cache size ${e} is lower than threshold `+this.params.cacheSizeCollectionThreshold),wc):this.Un(t,n))}getCacheSize(e){return this.$n.getCacheSize(e)}Un(t,n){let r,s,i,o,a,u,c;const h=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next(e=>(s=e>this.params.maximumSequenceNumbersToCollect?(Ms("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from `+e),this.params.maximumSequenceNumbersToCollect):e,o=Date.now(),this.nthSequenceNumber(t,s))).next(e=>(r=e,a=Date.now(),this.removeTargets(t,r,n))).next(e=>(i=e,u=Date.now(),this.removeOrphanedDocuments(t,r))).next(e=>(c=Date.now(),Rs()<=E.DEBUG&&Ms("LruGarbageCollector",`LRU Garbage Collection
	Counted targets in ${o-h}ms
	Determined least recently used ${s} in `+(a-o)+"ms\n"+`	Removed ${i} targets in `+(u-a)+"ms\n"+`	Removed ${e} documents in `+(c-u)+"ms\n"+`Total Duration: ${c-h}ms`),xr.resolve({didRun:!0,sequenceNumbersCollected:s,targetsRemoved:i,documentsRemoved:e})))}}class Vc{constructor(e,t){this.db=e,this.garbageCollector=(e=this,t=t,new Oc(e,t))}Bn(e){const n=this.qn(e);return this.db.getTargetCache().getTargetCount(e).next(t=>n.next(e=>t+e))}qn(e){let t=0;return this.Ln(e,e=>{t++}).next(()=>t)}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}Ln(e,n){return this.Kn(e,(e,t)=>n(t))}addReference(e,t,n){return Fc(e,n)}removeReference(e,t,n){return Fc(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return Fc(e,t)}Gn(e,n){{var r=e,s=n;let t=!1;return xc(r).tt(e=>Tc(r,e,s).next(e=>(e&&(t=!0),xr.resolve(!e)))).next(()=>t)}}removeOrphanedDocuments(n,r){const s=this.db.getRemoteDocumentCache().newChangeBuffer(),i=[];let o=0;return this.Kn(n,(t,e)=>{if(e<=r){const r=this.Gn(n,t).next(e=>{if(!e)return o++,s.getEntry(n,t).next(()=>(s.removeEntry(t,or.min()),kc(n).delete([0,nu(t.path)])))});i.push(r)}}).next(()=>xr.waitFor(i)).next(()=>s.apply(n)).next(()=>o)}removeTarget(e,t){t=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,t)}updateLimboDocument(e,t){return Fc(e,t)}Kn(e,r){const t=kc(e);let s,i=Pr.at;return t.Z({index:"documentTargetsIndex"},([e],{path:t,sequenceNumber:n})=>{0===e?(i!==Pr.at&&r(new lr(iu(s)),i),i=n,s=t):i=Pr.at}).next(()=>{i!==Pr.at&&r(new lr(iu(s)),i)})}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function Fc(e,t){return kc(e).put((e=e.currentSequenceNumber,{targetId:0,path:nu(t.path),sequenceNumber:e}))}class Pc{constructor(){this.changes=new na(e=>e.toString(),(e,t)=>e.isEqual(t)),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,Ri.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();var n=this.changes.get(t);return void 0!==n?xr.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class Bc{constructor(e){this.It=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,n){return Kc(e).put(n)}removeEntry(e,n,t){return Kc(e).delete(function(e){const t=n.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],Fu(e),t[t.length-1]]}(t))}updateMetadata(t,n){return this.getMetadata(t).next(e=>(e.byteSize+=n,this.Qn(t,e)))}getEntry(e,n){let r=Ri.newInvalidDocument(n);return Kc(e).Z({index:"documentKeyIndex",range:IDBKeyRange.only(jc(n))},(e,t)=>{r=this.jn(n,t)}).next(()=>r)}Wn(e,n){let r={size:0,document:Ri.newInvalidDocument(n)};return Kc(e).Z({index:"documentKeyIndex",range:IDBKeyRange.only(jc(n))},(e,t)=>{r={document:this.jn(n,t),size:bc(t)}}).next(()=>r)}getEntries(e,t){let n=ra();return this.zn(e,t,(e,t)=>{t=this.jn(e,t);n=n.insert(e,t)}).next(()=>n)}Hn(e,t){let r=ra(),s=new Gr(lr.comparator);return this.zn(e,t,(e,t)=>{var n=this.jn(e,t);r=r.insert(e,n),s=s.insert(e,bc(t))}).next(()=>({documents:r,Jn:s}))}zn(e,t,s){if(t.isEmpty())return xr.resolve();let n=new $r(Qc);t.forEach(e=>n=n.add(e));const r=IDBKeyRange.bound(jc(n.first()),jc(n.last())),i=n.getIterator();let o=i.getNext();return Kc(e).Z({index:"documentKeyIndex",range:r},(e,t,n)=>{for(var r=lr.fromSegments([...t.prefixPath,t.collectionGroup,t.documentId]);o&&Qc(o,r)<0;)s(o,null),o=i.getNext();o&&o.isEqual(r)&&(s(o,t),o=i.hasNext()?i.getNext():null),o?n.j(jc(o)):n.done()}).next(()=>{for(;o;)s(o,null),o=i.hasNext()?i.getNext():null})}getAllFromCollection(e,t,n){n=[t.popLast().toArray(),t.lastSegment(),Fu(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],t=[t.popLast().toArray(),t.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return Kc(e).W(IDBKeyRange.bound(n,t,!0)).next(e=>{let t=ra();for(const n of e){const e=this.jn(lr.fromSegments(n.prefixPath.concat(n.collectionGroup,n.documentId)),n);t=t.insert(e.key,e)}return t})}getAllFromCollectionGroup(e,t,n,r){let s=ra();n=$c(t,n),t=$c(t,br.max());return Kc(e).Z({index:"collectionGroupIndex",range:IDBKeyRange.bound(n,t,!0)},(e,t,n)=>{t=this.jn(lr.fromSegments(t.prefixPath.concat(t.collectionGroup,t.documentId)),t);(s=s.insert(t.key,t)).size===r&&n.done()}).next(()=>s)}newChangeBuffer(e){return new qc(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next(e=>e.byteSize)}getMetadata(e){return Gc(e).get("remoteDocumentGlobalKey").next(e=>(Bs(!!e),e))}Qn(e,t){return Gc(e).put("remoteDocumentGlobalKey",t)}jn(e,t){if(t){const e=function(e,t){let n;if(t.document)n=qa(e.re,t.document,!!t.hasCommittedMutations);else if(t.noDocument){const e=lr.fromSegments(t.noDocument.path),r=Bu(t.noDocument.readTime);n=Ri.newNoDocument(e,r),t.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!t.unknownDocument)return Ps();{const e=lr.fromSegments(t.unknownDocument.path),s=Bu(t.unknownDocument.version);n=Ri.newUnknownDocument(e,s)}}return t.readTime&&n.setReadTime(function(e){e=new ir(e[0],e[1]);return or.fromTimestamp(e)}(t.readTime)),n}(this.It,t);if(!e.isNoDocument()||!e.version.isEqual(or.min()))return e}return Ri.newInvalidDocument(e)}}function Uc(e){return new Bc(e)}class qc extends Pc{constructor(e,t){super(),this.Yn=e,this.trackRemovals=t,this.Xn=new na(e=>e.toString(),(e,t)=>e.isEqual(t))}applyChanges(i){const o=[];let a=0,u=new $r((e,t)=>nr(e.canonicalString(),t.canonicalString()));return this.changes.forEach((e,t)=>{var n=this.Xn.get(e);if(o.push(this.Yn.removeEntry(i,e,n.readTime)),t.isValidDocument()){var r=Vu(this.Yn.It,t),s=(u=u.add(e.path.popLast()),bc(r));a+=s-n.size,o.push(this.Yn.addEntry(i,e,r))}else if(a-=n.size,this.trackRemovals){const a=Vu(this.Yn.It,t.convertToNoDocument(or.min()));o.push(this.Yn.addEntry(i,e,a))}}),u.forEach(e=>{o.push(this.Yn.indexManager.addToCollectionParentIndex(i,e))}),o.push(this.Yn.updateMetadata(i,a)),xr.waitFor(o)}getFromCache(e,t){return this.Yn.Wn(e,t).next(e=>(this.Xn.set(t,{size:e.size,readTime:e.document.readTime}),e.document))}getAllFromCache(e,t){return this.Yn.Hn(e,t).next(({documents:n,Jn:e})=>(e.forEach((e,t)=>{this.Xn.set(e,{size:t,readTime:n.get(e).readTime})}),n))}}function Gc(e){return Nu(e,"remoteDocumentGlobal")}function Kc(e){return Nu(e,"remoteDocumentsV14")}function jc(e){const t=e.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function $c(e,t){const n=t.documentKey.path.toArray();return[e,Fu(t.readTime),n.slice(0,n.length-2),0<n.length?n[n.length-1]:""]}function Qc(e,t){var n=e.path.toArray(),r=t.path.toArray();let s=0;for(let e=0;e<n.length-2&&e<r.length-2;++e)if(s=nr(n[e],r[e]))return s;return(s=nr(n.length,r.length))||((s=nr(n[n.length-2],r[r.length-2]))||nr(n[n.length-1],r[r.length-1]))}class zc{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class Hc{constructor(e,t,n,r){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=r}getDocument(t,n){let r=null;return this.documentOverlayCache.getOverlay(t,n).next(e=>(r=e,this.getBaseDocument(t,n,r))).next(e=>(null!==r&&qo(r.mutation,e,Hr.empty(),ir.now()),e))}getDocuments(t,e){return this.remoteDocumentCache.getEntries(t,e).next(e=>this.getLocalViewOfDocuments(t,e,fa()).next(()=>e))}getLocalViewOfDocuments(e,t,n=fa()){const r=ua();return this.populateOverlays(e,r,t).next(()=>this.computeViews(e,t,r,n).next(e=>{let n=oa();return e.forEach((e,t)=>{n=n.insert(e,t.overlayedDocument)}),n}))}getOverlayedDocuments(e,t){const n=ua();return this.populateOverlays(e,n,t).next(()=>this.computeViews(e,t,n,fa()))}populateOverlays(e,n,t){const r=[];return t.forEach(e=>{n.has(e)||r.push(e)}),this.documentOverlayCache.getOverlays(e,r).next(e=>{e.forEach((e,t)=>{n.set(e,t)})})}computeViews(e,t,r,s){let i=ra();const o=ha(),n=ha();return t.forEach((e,t)=>{const n=r.get(t.key);s.has(t.key)&&(void 0===n||n.mutation instanceof $o)?i=i.insert(t.key,t):void 0!==n&&(o.set(t.key,n.mutation.getFieldMask()),qo(n.mutation,t,n.mutation.getFieldMask(),ir.now()))}),this.recalculateAndSaveOverlays(e,i).next(e=>(e.forEach((e,t)=>o.set(e,t)),t.forEach((e,t)=>{return n.set(e,new zc(t,null!=(t=o.get(e))?t:null))}),n))}recalculateAndSaveOverlays(i,o){const a=ha();let u=new Gr((e,t)=>e-t),c=fa();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(i,o).next(e=>{for(const r of e)r.keys().forEach(e=>{var t,n=o.get(e);null!==n&&(t=a.get(e)||Hr.empty(),t=r.applyToLocalView(n,t),a.set(e,t),n=(u.get(r.batchId)||fa()).add(e),u=u.insert(r.batchId,n))})}).next(()=>{const e=[],t=u.getReverseIterator();for(;t.hasNext();){const u=t.getNext(),n=u.key,r=u.value,s=ca();r.forEach(e=>{var t;c.has(e)||(null!==(t=Bo(o.get(e),a.get(e)))&&s.set(e,t),c=c.add(e))}),e.push(this.documentOverlayCache.saveOverlays(i,n,s))}return xr.waitFor(e)}).next(()=>a)}recalculateAndSaveOverlaysForDocumentKeys(t,e){return this.remoteDocumentCache.getEntries(t,e).next(e=>this.recalculateAndSaveOverlays(t,e))}getDocumentsMatchingQuery(e,t,n){return r=t,lr.isDocumentKey(r.path)&&null===r.collectionGroup&&0===r.filters.length?this.getDocumentsMatchingDocumentQuery(e,t.path):ao(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n):this.getDocumentsMatchingCollectionQuery(e,t,n);var r}getNextDocuments(i,t,o,a){return this.remoteDocumentCache.getAllFromCollectionGroup(i,t,o,a).next(n=>{const e=0<a-n.size?this.documentOverlayCache.getOverlaysForCollectionGroup(i,t,o.largestBatchId,a-n.size):xr.resolve(ua());let r=-1,s=n;return e.next(e=>xr.forEach(e,(t,e)=>(r<e.largestBatchId&&(r=e.largestBatchId),n.get(t)?xr.resolve():this.getBaseDocument(i,t,e).next(e=>{s=s.insert(t,e)}))).next(()=>this.populateOverlays(i,e,n)).next(()=>this.computeViews(i,s,e,fa())).next(e=>({batchId:r,changes:aa(e)})))})}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new lr(t)).next(e=>{let t=oa();return t=e.isFoundDocument()?t.insert(e.key,e):t})}getDocumentsMatchingCollectionGroupQuery(n,r,s){const i=r.collectionGroup;let o=oa();return this.indexManager.getCollectionParents(n,i).next(e=>xr.forEach(e,e=>{t=r,e=e.child(i);var t,e=new eo(e,null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt);return this.getDocumentsMatchingCollectionQuery(n,e,s).next(e=>{e.forEach((e,t)=>{o=o.insert(e,t)})})}).next(()=>o))}getDocumentsMatchingCollectionQuery(t,i,n){let o;return this.remoteDocumentCache.getAllFromCollection(t,i.path,n).next(e=>(o=e,this.documentOverlayCache.getOverlaysForCollection(t,i.path,n.largestBatchId))).next(r=>{r.forEach((e,t)=>{t=t.getKey();null===o.get(t)&&(o=o.insert(t,Ri.newInvalidDocument(t)))});let s=oa();return o.forEach((e,t)=>{var n=r.get(e);void 0!==n&&qo(n.mutation,t,Hr.empty(),ir.now()),go(i,t)&&(s=s.insert(e,t))}),s})}getBaseDocument(e,t,n){return null===n||1===n.mutation.type?this.remoteDocumentCache.getEntry(e,t):xr.resolve(Ri.newInvalidDocument(t))}}class Wc{constructor(e){this.It=e,this.Zn=new Map,this.ts=new Map}getBundleMetadata(e,t){return xr.resolve(this.Zn.get(t))}saveBundleMetadata(e,t){return this.Zn.set(t.id,{id:t.id,version:t.version,createTime:ka(t.createTime)}),xr.resolve()}getNamedQuery(e,t){return xr.resolve(this.ts.get(t))}saveNamedQuery(e,t){return this.ts.set(t.name,{name:(t=t).name,query:Ku(t.bundledQuery),readTime:ka(t.readTime)}),xr.resolve()}}class Yc{constructor(){this.overlays=new Gr(lr.comparator),this.es=new Map}getOverlay(e,t){return xr.resolve(this.overlays.get(t))}getOverlays(e,t){const n=ua();return xr.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(n,r,e){return e.forEach((e,t)=>{this.ue(n,r,t)}),xr.resolve()}removeOverlaysForBatchId(e,t,n){const r=this.es.get(n);return void 0!==r&&(r.forEach(e=>this.overlays=this.overlays.remove(e)),this.es.delete(n)),xr.resolve()}getOverlaysForCollection(e,t,n){const r=ua(),s=t.length+1,i=new lr(t.child("")),o=this.overlays.getIteratorFrom(i);for(;o.hasNext();){const e=o.getNext().value,i=e.getKey();if(!t.isPrefixOf(i.path))break;i.path.length===s&&e.largestBatchId>n&&r.set(e.getKey(),e)}return xr.resolve(r)}getOverlaysForCollectionGroup(t,e,n,r){let s=new Gr((e,t)=>e-t);const i=this.overlays.getIterator();for(;i.hasNext();){const t=i.getNext().value;if(t.getKey().getCollectionGroup()===e&&t.largestBatchId>n){let e=s.get(t.largestBatchId);null===e&&(e=ua(),s=s.insert(t.largestBatchId,e)),e.set(t.getKey(),t)}}const o=ua(),a=s.getIterator();for(;a.hasNext()&&(a.getNext().value.forEach((e,t)=>o.set(e,t)),!(o.size()>=r)););return xr.resolve(o)}ue(e,t,n){var r=this.overlays.get(n.key);if(null!==r){const e=this.es.get(r.largestBatchId).delete(n.key);this.es.set(r.largestBatchId,e)}this.overlays=this.overlays.insert(n.key,new Lu(t,n));let s=this.es.get(t);void 0===s&&(s=fa(),this.es.set(t,s)),this.es.set(t,s.add(n.key))}}class Xc{constructor(){this.ns=new $r(Jc.ss),this.rs=new $r(Jc.os)}isEmpty(){return this.ns.isEmpty()}addReference(e,t){e=new Jc(e,t);this.ns=this.ns.add(e),this.rs=this.rs.add(e)}us(e,t){e.forEach(e=>this.addReference(e,t))}removeReference(e,t){this.cs(new Jc(e,t))}hs(e,t){e.forEach(e=>this.removeReference(e,t))}ls(e){const t=new lr(new ur([])),n=new Jc(t,e),r=new Jc(t,e+1),s=[];return this.rs.forEachInRange([n,r],e=>{this.cs(e),s.push(e.key)}),s}fs(){this.ns.forEach(e=>this.cs(e))}cs(e){this.ns=this.ns.delete(e),this.rs=this.rs.delete(e)}ds(e){var t=new lr(new ur([])),n=new Jc(t,e),t=new Jc(t,e+1);let r=fa();return this.rs.forEachInRange([n,t],e=>{r=r.add(e.key)}),r}containsKey(e){var t=new Jc(e,0),t=this.ns.firstAfterOrEqual(t);return null!==t&&e.isEqual(t.key)}}class Jc{constructor(e,t){this.key=e,this._s=t}static ss(e,t){return lr.comparator(e.key,t.key)||nr(e._s,t._s)}static os(e,t){return nr(e._s,t._s)||lr.comparator(e.key,t.key)}}class Zc{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.ws=1,this.gs=new $r(Jc.ss)}checkEmpty(e){return xr.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,r){var s=this.ws,t=(this.ws++,0<this.mutationQueue.length&&this.mutationQueue[this.mutationQueue.length-1],new ku(s,t,n,r));this.mutationQueue.push(t);for(const t of r)this.gs=this.gs.add(new Jc(t.key,s)),this.indexManager.addToCollectionParentIndex(e,t.key.path.popLast());return xr.resolve(t)}lookupMutationBatch(e,t){return xr.resolve(this.ys(t))}getNextMutationBatchAfterBatchId(e,t){t=this.ps(t+1),t=t<0?0:t;return xr.resolve(this.mutationQueue.length>t?this.mutationQueue[t]:null)}getHighestUnacknowledgedBatchId(){return xr.resolve(0===this.mutationQueue.length?-1:this.ws-1)}getAllMutationBatches(e){return xr.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){const n=new Jc(t,0),r=new Jc(t,Number.POSITIVE_INFINITY),s=[];return this.gs.forEachInRange([n,r],e=>{e=this.ys(e._s);s.push(e)}),xr.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new $r(nr);return t.forEach(e=>{var t=new Jc(e,0),e=new Jc(e,Number.POSITIVE_INFINITY);this.gs.forEachInRange([t,e],e=>{n=n.add(e._s)})}),xr.resolve(this.Is(n))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1;let s=n;lr.isDocumentKey(s)||(s=s.child(""));t=new Jc(new lr(s),0);let i=new $r(nr);return this.gs.forEachWhile(e=>{var t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(i=i.add(e._s)),!0)},t),xr.resolve(this.Is(i))}Is(e){const t=[];return e.forEach(e=>{e=this.ys(e);null!==e&&t.push(e)}),t}removeMutationBatch(n,r){Bs(0===this.Ts(r.batchId,"removed")),this.mutationQueue.shift();let s=this.gs;return xr.forEach(r.mutations,e=>{var t=new Jc(e.key,r.batchId);return s=s.delete(t),this.referenceDelegate.markPotentiallyOrphaned(n,e.key)}).next(()=>{this.gs=s})}An(e){}containsKey(e,t){var n=new Jc(t,0),n=this.gs.firstAfterOrEqual(n);return xr.resolve(t.isEqual(n&&n.key))}performConsistencyCheck(e){return this.mutationQueue.length,xr.resolve()}Ts(e,t){return this.ps(e)}ps(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}ys(e){e=this.ps(e);return e<0||e>=this.mutationQueue.length?null:this.mutationQueue[e]}}class th{constructor(e){this.Es=e,this.docs=new Gr(lr.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){const n=t.key,r=this.docs.get(n),s=r?r.size:0,i=this.Es(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:i}),this.size+=i-s,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){var t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){const n=this.docs.get(t);return xr.resolve(n?n.document.mutableCopy():Ri.newInvalidDocument(t))}getEntries(e,t){let n=ra();return t.forEach(e=>{const t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():Ri.newInvalidDocument(e))}),xr.resolve(n)}getAllFromCollection(e,t,n){let r=ra();const s=new lr(t.child("")),i=this.docs.getIteratorFrom(s);for(;i.hasNext();){const{key:e,value:{document:s}}=i.getNext();if(!t.isPrefixOf(e.path))break;e.path.length>t.length+1||Er(Ir(s),n)<=0||(r=r.insert(s.key,s.mutableCopy()))}return xr.resolve(r)}getAllFromCollectionGroup(e,t,n,r){Ps()}As(e,t){return xr.forEach(this.docs,e=>t(e))}newChangeBuffer(e){return new eh(this)}getSize(e){return xr.resolve(this.size)}}class eh extends Pc{constructor(e){super(),this.Yn=e}applyChanges(n){const r=[];return this.changes.forEach((e,t)=>{t.isValidDocument()?r.push(this.Yn.addEntry(n,t)):this.Yn.removeEntry(e)}),xr.waitFor(r)}getFromCache(e,t){return this.Yn.getEntry(e,t)}getAllFromCache(e,t){return this.Yn.getEntries(e,t)}}class nh{constructor(e){this.persistence=e,this.Rs=new na(e=>Oi(e),Vi),this.lastRemoteSnapshotVersion=or.min(),this.highestTargetId=0,this.bs=0,this.Ps=new Xc,this.targetCount=0,this.vs=Ac.Pn()}forEachTarget(e,n){return this.Rs.forEach((e,t)=>n(t)),xr.resolve()}getLastRemoteSnapshotVersion(e){return xr.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return xr.resolve(this.bs)}allocateTargetId(e){return this.highestTargetId=this.vs.next(),xr.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.bs&&(this.bs=t),xr.resolve()}Dn(e){this.Rs.set(e.target,e);var t=e.targetId;t>this.highestTargetId&&(this.vs=new Ac(t),this.highestTargetId=t),e.sequenceNumber>this.bs&&(this.bs=e.sequenceNumber)}addTargetData(e,t){return this.Dn(t),this.targetCount+=1,xr.resolve()}updateTargetData(e,t){return this.Dn(t),xr.resolve()}removeTargetData(e,t){return this.Rs.delete(t.target),this.Ps.ls(t.targetId),--this.targetCount,xr.resolve()}removeTargets(n,r,s){let i=0;const o=[];return this.Rs.forEach((e,t)=>{t.sequenceNumber<=r&&null===s.get(t.targetId)&&(this.Rs.delete(e),o.push(this.removeMatchingKeysForTargetId(n,t.targetId)),i++)}),xr.waitFor(o).next(()=>i)}getTargetCount(e){return xr.resolve(this.targetCount)}getTargetData(e,t){t=this.Rs.get(t)||null;return xr.resolve(t)}addMatchingKeys(e,t,n){return this.Ps.us(t,n),xr.resolve()}removeMatchingKeys(t,e,n){this.Ps.hs(e,n);const r=this.persistence.referenceDelegate,s=[];return r&&e.forEach(e=>{s.push(r.markPotentiallyOrphaned(t,e))}),xr.waitFor(s)}removeMatchingKeysForTargetId(e,t){return this.Ps.ls(t),xr.resolve()}getMatchingKeysForTargetId(e,t){t=this.Ps.ds(t);return xr.resolve(t)}containsKey(e,t){return xr.resolve(this.Ps.containsKey(t))}}class sh{constructor(e,t){this.Vs={},this.overlays={},this.Ss=new Pr(0),this.Ds=!1,this.Ds=!0,this.referenceDelegate=e(this),this.Cs=new nh(this),this.indexManager=new cc,this.remoteDocumentCache=(e=e=>this.referenceDelegate.xs(e),new th(e)),this.It=new Ou(t),this.Ns=new Wc(this.It)}start(){return Promise.resolve()}shutdown(){return this.Ds=!1,Promise.resolve()}get started(){return this.Ds}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new Yc,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.Vs[e.toKey()];return n||(n=new Zc(t,this.referenceDelegate),this.Vs[e.toKey()]=n),n}getTargetCache(){return this.Cs}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Ns}runTransaction(e,t,n){Ms("MemoryPersistence","Starting transaction:",e);const r=new rh(this.Ss.next());return this.referenceDelegate.ks(),n(r).next(e=>this.referenceDelegate.Os(r).next(()=>e)).toPromise().then(e=>(r.raiseOnCommittedEvent(),e))}Ms(t,n){return xr.or(Object.values(this.Vs).map(e=>()=>e.containsKey(t,n)))}}class rh extends Sr{constructor(e){super(),this.currentSequenceNumber=e}}class ih{constructor(e){this.persistence=e,this.Fs=new Xc,this.$s=null}static Bs(e){return new ih(e)}get Ls(){if(this.$s)return this.$s;throw Ps()}addReference(e,t,n){return this.Fs.addReference(n,t),this.Ls.delete(n.toString()),xr.resolve()}removeReference(e,t,n){return this.Fs.removeReference(n,t),this.Ls.add(n.toString()),xr.resolve()}markPotentiallyOrphaned(e,t){return this.Ls.add(t.toString()),xr.resolve()}removeTarget(e,t){this.Fs.ls(t.targetId).forEach(e=>this.Ls.add(e.toString()));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next(e=>{e.forEach(e=>this.Ls.add(e.toString()))}).next(()=>n.removeTargetData(e,t))}ks(){this.$s=new Set}Os(n){const r=this.persistence.getRemoteDocumentCache().newChangeBuffer();return xr.forEach(this.Ls,e=>{const t=lr.fromPath(e);return this.Us(n,t).next(e=>{e||r.removeEntry(t,or.min())})}).next(()=>(this.$s=null,r.apply(n)))}updateLimboDocument(e,t){return this.Us(e,t).next(e=>{e?this.Ls.delete(t.toString()):this.Ls.add(t.toString())})}xs(e){return 0}Us(e,t){return xr.or([()=>xr.resolve(this.Fs.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Ms(e,t)])}}class oh{constructor(e){this.It=e}$(t,e,n,r){const i=new Ar("createOrUpgrade",e);n<1&&1<=r&&(t.createObjectStore("owner"),(e=t).createObjectStore("mutationQueues",{keyPath:"userId"}),e.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",ou,{unique:!0}),e.createObjectStore("documentMutations"),ah(t),t.createObjectStore("remoteDocuments"));let s=xr.resolve();return n<3&&3<=r&&(0!==n&&((e=t).deleteObjectStore("targetDocuments"),e.deleteObjectStore("targets"),e.deleteObjectStore("targetGlobal"),ah(t)),s=s.next(()=>{{const e=i.store("targetGlobal"),t={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:or.min().toTimestamp(),targetCount:0};return e.put("targetGlobalKey",t)}})),n<4&&4<=r&&(s=(s=0!==n?s.next(()=>{var r=t,s=i;return s.store("mutations").W().next(e=>{r.deleteObjectStore("mutations"),r.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",ou,{unique:!0});const t=s.store("mutations"),n=e.map(e=>t.put(e));return xr.waitFor(n)})}):s).next(()=>{t.createObjectStore("clientMetadata",{keyPath:"clientId"})})),n<5&&5<=r&&(s=s.next(()=>this.qs(i))),n<6&&6<=r&&(s=s.next(()=>(t.createObjectStore("remoteDocumentGlobal"),this.Ks(i)))),n<7&&7<=r&&(s=s.next(()=>this.Gs(i))),n<8&&8<=r&&(s=s.next(()=>this.Qs(t,i))),n<9&&9<=r&&(s=s.next(()=>{var e;(e=t).objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")})),n<10&&10<=r&&(s=s.next(()=>this.js(i))),n<11&&11<=r&&(s=s.next(()=>{t.createObjectStore("bundles",{keyPath:"bundleId"}),t.createObjectStore("namedQueries",{keyPath:"name"})})),n<12&&12<=r&&(s=s.next(()=>{{const e=t.createObjectStore("documentOverlays",{keyPath:bu});return e.createIndex("collectionPathOverlayIndex",Eu,{unique:!1}),void e.createIndex("collectionGroupOverlayIndex",Tu,{unique:!1})}})),n<13&&13<=r&&(s=s.next(()=>{{const e=t.createObjectStore("remoteDocumentsV14",{keyPath:hu});return e.createIndex("documentKeyIndex",lu),void e.createIndex("collectionGroupIndex",du)}}).next(()=>this.Ws(t,i)).next(()=>t.deleteObjectStore("remoteDocuments"))),n<14&&14<=r&&(s=s.next(()=>this.zs(t,i))),s=n<15&&15<=r?s.next(()=>{var e=t;e.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),e.createObjectStore("indexState",{keyPath:yu}).createIndex("sequenceNumberIndex",wu,{unique:!1}),e.createObjectStore("indexEntries",{keyPath:vu}).createIndex("documentKeyIndex",Iu,{unique:!1})}):s}Ks(t){let n=0;return t.store("remoteDocuments").Z((e,t)=>{n+=bc(t)}).next(()=>{var e={byteSize:n};return t.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",e)})}qs(n){const e=n.store("mutationQueues"),r=n.store("mutations");return e.W().next(e=>xr.forEach(e,t=>{var e=IDBKeyRange.bound([t.userId,-1],[t.userId,t.lastAcknowledgedBatchId]);return r.W("userMutationsIndex",e).next(e=>xr.forEach(e,e=>{Bs(e.userId===t.userId);e=Uu(this.It,e);return Ic(n,t.userId,e).next(()=>{})}))}))}Gs(e){const o=e.store("targetDocuments"),t=e.store("remoteDocuments");return e.store("targetGlobal").get("targetGlobalKey").next(s=>{const i=[];return t.Z((e,t)=>{const n=new ur(e),r=[0,nu(n)];i.push(o.get(r).next(e=>e?xr.resolve():(e=>o.put({targetId:0,path:nu(e),sequenceNumber:s.highestListenSequenceNumber}))(n)))}).next(()=>xr.waitFor(i))})}Qs(e,t){e.createObjectStore("collectionParents",{keyPath:pu});const n=t.store("collectionParents"),r=new hc,s=e=>{if(r.add(e)){const t=e.lastSegment(),r=e.popLast();return n.put({collectionId:t,parent:nu(r)})}};return t.store("remoteDocuments").Z({X:!0},(e,t)=>{const n=new ur(e);return s(n.popLast())}).next(()=>t.store("documentMutations").Z({X:!0},([,e],t)=>{const n=iu(e);return s(n.popLast())}))}js(e){const n=e.store("targets");return n.Z((e,t)=>{t=qu(t),t=Gu(this.It,t);return n.put(t)})}Ws(e,i){const t=i.store("remoteDocuments"),o=[];return t.Z((e,t)=>{const n=i.store("remoteDocumentsV14"),r=((s=t).document?new lr(ur.fromString(s.document.name).popFirst(5)):s.noDocument?lr.fromSegments(s.noDocument.path):s.unknownDocument?lr.fromSegments(s.unknownDocument.path):Ps()).path.toArray();var s={prefixPath:r.slice(0,r.length-2),collectionGroup:r[r.length-2],documentId:r[r.length-1],readTime:t.readTime||[0,0],unknownDocument:t.unknownDocument,noDocument:t.noDocument,document:t.document,hasCommittedMutations:!!t.hasCommittedMutations};o.push(n.put(s))}).next(()=>xr.waitFor(o))}zs(e,s){const t=s.store("mutations"),i=Uc(this.It),o=new sh(ih.Bs,this.It.re);return t.W().next(e=>{const r=new Map;return e.forEach(e=>{var t;let n=null!=(t=r.get(e.userId))?t:fa();Uu(this.It,e).keys().forEach(e=>n=n.add(e)),r.set(e.userId,n)}),xr.forEach(r,(e,t)=>{var t=new Cs(t),n=Yu.oe(this.It,t),r=o.getIndexManager(t),t=Ec.oe(t,this.It,r,o.referenceDelegate);return new Hc(i,t,n,r).recalculateAndSaveOverlaysForDocumentKeys(new Cu(s,Pr.at),e).next()})})}}function ah(e){e.createObjectStore("targetDocuments",{keyPath:mu}).createIndex("documentTargetsIndex",gu,{unique:!0}),e.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",fu,{unique:!0}),e.createObjectStore("targetGlobal")}const uh="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class ch{constructor(e,t,n,r,s,i,o,a,u,c,h=15){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this.Hs=s,this.window=i,this.document=o,this.Js=u,this.Ys=c,this.Xs=h,this.Ss=null,this.Ds=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Zs=null,this.inForeground=!1,this.ti=null,this.ei=null,this.ni=Number.NEGATIVE_INFINITY,this.si=e=>Promise.resolve(),!ch.C())throw new Ks(Gs.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new Vc(this,r),this.ii=t+"main",this.It=new Ou(a),this.ri=new Dr(this.ii,this.Xs,new oh(this.It)),this.Cs=new Dc(this.referenceDelegate,this.It),this.remoteDocumentCache=Uc(this.It),this.Ns=new zu,this.window&&this.window.localStorage?this.oi=this.window.localStorage:(this.oi=null,!1===c&&Os("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.ui().then(()=>{if(this.isPrimary||this.allowTabSynchronization)return this.ci(),this.ai(),this.hi(),this.runTransaction("getHighestListenSequenceNumber","readonly",e=>this.Cs.getHighestSequenceNumber(e));throw new Ks(Gs.FAILED_PRECONDITION,uh)}).then(e=>{this.Ss=new Pr(e,this.Js)}).then(()=>{this.Ds=!0}).catch(e=>(this.ri&&this.ri.close(),Promise.reject(e)))}li(t){return this.si=async e=>{if(this.started)return t(e)},t(this.isPrimary)}setDatabaseDeletedListener(t){this.ri.L(async e=>{null===e.newVersion&&await t()})}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.Hs.enqueueAndForget(async()=>{this.started&&await this.ui()}))}ui(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",t=>lh(t).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next(()=>{if(this.isPrimary)return this.fi(t).next(e=>{e||(this.isPrimary=!1,this.Hs.enqueueRetryable(()=>this.si(!1)))})}).next(()=>this.di(t)).next(e=>this.isPrimary&&!e?this._i(t).next(()=>!1):!!e&&this.wi(t).next(()=>!0))).catch(e=>{if(kr(e))return Ms("IndexedDbPersistence","Failed to extend owner lease: ",e),this.isPrimary;if(this.allowTabSynchronization)return Ms("IndexedDbPersistence","Releasing owner lease after error during lease refresh",e),!1;throw e}).then(e=>{this.isPrimary!==e&&this.Hs.enqueueRetryable(()=>this.si(e)),this.isPrimary=e})}fi(e){return hh(e).get("owner").next(e=>xr.resolve(this.mi(e)))}gi(e){return lh(e).delete(this.clientId)}async yi(){if(this.isPrimary&&!this.pi(this.ni,18e5)){this.ni=Date.now();var e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",e=>{const r=Nu(e,"clientMetadata");return r.W().next(e=>{const t=this.Ii(e,18e5),n=e.filter(e=>-1===t.indexOf(e));return xr.forEach(n,e=>r.delete(e.clientId)).next(()=>n)})}).catch(()=>[]);if(this.oi)for(const t of e)this.oi.removeItem(this.Ti(t.clientId))}}hi(){this.ei=this.Hs.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.ui().then(()=>this.yi()).then(()=>this.hi()))}mi(e){return!!e&&e.ownerId===this.clientId}di(t){return this.Ys?xr.resolve(!0):hh(t).get("owner").next(e=>{if(null!==e&&this.pi(e.leaseTimestampMs,5e3)&&!this.Ei(e.ownerId)){if(this.mi(e)&&this.networkEnabled)return!0;if(!this.mi(e)){if(e.allowTabSynchronization)return!1;throw new Ks(Gs.FAILED_PRECONDITION,uh)}}return!(!this.networkEnabled||!this.inForeground)||lh(t).W().next(e=>void 0===this.Ii(e,5e3).find(e=>{if(this.clientId!==e.clientId){var t=!this.networkEnabled&&e.networkEnabled,n=!this.inForeground&&e.inForeground,e=this.networkEnabled===e.networkEnabled;if(t||n&&e)return!0}return!1}))}).next(e=>(this.isPrimary!==e&&Ms("IndexedDbPersistence",`Client ${e?"is":"is not"} eligible for a primary lease.`),e))}async shutdown(){this.Ds=!1,this.Ai(),this.ei&&(this.ei.cancel(),this.ei=null),this.Ri(),this.bi(),await this.ri.runTransaction("shutdown","readwrite",["owner","clientMetadata"],e=>{const t=new Cu(e,Pr.at);return this._i(t).next(()=>this.gi(t))}),this.ri.close(),this.Pi()}Ii(e,t){return e.filter(e=>this.pi(e.updateTimeMs,t)&&!this.Ei(e.clientId))}vi(){return this.runTransaction("getActiveClients","readonly",e=>lh(e).W().next(e=>this.Ii(e,18e5).map(e=>e.clientId)))}get started(){return this.Ds}getMutationQueue(e,t){return Ec.oe(e,this.It,t,this.referenceDelegate)}getTargetCache(){return this.Cs}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new dc(e,this.It.re.databaseId)}getDocumentOverlayCache(e){return Yu.oe(this.It,e)}getBundleCache(){return this.Ns}runTransaction(t,n,r){Ms("IndexedDbPersistence","Starting transaction:",t);var e="readonly"===n?"readonly":"readwrite",s=15===(s=this.Xs)?Du:14===s?Au:13===s?xu:12===s?_u:11===s?Su:void Ps();let i;return this.ri.runTransaction(t,e,s,e=>(i=new Cu(e,this.Ss?this.Ss.next():Pr.at),"readwrite-primary"===n?this.fi(i).next(e=>!!e||this.di(i)).next(e=>{if(e)return r(i);throw Os(`Failed to obtain primary lease for action '${t}'.`),this.isPrimary=!1,this.Hs.enqueueRetryable(()=>this.si(!1)),new Ks(Gs.FAILED_PRECONDITION,Tr)}).next(e=>this.wi(i).next(()=>e)):this.Vi(i).next(()=>r(i)))).then(e=>(i.raiseOnCommittedEvent(),e))}Vi(e){return hh(e).get("owner").next(e=>{if(null!==e&&this.pi(e.leaseTimestampMs,5e3)&&!this.Ei(e.ownerId)&&!this.mi(e)&&!(this.Ys||this.allowTabSynchronization&&e.allowTabSynchronization))throw new Ks(Gs.FAILED_PRECONDITION,uh)})}wi(e){var t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return hh(e).put("owner",t)}static C(){return Dr.C()}_i(e){const t=hh(e);return t.get("owner").next(e=>this.mi(e)?(Ms("IndexedDbPersistence","Releasing primary lease."),t.delete("owner")):xr.resolve())}pi(e,t){var n=Date.now();return!(e<n-t||n<e&&(Os(`Detected an update time that is in the future: ${e} > `+n),1))}ci(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.ti=()=>{this.Hs.enqueueAndForget(()=>(this.inForeground="visible"===this.document.visibilityState,this.ui()))},this.document.addEventListener("visibilitychange",this.ti),this.inForeground="visible"===this.document.visibilityState)}Ri(){this.ti&&(this.document.removeEventListener("visibilitychange",this.ti),this.ti=null)}ai(){var e;"function"==typeof(null==(e=this.window)?void 0:e.addEventListener)&&(this.Zs=()=>{this.Ai(),h()&&navigator.appVersion.match(/Version\/1[45]/)&&this.Hs.enterRestrictedMode(!0),this.Hs.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.Zs))}bi(){this.Zs&&(this.window.removeEventListener("pagehide",this.Zs),this.Zs=null)}Ei(e){var t;try{var n=null!==(null==(t=this.oi)?void 0:t.getItem(this.Ti(e)));return Ms("IndexedDbPersistence",`Client '${e}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(e){return Os("IndexedDbPersistence","Failed to get zombied client id.",e),!1}}Ai(){if(this.oi)try{this.oi.setItem(this.Ti(this.clientId),String(Date.now()))}catch(e){Os("Failed to set zombie client id.",e)}}Pi(){if(this.oi)try{this.oi.removeItem(this.Ti(this.clientId))}catch(e){}}Ti(e){return`firestore_zombie_${this.persistenceKey}_`+e}}function hh(e){return Nu(e,"owner")}function lh(e){return Nu(e,"clientMetadata")}function dh(e,t){let n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}class fh{constructor(e,t,n,r){this.targetId=e,this.fromCache=t,this.Si=n,this.Di=r}static Ci(e,t){let n=fa(),r=fa();for(const e of t.docChanges)switch(e.type){case 0:n=n.add(e.doc.key);break;case 1:r=r.add(e.doc.key)}return new fh(e,t.fromCache,n,r)}}class mh{constructor(){this.xi=!1}initialize(e,t){this.Ni=e,this.indexManager=t,this.xi=!0}getDocumentsMatchingQuery(t,n,r,s){return this.ki(t,n).next(e=>e||this.Oi(t,n,s,r)).next(e=>e||this.Mi(t,n))}ki(s,i){if(ro(i))return xr.resolve(null);let t=co(i);return this.indexManager.getIndexType(s,t).next(e=>0===e?null:(null!==i.limit&&1===e&&(i=ho(i,null,"F"),t=co(i)),this.indexManager.getDocumentsMatchingTarget(s,t).next(e=>{const r=fa(...e);return this.Ni.getDocuments(s,r).next(n=>this.indexManager.getMinOffset(s,t).next(e=>{var t=this.Fi(i,n);return this.$i(i,t,r,e.readTime)?this.ki(s,ho(i,null,"F")):this.Bi(s,t,i,e)}))})))}Oi(t,n,r,s){return ro(n)||s.isEqual(or.min())?this.Mi(t,n):this.Ni.getDocuments(t,r).next(e=>{e=this.Fi(n,e);return this.$i(n,e,r,s)?this.Mi(t,n):(Rs()<=E.DEBUG&&Ms("QueryEngine","Re-using previous result from %s to execute query: %s",s.toString(),mo(n)),this.Bi(t,e,n,vr(s,-1)))})}Fi(n,e){let r=new $r(yo(n));return e.forEach((e,t)=>{go(n,t)&&(r=r.add(t))}),r}$i(e,t,n,r){if(null===e.limit)return!1;if(n.size!==t.size)return!0;const s="F"===e.limitType?t.last():t.first();return!!s&&(s.hasPendingWrites||0<s.version.compareTo(r))}Mi(e,t){return Rs()<=E.DEBUG&&Ms("QueryEngine","Using full collection scan to execute query:",mo(t)),this.Ni.getDocumentsMatchingQuery(e,t,br.min())}Bi(e,n,t,r){return this.Ni.getDocumentsMatchingQuery(e,t,r).next(t=>(n.forEach(e=>{t=t.insert(e.key,e)}),t))}}class gh{constructor(e,t,n,r){this.persistence=e,this.Li=t,this.It=r,this.Ui=new Gr(nr),this.qi=new na(e=>Oi(e),Vi),this.Ki=new Map,this.Gi=e.getRemoteDocumentCache(),this.Cs=e.getTargetCache(),this.Ns=e.getBundleCache(),this.Qi(n)}Qi(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new Hc(this.Gi,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.Gi.setIndexManager(this.indexManager),this.Li.initialize(this.localDocuments,this.indexManager)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",e=>t.collect(e,this.Ui))}}function ph(e,t,n,r){return new gh(e,t,n,r)}async function yh(e,t){const o=qs(e);return o.persistence.runTransaction("Handle user change","readonly",s=>{let i;return o.mutationQueue.getAllMutationBatches(s).next(e=>(i=e,o.Qi(t),o.mutationQueue.getAllMutationBatches(s))).next(e=>{const t=[],n=[];let r=fa();for(const s of i){t.push(s.batchId);for(const e of s.mutations)r=r.add(e.key)}for(const s of e){n.push(s.batchId);for(const e of s.mutations)r=r.add(e.key)}return o.localDocuments.getDocuments(s,r).next(e=>({ji:e,removedBatchIds:t,addedBatchIds:n}))})})}function wh(e){const t=qs(e);return t.persistence.runTransaction("Get last remote snapshot version","readonly",e=>t.Cs.getLastRemoteSnapshotVersion(e))}function vh(e,i,t){let n=fa(),o=fa();return t.forEach(e=>n=n.add(e)),i.getEntries(e,n).next(r=>{let s=ra();return t.forEach((e,t)=>{const n=r.get(e);t.isFoundDocument()!==n.isFoundDocument()&&(o=o.add(e)),t.isNoDocument()&&t.version.isEqual(or.min())?(i.removeEntry(e,t.readTime),s=s.insert(e,t)):!n.isValidDocument()||0<t.version.compareTo(n.version)||0===t.version.compareTo(n.version)&&n.hasPendingWrites?(i.addEntry(t),s=s.insert(e,t)):Ms("LocalStore","Ignoring outdated watch update for ",e,". Current version:",n.version," Watch version:",t.version)}),{Wi:s,zi:o}})}function Ih(e,t){const n=qs(e);return n.persistence.runTransaction("Get next mutation batch","readonly",e=>(void 0===t&&(t=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(e,t)))}function bh(e,r){const s=qs(e);return s.persistence.runTransaction("Allocate target","readwrite",t=>{let n;return s.Cs.getTargetData(t,r).next(e=>e?(n=e,xr.resolve(n)):s.Cs.allocateTargetId(t).next(e=>(n=new Mu(r,e,0,t.currentSequenceNumber),s.Cs.addTargetData(t,n).next(()=>n))))}).then(e=>{var t=s.Ui.get(e.targetId);return(null===t||0<e.snapshotVersion.compareTo(t.snapshotVersion))&&(s.Ui=s.Ui.insert(e.targetId,e),s.qi.set(r,e.targetId)),e})}async function Eh(e,t,n){const r=qs(e),s=r.Ui.get(t),i=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",i,e=>r.persistence.referenceDelegate.removeTarget(e,s))}catch(e){if(!kr(e))throw e;Ms("LocalStore",`Failed to update sequence numbers for target ${t}: `+e)}r.Ui=r.Ui.remove(t),r.qi.delete(s.target)}function Th(e,n,r){const s=qs(e);let i=or.min(),o=fa();return s.persistence.runTransaction("Execute query","readonly",t=>function(e,t,n){const r=qs(e),s=r.qi.get(n);return void 0!==s?xr.resolve(r.Ui.get(s)):r.Cs.getTargetData(t,n)}(s,t,co(n)).next(e=>{if(e)return i=e.lastLimboFreeSnapshotVersion,s.Cs.getMatchingKeysForTargetId(t,e.targetId).next(e=>{o=e})}).next(()=>s.Li.getDocumentsMatchingQuery(t,n,r?i:or.min(),r?o:fa())).next(e=>(xh(s,po(n),e),{documents:e,Hi:o})))}function Sh(e,t){const n=qs(e),r=qs(n.Cs),s=n.Ui.get(t);return s?Promise.resolve(s.target):n.persistence.runTransaction("Get target data","readonly",e=>r.se(e,t).next(e=>e?e.target:null))}function _h(e,t){const n=qs(e),r=n.Ki.get(t)||or.min();return n.persistence.runTransaction("Get new document changes","readonly",e=>n.Gi.getAllFromCollectionGroup(e,t,vr(r,-1),Number.MAX_SAFE_INTEGER)).then(e=>(xh(n,t,e),e))}function xh(e,t,n){let r=e.Ki.get(t)||or.min();n.forEach((e,t)=>{0<t.readTime.compareTo(r)&&(r=t.readTime)}),e.Ki.set(t,r)}async function Ah(e,n,r=fa()){const s=await bh(e,co(Ku(n.bundledQuery))),i=qs(e);return i.persistence.runTransaction("Save named query","readwrite",e=>{var t=ka(n.readTime);if(0<=s.snapshotVersion.compareTo(t))return i.Ns.saveNamedQuery(e,n);t=s.withResumeToken(Yr.EMPTY_BYTE_STRING,t);return i.Ui=i.Ui.insert(t.targetId,t),i.Cs.updateTargetData(e,t).next(()=>i.Cs.removeMatchingKeysForTargetId(e,s.targetId)).next(()=>i.Cs.addMatchingKeys(e,r,s.targetId)).next(()=>i.Ns.saveNamedQuery(e,n))})}function Dh(e,t){return`firestore_clients_${e}_`+t}function Ch(e,t,n){let r=`firestore_mutations_${e}_`+n;return t.isAuthenticated()&&(r+="_"+t.uid),r}function Nh(e,t){return`firestore_targets_${e}_`+t}class kh{constructor(e,t,n,r){this.user=e,this.batchId=t,this.state=n,this.error=r}static Zi(e,t,n){var r=JSON.parse(n);let s,i="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return i&&r.error&&((i="string"==typeof r.error.message&&"string"==typeof r.error.code)&&(s=new Ks(r.error.code,r.error.message))),i?new kh(e,t,r.state,s):(Os("SharedClientState",`Failed to parse mutation state for ID '${t}': `+n),null)}tr(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class Rh{constructor(e,t,n){this.targetId=e,this.state=t,this.error=n}static Zi(e,t){var n=JSON.parse(t);let r,s="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return s&&n.error&&((s="string"==typeof n.error.message&&"string"==typeof n.error.code)&&(r=new Ks(n.error.code,n.error.message))),s?new Rh(e,n.state,r):(Os("SharedClientState",`Failed to parse target state for ID '${e}': `+t),null)}tr(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class Lh{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static Zi(e,t){var n=JSON.parse(t);let r="object"==typeof n&&n.activeTargetIds instanceof Array,s=ga();for(let e=0;r&&e<n.activeTargetIds.length;++e)r=ui(n.activeTargetIds[e]),s=s.add(n.activeTargetIds[e]);return r?new Lh(e,s):(Os("SharedClientState",`Failed to parse client data for instance '${e}': `+t),null)}}class Mh{constructor(e,t){this.clientId=e,this.onlineState=t}static Zi(e){var t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new Mh(t.clientId,t.onlineState):(Os("SharedClientState","Failed to parse online state: "+e),null)}}class Oh{constructor(){this.activeTargetIds=ga()}er(e){this.activeTargetIds=this.activeTargetIds.add(e)}nr(e){this.activeTargetIds=this.activeTargetIds.delete(e)}tr(){var e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}class Vh{constructor(e,t,n,r,s){this.window=e,this.Hs=t,this.persistenceKey=n,this.sr=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.ir=this.rr.bind(this),this.ur=new Gr(nr),this.started=!1,this.cr=[];e=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.ar=Dh(this.persistenceKey,this.sr),this.hr="firestore_sequence_number_"+this.persistenceKey,this.ur=this.ur.insert(this.sr,new Oh),this.lr=new RegExp(`^firestore_clients_${e}_([^_]*)$`),this.dr=new RegExp(`^firestore_mutations_${e}_(\\d+)(?:_(.*))?$`),this._r=new RegExp(`^firestore_targets_${e}_(\\d+)$`),this.wr="firestore_online_state_"+this.persistenceKey,this.mr="firestore_bundle_loaded_v2_"+this.persistenceKey,this.window.addEventListener("storage",this.ir)}static C(e){return!(!e||!e.localStorage)}async start(){const e=await this.syncEngine.vi();for(const n of e)if(n!==this.sr){const e=this.getItem(Dh(this.persistenceKey,n));var t;!e||(t=Lh.Zi(n,e))&&(this.ur=this.ur.insert(t.clientId,t))}this.gr();const n=this.storage.getItem(this.wr);if(n){const e=this.yr(n);e&&this.pr(e)}for(const e of this.cr)this.rr(e);this.cr=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0}writeSequenceNumber(e){this.setItem(this.hr,JSON.stringify(e))}getAllActiveQueryTargets(){return this.Ir(this.ur)}isActiveQueryTarget(n){let r=!1;return this.ur.forEach((e,t)=>{t.activeTargetIds.has(n)&&(r=!0)}),r}addPendingMutation(e){this.Tr(e,"pending")}updateMutationState(e,t,n){this.Tr(e,t,n),this.Er(e)}addLocalQueryTarget(e){let t="not-current";var n;return this.isActiveQueryTarget(e)&&(n=this.storage.getItem(Nh(this.persistenceKey,e)))&&(n=Rh.Zi(e,n))&&(t=n.state),this.Ar.er(e),this.gr(),t}removeLocalQueryTarget(e){this.Ar.nr(e),this.gr()}isLocalQueryTarget(e){return this.Ar.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(Nh(this.persistenceKey,e))}updateQueryState(e,t,n){this.Rr(e,t,n)}handleUserChange(e,t,n){t.forEach(e=>{this.Er(e)}),this.currentUser=e,n.forEach(e=>{this.addPendingMutation(e)})}setOnlineState(e){this.br(e)}notifyBundleLoaded(e){this.Pr(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.ir),this.removeItem(this.ar),this.started=!1)}getItem(e){var t=this.storage.getItem(e);return Ms("SharedClientState","READ",e,t),t}setItem(e,t){Ms("SharedClientState","SET",e,t),this.storage.setItem(e,t)}removeItem(e){Ms("SharedClientState","REMOVE",e),this.storage.removeItem(e)}rr(e){const n=e;n.storageArea===this.storage&&(Ms("SharedClientState","EVENT",n.key,n.newValue),n.key===this.ar?Os("Received WebStorage notification for local change. Another client might have garbage-collected our state"):this.Hs.enqueueRetryable(async()=>{if(this.started){if(null!==n.key){if(this.lr.test(n.key)){if(null==n.newValue)return e=this.vr(n.key),this.Vr(e,null);var e=this.Sr(n.key,n.newValue);return e?this.Vr(e.clientId,e):void 0}if(this.dr.test(n.key)){if(null!==n.newValue){e=this.Dr(n.key,n.newValue);if(e)return this.Cr(e)}}else if(this._r.test(n.key)){if(null!==n.newValue){e=this.Nr(n.key,n.newValue);if(e)return this.kr(e)}}else if(n.key===this.wr){if(null!==n.newValue){e=this.yr(n.newValue);if(e)return this.pr(e)}}else if(n.key===this.hr){e=function(e){let t=Pr.at;if(null!=e)try{var n=JSON.parse(e);Bs("number"==typeof n),t=n}catch(e){Os("SharedClientState","Failed to read sequence number from WebStorage",e)}return t}(n.newValue);e!==Pr.at&&this.sequenceNumberHandler(e)}else if(n.key===this.mr){const t=this.Or(n.newValue);await Promise.all(t.map(e=>this.syncEngine.Mr(e)))}}}else this.cr.push(n)}))}get Ar(){return this.ur.get(this.sr)}gr(){this.setItem(this.ar,this.Ar.tr())}Tr(e,t,n){const r=new kh(this.currentUser,e,t,n),s=Ch(this.persistenceKey,this.currentUser,e);this.setItem(s,r.tr())}Er(e){e=Ch(this.persistenceKey,this.currentUser,e);this.removeItem(e)}br(e){e={clientId:this.sr,onlineState:e};this.storage.setItem(this.wr,JSON.stringify(e))}Rr(e,t,n){const r=Nh(this.persistenceKey,e),s=new Rh(e,t,n);this.setItem(r,s.tr())}Pr(e){e=JSON.stringify(Array.from(e));this.setItem(this.mr,e)}vr(e){e=this.lr.exec(e);return e?e[1]:null}Sr(e,t){e=this.vr(e);return Lh.Zi(e,t)}Dr(e,t){var e=this.dr.exec(e),n=Number(e[1]),e=void 0!==e[2]?e[2]:null;return kh.Zi(new Cs(e),n,t)}Nr(e,t){e=this._r.exec(e),e=Number(e[1]);return Rh.Zi(e,t)}yr(e){return Mh.Zi(e)}Or(e){return JSON.parse(e)}async Cr(e){if(e.user.uid===this.currentUser.uid)return this.syncEngine.Fr(e.batchId,e.state,e.error);Ms("SharedClientState","Ignoring mutation for non-active user "+e.user.uid)}kr(e){return this.syncEngine.$r(e.targetId,e.state,e.error)}Vr(e,t){const n=t?this.ur.insert(e,t):this.ur.remove(e),r=this.Ir(this.ur),s=this.Ir(n),i=[],o=[];return s.forEach(e=>{r.has(e)||i.push(e)}),r.forEach(e=>{s.has(e)||o.push(e)}),this.syncEngine.Br(i,o).then(()=>{this.ur=n})}pr(e){this.ur.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}Ir(e){let n=ga();return e.forEach((e,t)=>{n=n.unionWith(t.activeTargetIds)}),n}}class Fh{constructor(){this.Lr=new Oh,this.Ur={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e){return this.Lr.er(e),this.Ur[e]||"not-current"}updateQueryState(e,t,n){this.Ur[e]=t}removeLocalQueryTarget(e){this.Lr.nr(e)}isLocalQueryTarget(e){return this.Lr.activeTargetIds.has(e)}clearQueryState(e){delete this.Ur[e]}getAllActiveQueryTargets(){return this.Lr.activeTargetIds}isActiveQueryTarget(e){return this.Lr.activeTargetIds.has(e)}start(){return this.Lr=new Oh,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class Ph{qr(e){}shutdown(){}}class Bh{constructor(){this.Kr=()=>this.Gr(),this.Qr=()=>this.jr(),this.Wr=[],this.zr()}qr(e){this.Wr.push(e)}shutdown(){window.removeEventListener("online",this.Kr),window.removeEventListener("offline",this.Qr)}zr(){window.addEventListener("online",this.Kr),window.addEventListener("offline",this.Qr)}Gr(){Ms("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const e of this.Wr)e(0)}jr(){Ms("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const e of this.Wr)e(1)}static C(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}const Uh={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class qh{constructor(e){this.Hr=e.Hr,this.Jr=e.Jr}Yr(e){this.Xr=e}Zr(e){this.eo=e}onMessage(e){this.no=e}close(){this.Jr()}send(e){this.Hr(e)}so(){this.Xr()}io(e){this.eo(e)}ro(e){this.no(e)}}class Gh extends class{constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;var t=e.ssl?"https":"http";this.oo=t+"://"+e.host,this.uo="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents"}get co(){return!1}ao(t,e,n,r,s){const i=this.ho(t,e);Ms("RestConnection","Sending: ",i,n);e={};return this.lo(e,r,s),this.fo(t,i,e,n).then(e=>(Ms("RestConnection","Received: ",e),e),e=>{throw Vs("RestConnection",t+" failed with error: ",e,"url: ",i,"request:",n),e})}_o(e,t,n,r,s,i){return this.ao(e,t,n,r,s)}lo(n,e,t){n["X-Goog-Api-Client"]="gl-js/ fire/"+Ns,n["Content-Type"]="text/plain",this.databaseInfo.appId&&(n["X-Firebase-GMPID"]=this.databaseInfo.appId),e&&e.headers.forEach((e,t)=>n[t]=e),t&&t.headers.forEach((e,t)=>n[t]=e)}ho(e,t){e=Uh[e];return this.oo+`/v1/${t}:`+e}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams}fo(u,t,n,r){return new Promise((i,o)=>{const a=new As;a.setWithCredentials(!0),a.listenOnce(bs.COMPLETE,()=>{var t,n;try{switch(a.getLastErrorCode()){case Is.NO_ERROR:var e=a.getResponseJson();Ms("Connection","XHR received:",JSON.stringify(e)),i(e);break;case Is.TIMEOUT:Ms("Connection",'RPC "'+u+'" timed out'),o(new Ks(Gs.DEADLINE_EXCEEDED,"Request time out"));break;case Is.HTTP_ERROR:var r=a.getStatus();if(Ms("Connection",'RPC "'+u+'" failed with status:',r,"response text:",a.getResponseText()),0<r){let e=a.getResponseJson();var s=null==(t=e=Array.isArray(e)?e[0]:e)?void 0:t.error;if(s&&s.status&&s.message){n=s.status.toLowerCase().replace(/_/g,"-");const u=0<=Object.values(Gs).indexOf(n)?n:Gs.UNKNOWN;o(new Ks(u,s.message))}else o(new Ks(Gs.UNKNOWN,"Server responded with status "+a.getStatus()))}else o(new Ks(Gs.UNAVAILABLE,"Connection failed."));break;default:Ps()}}finally{Ms("Connection",'RPC "'+u+'" completed.')}});var e=JSON.stringify(r);a.send(t,"POST",e,n,15)})}wo(e,t,n){const r=[this.oo,"/","google.firestore.v1.Firestore","/",e,"/channel"],s=new gs,i=fe(),o={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/`+this.databaseId.database},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling};this.useFetchStreams&&(o.xmlHttpFactory=new _s({})),this.lo(o.initMessageHeaders,t,n),o.encodeInitMessageHeaders=!0;e=r.join("");Ms("Connection","Creating WebChannel: "+e,o);const a=s.createWebChannel(e,o);let u=!1,c=!1;const h=new qh({Hr:e=>{c?Ms("Connection","Not sending because WebChannel is closed:",e):(u||(Ms("Connection","Opening WebChannel transport."),a.open(),u=!0),Ms("Connection","WebChannel sending:",e),a.send(e))},Jr:()=>a.close()}),l=(e,t,n)=>{e.listen(t,e=>{try{n(e)}catch(e){setTimeout(()=>{throw e},0)}})};return l(a,xs.EventType.OPEN,()=>{c||Ms("Connection","WebChannel transport opened.")}),l(a,xs.EventType.CLOSE,()=>{c||(c=!0,Ms("Connection","WebChannel transport closed"),h.io())}),l(a,xs.EventType.ERROR,e=>{c||(c=!0,Vs("Connection","WebChannel transport errored:",e),h.io(new Ks(Gs.UNAVAILABLE,"The operation could not be completed")))}),l(a,xs.EventType.MESSAGE,n=>{if(!c){var n=n.data[0],r=(Bs(!!n),n),r=r.error||(null==(r=r[0])?void 0:r.error);if(r){Ms("Connection","WebChannel received error:",r);const n=r.status;let e=function(e){e=Jo[e];if(void 0!==e)return ea(e)}(n),t=r.message;void 0===e&&(e=Gs.INTERNAL,t="Unknown error status: "+n+" with message "+r.message),c=!0,h.io(new Ks(e,t)),a.close()}else Ms("Connection","WebChannel received:",n),h.ro(n)}}),l(i,Es.STAT_EVENT,e=>{e.stat===Ts?Ms("Connection","Detected buffering proxy"):e.stat===Ss&&Ms("Connection","Detected no buffering proxy")}),setTimeout(()=>{h.so()},0),h}}function Kh(){return"undefined"!=typeof window?window:null}function jh(){return"undefined"!=typeof document?document:null}function $h(e){return new Aa(e,!0)}class Qh{constructor(e,t,n=1e3,r=1.5,s=6e4){this.Hs=e,this.timerId=t,this.mo=n,this.yo=r,this.po=s,this.Io=0,this.To=null,this.Eo=Date.now(),this.reset()}reset(){this.Io=0}Ao(){this.Io=this.po}Ro(e){this.cancel();var t=Math.floor(this.Io+this.bo()),n=Math.max(0,Date.now()-this.Eo),r=Math.max(0,t-n);0<r&&Ms("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.Io} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.To=this.Hs.enqueueAfterDelay(this.timerId,r,()=>(this.Eo=Date.now(),e())),this.Io*=this.yo,this.Io<this.mo&&(this.Io=this.mo),this.Io>this.po&&(this.Io=this.po)}Po(){null!==this.To&&(this.To.skipDelay(),this.To=null)}cancel(){null!==this.To&&(this.To.cancel(),this.To=null)}bo(){return(Math.random()-.5)*this.Io}}class zh{constructor(e,t,n,r,s,i,o,a){this.Hs=e,this.vo=n,this.Vo=r,this.connection=s,this.authCredentialsProvider=i,this.appCheckCredentialsProvider=o,this.listener=a,this.state=0,this.So=0,this.Do=null,this.Co=null,this.stream=null,this.xo=new Qh(e,t)}No(){return 1===this.state||5===this.state||this.ko()}ko(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.Oo()}async stop(){this.No()&&await this.close(0)}Mo(){this.state=0,this.xo.reset()}Fo(){this.ko()&&null===this.Do&&(this.Do=this.Hs.enqueueAfterDelay(this.vo,6e4,()=>this.$o()))}Bo(e){this.Lo(),this.stream.send(e)}async $o(){if(this.ko())return this.close(0)}Lo(){this.Do&&(this.Do.cancel(),this.Do=null)}Uo(){this.Co&&(this.Co.cancel(),this.Co=null)}async close(e,t){this.Lo(),this.Uo(),this.xo.cancel(),this.So++,4!==e?this.xo.reset():t&&t.code===Gs.RESOURCE_EXHAUSTED?(Os(t.toString()),Os("Using maximum backoff delay to prevent overloading the backend."),this.xo.Ao()):t&&t.code===Gs.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.qo(),this.stream.close(),this.stream=null),this.state=e,await this.listener.Zr(t)}qo(){}auth(){this.state=1;const e=this.Ko(this.So),n=this.So;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([e,t])=>{this.So===n&&this.Go(e,t)},t=>{e(()=>{var e=new Ks(Gs.UNKNOWN,"Fetching auth token failed: "+t.message);return this.Qo(e)})})}Go(e,t){const n=this.Ko(this.So);this.stream=this.jo(e,t),this.stream.Yr(()=>{n(()=>(this.state=2,this.Co=this.Hs.enqueueAfterDelay(this.Vo,1e4,()=>(this.ko()&&(this.state=3),Promise.resolve())),this.listener.Yr()))}),this.stream.Zr(e=>{n(()=>this.Qo(e))}),this.stream.onMessage(e=>{n(()=>this.onMessage(e))})}Oo(){this.state=5,this.xo.Ro(async()=>{this.state=0,this.start()})}Qo(e){return Ms("PersistentStream","close with error: "+e),this.stream=null,this.close(4,e)}Ko(t){return e=>{this.Hs.enqueueAndForget(()=>this.So===t?e():(Ms("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class Hh extends zh{constructor(e,t,n,r,s,i){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,r,i),this.It=s}jo(e,t){return this.connection.wo("Listen",e,t)}onMessage(e){this.xo.reset();var t=function(e,t){let n;if("targetChange"in t){t.targetChange;var r="NO_CHANGE"===(r=t.targetChange.targetChangeType||"NO_CHANGE")?0:"ADD"===r?1:"REMOVE"===r?2:"CURRENT"===r?3:"RESET"===r?4:Ps(),s=t.targetChange.targetIds||[],i=(i=t.targetChange.resumeToken,e.gt?(Bs(void 0===i||"string"==typeof i),Yr.fromBase64String(i||"")):(Bs(void 0===i||i instanceof Uint8Array),Yr.fromUint8Array(i||new Uint8Array))),o=t.targetChange.cause,a=o&&(a=void 0===(o=o).code?Gs.UNKNOWN:ea(o.code),new Ks(a,o.message||""));n=new Ia(r,s,i,a||null)}else if("documentChange"in t){t.documentChange;var o=t.documentChange,r=(o.document,o.document.name,o.document.updateTime,Oa(e,o.document.name)),s=ka(o.document.updateTime),i=new Ni({mapValue:{fields:o.document.fields}}),s=Ri.newFoundDocument(r,s,i),u=o.targetIds||[],c=o.removedTargetIds||[];n=new wa(u,c,s.key,s)}else if("documentDelete"in t){t.documentDelete;u=t.documentDelete,c=(u.document,Oa(e,u.document)),s=u.readTime?ka(u.readTime):or.min(),c=Ri.newNoDocument(c,s),s=u.removedTargetIds||[];n=new wa([],s,c.key,c)}else if("documentRemove"in t){t.documentRemove;u=t.documentRemove,s=(u.document,Oa(e,u.document)),c=u.removedTargetIds||[];n=new wa([],c,s,null)}else{if(!("filter"in t))return Ps();{t.filter;const e=t.filter;e.targetId;u=e.count||0,c=new Xo(u),s=e.targetId;n=new va(s,c)}}var a,i,r;return n}(this.It,e),e=function(e){if(!("targetChange"in e))return or.min();e=e.targetChange;return(!e.targetIds||!e.targetIds.length)&&e.readTime?ka(e.readTime):or.min()}(e);return this.listener.Wo(t,e)}zo(e){const t={};t.database=Pa(this.It),t.addTarget=function(e,t){let n;var r=t.target;return(n=Fi(r)?{documents:ja(e,r)}:{query:$a(e,r)}).targetId=t.targetId,0<t.resumeToken.approximateByteSize()?n.resumeToken=Ca(e,t.resumeToken):0<t.snapshotVersion.compareTo(or.min())&&(n.readTime=Da(e,t.snapshotVersion.toTimestamp())),n}(this.It,e);this.It,n=e;var n,e=null==(e=function(){switch(n.purpose){case 0:return null;case 1:return"existence-filter-mismatch";case 2:return"limbo-document";default:return Ps()}}())?null:{"goog-listen-tags":e};e&&(t.labels=e),this.Bo(t)}Ho(e){const t={};t.database=Pa(this.It),t.removeTarget=e,this.Bo(t)}}class Wh extends zh{constructor(e,t,n,r,s,i){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,r,i),this.It=s,this.Jo=!1}get Yo(){return this.Jo}start(){this.Jo=!1,this.lastStreamToken=void 0,super.start()}qo(){this.Jo&&this.Xo([])}jo(e,t){return this.connection.wo("Write",e,t)}onMessage(e){var t,n,r;return Bs(!!e.streamToken),this.lastStreamToken=e.streamToken,this.Jo?(this.xo.reset(),n=e.writeResults,r=e.commitTime,n=n&&0<n.length?(Bs(void 0!==r),n.map(t=>{{var n=r;let e=t.updateTime?ka(t.updateTime):ka(n);return e.isEqual(or.min())&&(e=ka(n)),new Oo(e,t.transformResults||[])}})):[],t=ka(e.commitTime),this.listener.Zo(t,n)):(Bs(!e.writeResults||0===e.writeResults.length),this.Jo=!0,this.listener.tu())}eu(){const e={};e.database=Pa(this.It),this.Bo(e)}Xo(e){e={streamToken:this.lastStreamToken,writes:e.map(e=>Ga(this.It,e))};this.Bo(e)}}class Yh extends class{}{constructor(e,t,n,r){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=n,this.It=r,this.nu=!1}su(){if(this.nu)throw new Ks(Gs.FAILED_PRECONDITION,"The client has already been terminated.")}ao(n,r,s){return this.su(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([e,t])=>this.connection.ao(n,r,s,e,t)).catch(e=>{throw"FirebaseError"===e.name?(e.code===Gs.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new Ks(Gs.UNKNOWN,e.toString())})}_o(n,r,s,i){return this.su(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([e,t])=>this.connection._o(n,r,s,e,t,i)).catch(e=>{throw"FirebaseError"===e.name?(e.code===Gs.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new Ks(Gs.UNKNOWN,e.toString())})}terminate(){this.nu=!0}}class Xh{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.iu=0,this.ru=null,this.ou=!0}uu(){0===this.iu&&(this.cu("Unknown"),this.ru=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.ru=null,this.au("Backend didn't respond within 10 seconds."),this.cu("Offline"),Promise.resolve())))}hu(e){"Online"===this.state?this.cu("Unknown"):(this.iu++,1<=this.iu&&(this.lu(),this.au("Connection failed 1 times. Most recent error: "+e.toString()),this.cu("Offline")))}set(e){this.lu(),this.iu=0,"Online"===e&&(this.ou=!1),this.cu(e)}cu(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}au(e){e=`Could not reach Cloud Firestore backend. ${e}
This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.ou?(Os(e),this.ou=!1):Ms("OnlineStateTracker",e)}lu(){null!==this.ru&&(this.ru.cancel(),this.ru=null)}}class Jh{constructor(e,t,n,r,s){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.fu=[],this.du=new Map,this._u=new Set,this.wu=[],this.mu=s,this.mu.qr(e=>{n.enqueueAndForget(async()=>{if(al(this)){Ms("RemoteStore","Restarting streams for network reachability change.");{var e;const t=qs(this);t._u.add(4),await tl(t),t.gu.set("Unknown"),t._u.delete(4),await Zh(t)}}})}),this.gu=new Xh(n,r)}}async function Zh(e){if(al(e))for(const t of e.wu)await t(!0)}async function tl(e){for(const t of e.wu)await t(!1)}function el(e,t){const n=qs(e);n.du.has(t.targetId)||(n.du.set(t.targetId,t),ol(n)?il(n):_l(n).ko()&&sl(n,t))}function nl(e,t){const n=qs(e),r=_l(n);n.du.delete(t),r.ko()&&rl(n,t),0===n.du.size&&(r.ko()?r.Fo():al(n)&&n.gu.set("Unknown"))}function sl(e,t){e.yu.Mt(t.targetId),_l(e).zo(t)}function rl(e,t){e.yu.Mt(t),_l(e).Ho(t)}function il(t){t.yu=new Ea({getRemoteKeysForTarget:e=>t.remoteSyncer.getRemoteKeysForTarget(e),se:e=>t.du.get(e)||null}),_l(t).start(),t.gu.uu()}function ol(e){return al(e)&&!_l(e).No()&&0<e.du.size}function al(e){return 0===qs(e)._u.size}function ul(e){e.yu=void 0}async function cl(n){n.du.forEach((e,t)=>{sl(n,e)})}async function hl(e,t){ul(e),ol(e)?(e.gu.hu(t),il(e)):e.gu.set("Unknown")}async function ll(e,t,n){if(e.gu.set("Online"),t instanceof Ia&&2===t.state&&t.cause)try{var r=e,s=t.cause;for(const a of t.targetIds)r.du.has(a)&&(await r.remoteSyncer.rejectListen(a,s),r.du.delete(a),r.yu.removeTarget(a))}catch(n){Ms("RemoteStore","Failed to remove targets %s: %s ",t.targetIds.join(","),n),await dl(e,n)}else if(t instanceof wa?e.yu.Gt(t):t instanceof va?e.yu.Yt(t):e.yu.Wt(t),!n.isEqual(or.min()))try{const t=await wh(e.localStore);if(0<=n.compareTo(t)){var i=e,o=n;const u=i.yu.te(o);void await(u.targetChanges.forEach((e,t)=>{if(0<e.resumeToken.approximateByteSize()){const n=i.du.get(t);n&&i.du.set(t,n.withResumeToken(e.resumeToken,o))}}),u.targetMismatches.forEach(e=>{const t=i.du.get(e);t&&(i.du.set(e,t.withResumeToken(Yr.EMPTY_BYTE_STRING,t.snapshotVersion)),rl(i,e),e=new Mu(t.target,e,1,t.sequenceNumber),sl(i,e))}),i.remoteSyncer.applyRemoteEvent(u))}}catch(t){Ms("RemoteStore","Failed to raise snapshot:",t),await dl(e,t)}}async function dl(e,t,n){if(!kr(t))throw t;e._u.add(1),await tl(e),e.gu.set("Offline"),n=n||(()=>wh(e.localStore)),e.asyncQueue.enqueueRetryable(async()=>{Ms("RemoteStore","Retrying IndexedDB access"),await n(),e._u.delete(1),await Zh(e)})}function fl(t,n){return n().catch(e=>dl(t,e,n))}async function ml(e){const t=qs(e),n=xl(t);let r=0<t.fu.length?t.fu[t.fu.length-1].batchId:-1;for(;gl(t);)try{const e=await Ih(t.localStore,r);if(null===e){0===t.fu.length&&n.Fo();break}r=e.batchId,pl(t,e)}catch(e){await dl(t,e)}yl(t)&&wl(t)}function gl(e){return al(e)&&e.fu.length<10}function pl(e,t){e.fu.push(t);const n=xl(e);n.ko()&&n.Yo&&n.Xo(t.mutations)}function yl(e){return al(e)&&!xl(e).No()&&0<e.fu.length}function wl(e){xl(e).start()}async function vl(e){xl(e).eu()}async function Il(e){const t=xl(e);for(const n of e.fu)t.Xo(n.mutations)}async function bl(e,t,n){const r=e.fu.shift(),s=Ru.from(r,t,n);await fl(e,()=>e.remoteSyncer.applySuccessfulWrite(s)),await ml(e)}async function El(e,t){if(t&&xl(e).Yo){var n=e,r=t,s;if(ta(s=r.code)&&s!==Gs.ABORTED){const s=n.fu.shift();xl(n).Mo(),await fl(n,()=>n.remoteSyncer.rejectFailedWrite(s.batchId,r)),await ml(n)}await 0}yl(e)&&wl(e)}async function Tl(e,t){const n=qs(e);n.asyncQueue.verifyOperationInProgress(),Ms("RemoteStore","RemoteStore received new credentials");e=al(n);n._u.add(3),await tl(n),e&&n.gu.set("Unknown"),await n.remoteSyncer.handleCredentialChange(t),n._u.delete(3),await Zh(n)}async function Sl(e,t){const n=qs(e);t?(n._u.delete(2),await Zh(n)):(n._u.add(2),await tl(n),n.gu.set("Unknown"))}function _l(t){return t.pu||(t.pu=function(e,t,n){const r=qs(e);return r.su(),new Hh(t,r.connection,r.authCredentials,r.appCheckCredentials,r.It,n)}(t.datastore,t.asyncQueue,{Yr:cl.bind(null,t),Zr:hl.bind(null,t),Wo:ll.bind(null,t)}),t.wu.push(async e=>{e?(t.pu.Mo(),ol(t)?il(t):t.gu.set("Unknown")):(await t.pu.stop(),ul(t))})),t.pu}function xl(t){return t.Iu||(t.Iu=function(e,t,n){const r=qs(e);return r.su(),new Wh(t,r.connection,r.authCredentials,r.appCheckCredentials,r.It,n)}(t.datastore,t.asyncQueue,{Yr:vl.bind(null,t),Zr:El.bind(null,t),tu:Il.bind(null,t),Zo:bl.bind(null,t)}),t.wu.push(async e=>{e?(t.Iu.Mo(),await ml(t)):(await t.Iu.stop(),0<t.fu.length&&(Ms("RemoteStore",`Stopping write stream with ${t.fu.length} pending writes`),t.fu=[]))})),t.Iu}class Al{constructor(e,t,n,r,s){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=s,this.deferred=new js,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(e=>{})}static createAndSchedule(e,t,n,r,s){const i=Date.now()+n,o=new Al(e,t,i,r,s);return o.start(n),o}start(e){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new Ks(Gs.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then(e=>this.deferred.resolve(e))):Promise.resolve())}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function Dl(e,t){if(Os("AsyncQueue",t+": "+e),kr(e))return new Ks(Gs.UNAVAILABLE,t+": "+e);throw e}class Cl{constructor(n){this.comparator=n?(e,t)=>n(e,t)||lr.comparator(e.key,t.key):(e,t)=>lr.comparator(e.key,t.key),this.keyedMap=oa(),this.sortedSet=new Gr(this.comparator)}static emptySet(e){return new Cl(e.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){e=this.keyedMap.get(e);return e?this.sortedSet.indexOf(e):-1}get size(){return this.sortedSet.size}forEach(n){this.sortedSet.inorderTraversal((e,t)=>(n(e),!1))}add(e){const t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){var t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof Cl))return!1;if(this.size!==e.size)return!1;const t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(!e.isEqual(r))return!1}return!0}toString(){const t=[];return this.forEach(e=>{t.push(e.toString())}),0===t.length?"DocumentSet ()":"DocumentSet (\n  "+t.join("  \n")+"\n)"}copy(e,t){const n=new Cl;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class Nl{constructor(){this.Tu=new Gr(lr.comparator)}track(e){var t=e.doc.key,n=this.Tu.get(t);!n||0!==e.type&&3===n.type?this.Tu=this.Tu.insert(t,e):3===e.type&&1!==n.type?this.Tu=this.Tu.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.Tu=this.Tu.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.Tu=this.Tu.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.Tu=this.Tu.remove(t):1===e.type&&2===n.type?this.Tu=this.Tu.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.Tu=this.Tu.insert(t,{type:2,doc:e.doc}):Ps()}Eu(){const n=[];return this.Tu.inorderTraversal((e,t)=>{n.push(t)}),n}}class kl{constructor(e,t,n,r,s,i,o,a,u){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=s,this.fromCache=i,this.syncStateChanged=o,this.excludesMetadataChanges=a,this.hasCachedResults=u}static fromInitialDocuments(e,t,n,r,s){const i=[];return t.forEach(e=>{i.push({type:0,doc:e})}),new kl(e,t,Cl.emptySet(t),i,n,r,!0,!1,s)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&lo(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;const t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let e=0;e<t.length;e++)if(t[e].type!==n[e].type||!t[e].doc.isEqual(n[e].doc))return!1;return!0}}class Rl{constructor(){this.Au=void 0,this.listeners=[]}}class Ll{constructor(){this.queries=new na(e=>fo(e),lo),this.onlineState="Unknown",this.Ru=new Set}}async function Ml(e,t){const n=qs(e),r=t.query;let s=!1,i=n.queries.get(r);if(i||(s=!0,i=new Rl),s)try{i.Au=await n.onListen(r)}catch(e){const n=Dl(e,`Initialization of query '${mo(t.query)}' failed`);return void t.onError(n)}n.queries.set(r,i),i.listeners.push(t),t.bu(n.onlineState),i.Au&&t.Pu(i.Au)&&Pl(n)}async function Ol(e,t){const n=qs(e),r=t.query;let s=!1;const i=n.queries.get(r);if(i){const e=i.listeners.indexOf(t);0<=e&&(i.listeners.splice(e,1),s=0===i.listeners.length)}if(s)return n.queries.delete(r),n.onUnlisten(r)}function Vl(e,t){const n=qs(e);let r=!1;for(const e of t){const t=e.query,s=n.queries.get(t);if(s){for(const t of s.listeners)t.Pu(e)&&(r=!0);s.Au=e}}r&&Pl(n)}function Fl(e,t,n){const r=qs(e),s=r.queries.get(t);if(s)for(const e of s.listeners)e.onError(n);r.queries.delete(t)}function Pl(e){e.Ru.forEach(e=>{e.next()})}class Bl{constructor(e,t,n){this.query=e,this.vu=t,this.Vu=!1,this.Su=null,this.onlineState="Unknown",this.options=n||{}}Pu(e){if(!this.options.includeMetadataChanges){const t=[];for(const n of e.docChanges)3!==n.type&&t.push(n);e=new kl(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.Vu?this.Du(e)&&(this.vu.next(e),t=!0):this.Cu(e,this.onlineState)&&(this.xu(e),t=!0),this.Su=e,t}onError(e){this.vu.error(e)}bu(e){this.onlineState=e;let t=!1;return this.Su&&!this.Vu&&this.Cu(this.Su,e)&&(this.xu(this.Su),t=!0),t}Cu(e,t){return!e.fromCache||(!this.options.Nu||!("Offline"!==t))&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t)}Du(e){if(0<e.docChanges.length)return!0;var t=this.Su&&this.Su.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}xu(e){e=kl.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.Vu=!0,this.vu.next(e)}}class Ul{constructor(e,t){this.ku=e,this.byteLength=t}Ou(){return"metadata"in this.ku}}class ql{constructor(e){this.It=e}Ji(e){return Oa(this.It,e)}Yi(e){return e.metadata.exists?qa(this.It,e.document,!1):Ri.newNoDocument(this.Ji(e.metadata.name),this.Xi(e.metadata.readTime))}Xi(e){return ka(e)}}class Gl{constructor(e,t,n){this.Mu=e,this.localStore=t,this.It=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=Kl(e)}Fu(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;if(e.ku.namedQuery)this.queries.push(e.ku.namedQuery);else if(e.ku.documentMetadata){this.documents.push({metadata:e.ku.documentMetadata}),e.ku.documentMetadata.exists||++t;const n=ur.fromString(e.ku.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else e.ku.document&&(this.documents[this.documents.length-1].document=e.ku.document,++t);return t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,Object.assign({},this.progress)):null}$u(e){const t=new Map,n=new ql(this.It);for(const s of e)if(s.metadata.queries){const e=n.Ji(s.metadata.name);for(const n of s.metadata.queries){var r=(t.get(n)||fa()).add(e);t.set(n,r)}}return t}async complete(){const e=await async function(e,t,n,r){const s=qs(e);let i=fa(),o=ra();for(const e of n){const n=t.Ji(e.metadata.name),r=(e.document&&(i=i.add(n)),t.Yi(e));r.setReadTime(t.Xi(e.metadata.readTime)),o=o.insert(n,r)}const a=s.Gi.newChangeBuffer({trackRemovals:!0}),u=await bh(s,(e=r,co(so(ur.fromString("__bundle__/docs/"+e)))));return s.persistence.runTransaction("Apply bundle documents","readwrite",t=>vh(t,a,o).next(e=>(a.apply(t),e)).next(e=>s.Cs.removeMatchingKeysForTargetId(t,u.targetId).next(()=>s.Cs.addMatchingKeys(t,i,u.targetId)).next(()=>s.localDocuments.getLocalViewOfDocuments(t,e.Wi,e.zi)).next(()=>e.Wi)))}(this.localStore,new ql(this.It),this.documents,this.Mu.id),t=this.$u(this.documents);for(const e of this.queries)await Ah(this.localStore,e,t.get(e.name));return this.progress.taskState="Success",{progress:this.progress,Bu:this.collectionGroups,Lu:e}}}function Kl(e){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}class jl{constructor(e){this.key=e}}class $l{constructor(e){this.key=e}}class Ql{constructor(e,t){this.query=e,this.Uu=t,this.qu=null,this.hasCachedResults=!1,this.current=!1,this.Ku=fa(),this.mutatedKeys=fa(),this.Gu=yo(e),this.Qu=new Cl(this.Gu)}get ju(){return this.Uu}Wu(e,t){const a=t?t.zu:new Nl,u=(t||this).Qu;let c=(t||this).mutatedKeys,h=u,l=!1;const d="F"===this.query.limitType&&u.size===this.query.limit?u.last():null,f="L"===this.query.limitType&&u.size===this.query.limit?u.first():null;if(e.inorderTraversal((e,t)=>{const n=u.get(e),r=go(this.query,t)?t:null,s=!!n&&this.mutatedKeys.has(n.key),i=!!r&&(r.hasLocalMutations||this.mutatedKeys.has(r.key)&&r.hasCommittedMutations);let o=!1;n&&r?n.data.isEqual(r.data)?s!==i&&(a.track({type:3,doc:r}),o=!0):this.Hu(n,r)||(a.track({type:2,doc:r}),o=!0,(d&&0<this.Gu(r,d)||f&&this.Gu(r,f)<0)&&(l=!0)):!n&&r?(a.track({type:0,doc:r}),o=!0):n&&!r&&(a.track({type:1,doc:n}),o=!0,(d||f)&&(l=!0)),o&&(c=r?(h=h.add(r),i?c.add(e):c.delete(e)):(h=h.delete(e),c.delete(e)))}),null!==this.query.limit)for(;h.size>this.query.limit;){const e="F"===this.query.limitType?h.last():h.first();h=h.delete(e.key),c=c.delete(e.key),a.track({type:1,doc:e})}return{Qu:h,zu:a,$i:l,mutatedKeys:c}}Hu(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n){var r=this.Qu;this.Qu=e.Qu,this.mutatedKeys=e.mutatedKeys;const s=e.zu.Eu();s.sort((e,t)=>function(e,t){var n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return Ps()}};return n(e)-n(t)}(e.type,t.type)||this.Gu(e.doc,t.doc)),this.Ju(n);var t=t?this.Yu():[],i=0===this.Ku.size&&this.current?1:0,o=i!==this.qu;return this.qu=i,0!==s.length||o?{snapshot:new kl(this.query,e.Qu,r,s,e.mutatedKeys,0==i,o,!1,!!n&&0<n.resumeToken.approximateByteSize()),Xu:t}:{Xu:t}}bu(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({Qu:this.Qu,zu:new Nl,mutatedKeys:this.mutatedKeys,$i:!1},!1)):{Xu:[]}}Zu(e){return!this.Uu.has(e)&&!!this.Qu.has(e)&&!this.Qu.get(e).hasLocalMutations}Ju(e){e&&(e.addedDocuments.forEach(e=>this.Uu=this.Uu.add(e)),e.modifiedDocuments.forEach(e=>{}),e.removedDocuments.forEach(e=>this.Uu=this.Uu.delete(e)),this.current=e.current)}Yu(){if(!this.current)return[];const t=this.Ku,n=(this.Ku=fa(),this.Qu.forEach(e=>{this.Zu(e.key)&&(this.Ku=this.Ku.add(e.key))}),[]);return t.forEach(e=>{this.Ku.has(e)||n.push(new $l(e))}),this.Ku.forEach(e=>{t.has(e)||n.push(new jl(e))}),n}tc(e){this.Uu=e.Hi,this.Ku=fa();e=this.Wu(e.documents);return this.applyChanges(e,!0)}ec(){return kl.fromInitialDocuments(this.query,this.Qu,this.mutatedKeys,0===this.qu,this.hasCachedResults)}}class zl{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class Hl{constructor(e){this.key=e,this.nc=!1}}class Wl{constructor(e,t,n,r,s,i){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=r,this.currentUser=s,this.maxConcurrentLimboResolutions=i,this.sc={},this.ic=new na(e=>fo(e),lo),this.rc=new Map,this.oc=new Set,this.uc=new Gr(lr.comparator),this.cc=new Map,this.ac=new Xc,this.hc={},this.lc=new Map,this.fc=Ac.vn(),this.onlineState="Unknown",this.dc=void 0}get isPrimaryClient(){return!0===this.dc}}async function Yl(e,t){const n=Ed(e);let r,s;const i=n.ic.get(t);if(i)r=i.targetId,n.sharedClientState.addLocalQueryTarget(r),s=i.view.ec();else{const e=await bh(n.localStore,co(t)),i=(n.isPrimaryClient&&el(n.remoteStore,e),n.sharedClientState.addLocalQueryTarget(e.targetId));r=e.targetId,s=await Xl(n,t,r,"current"===i,e.resumeToken)}return s}async function Xl(n,e,t,r,s){n._c=(e,s,t)=>async function(e,t,n){let r=t.view.Wu(s);r.$i&&(r=await Th(e.localStore,t.query,!1).then(({documents:e})=>t.view.Wu(e,r)));n=n&&n.targetChanges.get(t.targetId),n=t.view.applyChanges(r,e.isPrimaryClient,n);return ud(e,t.targetId,n.Xu),n.snapshot}(n,e,t);const i=await Th(n.localStore,e,!0),o=new Ql(e,i.Hi),a=o.Wu(i.documents),u=ya.createSynthesizedTargetChangeForCurrentChange(t,r&&"Offline"!==n.onlineState,s),c=o.applyChanges(a,n.isPrimaryClient,u);ud(n,t,c.Xu);r=new zl(e,t,o);return n.ic.set(e,r),n.rc.has(t)?n.rc.get(t).push(e):n.rc.set(t,[e]),c.snapshot}async function Jl(e,t){const n=qs(e),r=n.ic.get(t),s=n.rc.get(r.targetId);if(1<s.length)return n.rc.set(r.targetId,s.filter(e=>!lo(e,t))),void n.ic.delete(t);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(r.targetId),n.sharedClientState.isActiveQueryTarget(r.targetId)||await Eh(n.localStore,r.targetId,!1).then(()=>{n.sharedClientState.clearQueryState(r.targetId),nl(n.remoteStore,r.targetId),od(n,r.targetId)}).catch(_r)):(od(n,r.targetId),await Eh(n.localStore,r.targetId,!0))}async function Zl(e,t){const r=qs(e);try{const e=await function(e,c){const h=qs(e),l=c.snapshotVersion;let d=h.Ui;return h.persistence.runTransaction("Apply remote event","readwrite-primary",a=>{const e=h.Gi.newChangeBuffer({trackRemovals:!0}),u=(d=h.Ui,[]);c.targetChanges.forEach((t,n)=>{const r=d.get(n);if(r){u.push(h.Cs.removeMatchingKeys(a,t.removedDocuments,n).next(()=>h.Cs.addMatchingKeys(a,t.addedDocuments,n)));let e=r.withSequenceNumber(a.currentSequenceNumber);var s,i,o;c.targetMismatches.has(n)?e=e.withResumeToken(Yr.EMPTY_BYTE_STRING,or.min()).withLastLimboFreeSnapshotVersion(or.min()):0<t.resumeToken.approximateByteSize()&&(e=e.withResumeToken(t.resumeToken,l)),d=d.insert(n,e),s=r,i=e,o=t,(0===s.resumeToken.approximateByteSize()||3e8<=i.snapshotVersion.toMicroseconds()-s.snapshotVersion.toMicroseconds()||0<o.addedDocuments.size+o.modifiedDocuments.size+o.removedDocuments.size)&&u.push(h.Cs.updateTargetData(a,e))}});let t=ra(),n=fa();if(c.documentUpdates.forEach(e=>{c.resolvedLimboDocuments.has(e)&&u.push(h.persistence.referenceDelegate.updateLimboDocument(a,e))}),u.push(vh(a,e,c.documentUpdates).next(e=>{t=e.Wi,n=e.zi})),!l.isEqual(or.min())){const c=h.Cs.getLastRemoteSnapshotVersion(a).next(e=>h.Cs.setTargetsMetadata(a,a.currentSequenceNumber,l));u.push(c)}return xr.waitFor(u).next(()=>e.apply(a)).next(()=>h.localDocuments.getLocalViewOfDocuments(a,t,n)).next(()=>t)}).then(e=>(h.Ui=d,e))}(r.localStore,t);t.targetChanges.forEach((e,t)=>{const n=r.cc.get(t);n&&(Bs(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1),0<e.addedDocuments.size?n.nc=!0:0<e.modifiedDocuments.size?Bs(n.nc):0<e.removedDocuments.size&&(Bs(n.nc),n.nc=!1))}),await ld(r,e,t)}catch(e){await _r(e)}}function td(n,r,e){const t=qs(n);if(t.isPrimaryClient&&0===e||!t.isPrimaryClient&&1===e){const n=[];t.ic.forEach((e,t)=>{t=t.view.bu(r);t.snapshot&&n.push(t.snapshot)});{e=t.eventManager;var s=r;const i=qs(e);i.onlineState=s;let n=!1;i.queries.forEach((e,t)=>{for(const e of t.listeners)e.bu(s)&&(n=!0)}),n&&Pl(i)}n.length&&t.sc.Wo(n),t.onlineState=r,t.isPrimaryClient&&t.sharedClientState.setOnlineState(r)}}async function ed(e,t,n){const r=qs(e),s=(r.sharedClientState.updateQueryState(t,"rejected",n),r.cc.get(t)),i=s&&s.key;if(i){let e=new Gr(lr.comparator);e=e.insert(i,Ri.newNoDocument(i,or.min()));const n=fa().add(i),s=new pa(or.min(),new Map,new $r(nr),e,n);await Zl(r,s),r.uc=r.uc.remove(i),r.cc.delete(t),hd(r)}else await Eh(r.localStore,t,!1).then(()=>od(r,t,n)).catch(_r)}async function nd(e,t){const n=qs(e),r=t.batch.batchId;try{const e=await function(e,r){const s=qs(e);return s.persistence.runTransaction("Acknowledge batch","readwrite-primary",e=>{const t=r.batch.keys(),n=s.Gi.newChangeBuffer({trackRemovals:!0});return function(e,t,r,s){const i=r.batch,n=i.keys();let o=xr.resolve();return n.forEach(n=>{o=o.next(()=>s.getEntry(t,n)).next(e=>{var t=r.docVersions.get(n);Bs(null!==t),e.version.compareTo(t)<0&&(i.applyToRemoteDocument(e,r),e.isValidDocument()&&(e.setReadTime(r.commitVersion),s.addEntry(e)))})}),o.next(()=>e.mutationQueue.removeMutationBatch(t,i))}(s,e,r,n).next(()=>n.apply(e)).next(()=>s.mutationQueue.performConsistencyCheck(e)).next(()=>s.documentOverlayCache.removeOverlaysForBatchId(e,t,r.batch.batchId)).next(()=>s.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(t){let n=fa();for(let e=0;e<t.mutationResults.length;++e)0<t.mutationResults[e].transformResults.length&&(n=n.add(t.batch.mutations[e].key));return n}(r))).next(()=>s.localDocuments.getDocuments(e,t))})}(n.localStore,t);id(n,r,null),rd(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await ld(n,e)}catch(e){await _r(e)}}async function sd(e,t,n){const r=qs(e);try{const e=await function(e,r){const s=qs(e);return s.persistence.runTransaction("Reject batch","readwrite-primary",t=>{let n;return s.mutationQueue.lookupMutationBatch(t,r).next(e=>(Bs(null!==e),n=e.keys(),s.mutationQueue.removeMutationBatch(t,e))).next(()=>s.mutationQueue.performConsistencyCheck(t)).next(()=>s.documentOverlayCache.removeOverlaysForBatchId(t,n,r)).next(()=>s.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(t,n)).next(()=>s.localDocuments.getDocuments(t,n))})}(r.localStore,t);id(r,t,n),rd(r,t),r.sharedClientState.updateMutationState(t,"rejected",n),await ld(r,e)}catch(n){await _r(n)}}function rd(e,t){(e.lc.get(t)||[]).forEach(e=>{e.resolve()}),e.lc.delete(t)}function id(e,t,n){const r=qs(e);let s=r.hc[r.currentUser.toKey()];if(s){const e=s.get(t);e&&(n?e.reject(n):e.resolve(),s=s.remove(t)),r.hc[r.currentUser.toKey()]=s}}function od(t,e,n=null){t.sharedClientState.removeLocalQueryTarget(e);for(const r of t.rc.get(e))t.ic.delete(r),n&&t.sc.wc(r,n);t.rc.delete(e),t.isPrimaryClient&&t.ac.ls(e).forEach(e=>{t.ac.containsKey(e)||ad(t,e)})}function ad(e,t){e.oc.delete(t.path.canonicalString());var n=e.uc.get(t);null!==n&&(nl(e.remoteStore,n),e.uc=e.uc.remove(t),e.cc.delete(n),hd(e))}function ud(e,t,n){for(const r of n)r instanceof jl?(e.ac.addReference(r.key,t),cd(e,r)):r instanceof $l?(Ms("SyncEngine","Document no longer in limbo: "+r.key),e.ac.removeReference(r.key,t),e.ac.containsKey(r.key)||ad(e,r.key)):Ps()}function cd(e,t){const n=t.key,r=n.path.canonicalString();e.uc.get(n)||e.oc.has(r)||(Ms("SyncEngine","New document in limbo: "+n),e.oc.add(r),hd(e))}function hd(e){for(;0<e.oc.size&&e.uc.size<e.maxConcurrentLimboResolutions;){var t=e.oc.values().next().value,t=(e.oc.delete(t),new lr(ur.fromString(t))),n=e.fc.next();e.cc.set(n,new Hl(t)),e.uc=e.uc.insert(t,n),el(e.remoteStore,new Mu(co(so(t.path)),n,2,Pr.at))}}async function ld(e,n,r){const s=qs(e),i=[],o=[],a=[];if(!s.ic.isEmpty()){s.ic.forEach((e,t)=>{a.push(s._c(t,n,r).then(e=>{(e||r)&&s.isPrimaryClient&&s.sharedClientState.updateQueryState(t.targetId,null!=e&&e.fromCache?"not-current":"current"),e&&(i.push(e),e=fh.Ci(t.targetId,e),o.push(e))}))}),await Promise.all(a),s.sc.Wo(i);{var t=s.localStore,u=o;const c=qs(t);try{await c.persistence.runTransaction("notifyLocalViewChanges","readwrite",n=>xr.forEach(u,t=>xr.forEach(t.Si,e=>c.persistence.referenceDelegate.addReference(n,t.targetId,e)).next(()=>xr.forEach(t.Di,e=>c.persistence.referenceDelegate.removeReference(n,t.targetId,e)))))}catch(t){if(!kr(t))throw t;Ms("LocalStore","Failed to update sequence numbers: "+t)}for(const t of u){const u=t.targetId;if(!t.fromCache){const t=c.Ui.get(u),h=t.snapshotVersion,l=t.withLastLimboFreeSnapshotVersion(h);c.Ui=c.Ui.insert(u,l)}}}}}async function dd(e,t){const n=qs(e);if(!n.currentUser.isEqual(t)){Ms("SyncEngine","User change. New user:",t.toKey());const e=await yh(n.localStore,t);n.currentUser=t,(r=n).lc.forEach(e=>{e.forEach(e=>{e.reject(new Ks(Gs.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))})}),r.lc.clear(),n.sharedClientState.handleUserChange(t,e.removedBatchIds,e.addedBatchIds),await ld(n,e.ji)}var r}function fd(e,t){const n=qs(e),r=n.cc.get(t);if(r&&r.nc)return fa().add(r.key);{let e=fa();const r=n.rc.get(t);if(!r)return e;for(const t of r){const r=n.ic.get(t);e=e.unionWith(r.view.ju)}return e}}async function md(e,t){var e=qs(e),n=await Th(e.localStore,t.query,!0),n=t.view.tc(n);return e.isPrimaryClient&&ud(e,t.targetId,n.Xu),n}async function gd(e,t){const n=qs(e);return _h(n.localStore,t).then(e=>ld(n,e))}async function pd(e,t,n,r){var e=qs(e),s=await function(e,n){const r=qs(e),s=qs(r.mutationQueue);return r.persistence.runTransaction("Lookup mutation documents","readonly",t=>s.Tn(t,n).next(e=>e?r.localDocuments.getDocuments(t,e):xr.resolve(null)))}(e.localStore,t);null!==s?("pending"===n?await ml(e.remoteStore):"acknowledged"===n||"rejected"===n?(id(e,t,r||null),rd(e,t),n=e.localStore,r=t,qs(qs(n).mutationQueue).An(r)):Ps(),await ld(e,s)):Ms("SyncEngine","Cannot apply mutation batch with id: "+t)}async function yd(t,n,r){const s=qs(t),i=[],o=[];for(const t of n){let e;const r=s.rc.get(t);if(r&&0!==r.length){e=await bh(s.localStore,co(r[0]));for(const t of r){const n=s.ic.get(t),r=await md(s,n);r.snapshot&&o.push(r.snapshot)}}else{const r=await Sh(s.localStore,t);e=await bh(s.localStore,r),await Xl(s,wd(r),t,!1,e.resumeToken)}i.push(e)}return s.sc.Wo(o),i}function wd(e){return no(e.path,e.collectionGroup,e.orderBy,e.filters,e.limit,"F",e.startAt,e.endAt)}function vd(e){e=qs(e);return qs(qs(e.localStore).persistence).vi()}async function Id(e,t,n,r){const s=qs(e);if(s.dc)Ms("SyncEngine","Ignoring unexpected query state notification.");else{var i=s.rc.get(t);if(i&&0<i.length)switch(n){case"current":case"not-current":{const e=await _h(s.localStore,po(i[0])),r=pa.createSynthesizedRemoteEventForCurrentChange(t,"current"===n,Yr.EMPTY_BYTE_STRING);await ld(s,e,r);break}case"rejected":await Eh(s.localStore,t,!0),od(s,t,r);break;default:Ps()}}}async function bd(e,t,n){const r=Ed(e);if(r.dc){for(const e of t)if(r.rc.has(e))Ms("SyncEngine","Adding an already active target "+e);else{const t=await Sh(r.localStore,e),n=await bh(r.localStore,t);await Xl(r,wd(t),n.targetId,!1,n.resumeToken),el(r.remoteStore,n)}for(const e of n)r.rc.has(e)&&await Eh(r.localStore,e,!1).then(()=>{nl(r.remoteStore,e),od(r,e)}).catch(_r)}}function Ed(e){const t=qs(e);return t.remoteStore.remoteSyncer.applyRemoteEvent=Zl.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=fd.bind(null,t),t.remoteStore.remoteSyncer.rejectListen=ed.bind(null,t),t.sc.Wo=Vl.bind(null,t.eventManager),t.sc.wc=Fl.bind(null,t.eventManager),t}function Td(e){const t=qs(e);return t.remoteStore.remoteSyncer.applySuccessfulWrite=nd.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=sd.bind(null,t),t}class Sd{constructor(){this.synchronizeTabs=!1}async initialize(e){this.It=$h(e.databaseInfo.databaseId),this.sharedClientState=this.gc(e),this.persistence=this.yc(e),await this.persistence.start(),this.localStore=this.Ic(e),this.gcScheduler=this.Tc(e,this.localStore),this.indexBackfillerScheduler=this.Ec(e,this.localStore)}Tc(e,t){return null}Ec(e,t){return null}Ic(e){return ph(this.persistence,new mh,e.initialUser,this.It)}yc(e){return new sh(ih.Bs,this.It)}gc(e){return new Fh}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class _d extends Sd{constructor(e,t,n){super(),this.Ac=e,this.cacheSizeBytes=t,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await this.Ac.initialize(this,e),await Td(this.Ac.syncEngine),await ml(this.Ac.remoteStore),await this.persistence.li(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve()))}Ic(e){return ph(this.persistence,new mh,e.initialUser,this.It)}Tc(e,t){var n=this.persistence.referenceDelegate.garbageCollector;return new Mc(n,e.asyncQueue,t)}Ec(e,t){t=new Fr(t,this.persistence);return new Vr(e.asyncQueue,t)}yc(e){var t=dh(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?vc.withCacheSize(this.cacheSizeBytes):vc.DEFAULT;return new ch(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,Kh(),jh(),this.It,this.sharedClientState,!!this.forceOwnership)}gc(e){return new Fh}}class xd extends _d{constructor(e,t){super(e,t,!1),this.Ac=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}async initialize(e){await super.initialize(e);e=this.Ac.syncEngine;this.sharedClientState instanceof Vh&&(this.sharedClientState.syncEngine={Fr:pd.bind(null,e),$r:Id.bind(null,e),Br:bd.bind(null,e),vi:vd.bind(null,e),Mr:gd.bind(null,e)},await this.sharedClientState.start()),await this.persistence.li(async e=>{{var r=this.Ac.syncEngine,t=e;const s=qs(r);if(Ed(s),Td(s),!0===t&&!0!==s.dc){const r=s.sharedClientState.getAllActiveQueryTargets(),t=await yd(s,r.toArray());s.dc=!0,await Sl(s.remoteStore,!0);for(const r of t)el(s.remoteStore,r)}else if(!1===t&&!1!==s.dc){const r=[];let n=Promise.resolve();s.rc.forEach((e,t)=>{s.sharedClientState.isLocalQueryTarget(t)?r.push(t):n=n.then(()=>(od(s,t),Eh(s.localStore,t,!0))),nl(s.remoteStore,t)}),await n,await yd(s,r);{const i=qs(s);i.cc.forEach((e,t)=>{nl(i.remoteStore,t)}),i.ac.fs(),i.cc=new Map,i.uc=new Gr(lr.comparator)}s.dc=!1,await Sl(s.remoteStore,!1)}}await 0,this.gcScheduler&&(e&&!this.gcScheduler.started?this.gcScheduler.start():e||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(e&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():e||this.indexBackfillerScheduler.stop())})}gc(e){var t=Kh();if(!Vh.C(t))throw new Ks(Gs.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");var n=dh(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new Vh(t,e.asyncQueue,n,e.clientId,e.initialUser)}}class Ad{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>td(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=dd.bind(null,this.syncEngine),await Sl(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new Ll}createDatastore(e){var t,n=$h(e.databaseInfo.databaseId),r=(r=e.databaseInfo,new Gh(r));return t=e.authCredentials,e=e.appCheckCredentials,r=r,n=n,new Yh(t,e,r,n)}createRemoteStore(e){return t=this.localStore,n=this.datastore,e=e.asyncQueue,r=e=>td(this.syncEngine,e,0),s=new(Bh.C()?Bh:Ph),new Jh(t,n,e,r,s);var t,n,r,s}createSyncEngine(e,t){{var n=this.localStore,r=this.remoteStore,s=this.eventManager,i=this.sharedClientState,o=e.initialUser;e=e.maxConcurrentLimboResolutions;const a=new Wl(n,r,s,i,o,e);return t&&(a.dc=!0),a}}terminate(){return async function(e){const t=qs(e);Ms("RemoteStore","RemoteStore shutting down."),t._u.add(5),await tl(t),t.mu.shutdown(),t.gu.set("Unknown")}(this.remoteStore)}}function Dd(e,t,n){if(!n)throw new Ks(Gs.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function Cd(e,t,n,r){if(!0===t&&!0===r)throw new Ks(Gs.INVALID_ARGUMENT,e+` and ${n} cannot be used together.`)}function Nd(e){if(!lr.isDocumentKey(e))throw new Ks(Gs.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function kd(e){if(lr.isDocumentKey(e))throw new Ks(Gs.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function Rd(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return 20<e.length&&(e=e.substring(0,20)+"..."),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"!=typeof e)return"function"==typeof e?"a function":Ps();if(e instanceof Array)return"an array";e=(e=e).constructor?e.constructor.name:null;return e?`a custom ${e} object`:"an object"}function Ld(e,t){if((e="_delegate"in e?e._delegate:e)instanceof t)return e;if(t.name===e.constructor.name)throw new Ks(Gs.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");e=Rd(e);throw new Ks(Gs.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: `+e)}function Md(e,t){if(t<=0)throw new Ks(Gs.INVALID_ARGUMENT,`Function ${e}() requires a positive number, but it was: ${t}.`)}const Od=new Map;class Vd{constructor(e){var t;if(void 0===e.host){if(void 0!==e.ssl)throw new Ks(Gs.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=null==(t=e.ssl)||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,void 0===e.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new Ks(Gs.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.useFetchStreams=!!e.useFetchStreams,Cd("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling)}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}class Fd{constructor(e,t,n,r){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=n,this._app=r,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new Vd({}),this._settingsFrozen=!1}get app(){if(this._app)return this._app;throw new Ks(Gs.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available")}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new Ks(Gs.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new Vd(e),void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new Qs;switch(e.type){case"gapi":var t=e.client;return new Ys(t,e.sessionIndex||"0",e.iamToken||null,e.authTokenFactory||null);case"provider":return e.client;default:throw new Ks(Gs.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){{var e=this;const t=Od.get(e);t&&(Ms("ComponentProvider","Removing Datastore"),Od.delete(e),t.terminate())}return Promise.resolve()}}function Pd(n,r,e,s={}){const i=(n=Ld(n,Fd))._getSettings();if("firestore.googleapis.com"!==i.host&&i.host!==r&&Vs("Host has been set in both settings() and useEmulator(), emulator host will be used"),n._setSettings(Object.assign(Object.assign({},i),{host:r+":"+e,ssl:!1})),s.mockUserToken){let e,t;if("string"==typeof s.mockUserToken)e=s.mockUserToken,t=Cs.MOCK_USER;else{e=function(e,t){if(e.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');var t=t||"demo-project",n=e.iat||0,r=e.sub||e.user_id;if(!r)throw new Error("mockUserToken must contain 'sub' or 'user_id' field!");t=Object.assign({iss:"https://securetoken.google.com/"+t,aud:t,iat:n,exp:n+3600,auth_time:n,sub:r,user_id:r,firebase:{sign_in_provider:"custom",identities:{}}},e);return[u(JSON.stringify({alg:"none",type:"JWT"})),u(JSON.stringify(t)),""].join(".")}(s.mockUserToken,null==(r=n._app)?void 0:r.options.projectId);const i=s.mockUserToken.sub||s.mockUserToken.user_id;if(!i)throw new Ks(Gs.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");t=new Cs(i)}n._authCredentials=new zs(new $s(e,t))}}class Bd{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new qd(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new Bd(this.firestore,e,this._key)}}class Ud{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new Ud(this.firestore,e,this._query)}}class qd extends Ud{constructor(e,t,n){super(e,t,so(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const e=this._path.popLast();return e.isEmpty()?null:new Bd(this.firestore,null,new lr(e))}withConverter(e){return new qd(this.firestore,e,this._path)}}function Gd(e,t,...n){if(e=I(e),Dd("collection","path",t),e instanceof Fd)return kd(r=ur.fromString(t,...n)),new qd(e,null,r);if(!(e instanceof Bd||e instanceof qd))throw new Ks(Gs.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");var r=e._path.child(ur.fromString(t,...n));return kd(r),new qd(e.firestore,null,r)}function Kd(e,t){if(e=Ld(e,Fd),Dd("collectionGroup","collection id",t),0<=t.indexOf("/"))throw new Ks(Gs.INVALID_ARGUMENT,`Invalid collection ID '${t}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new Ud(e,null,(e=t,new eo(ur.emptyPath(),e)))}function jd(e,t,...n){if(e=I(e),Dd("doc","path",t=1===arguments.length?er.R():t),e instanceof Fd)return Nd(r=ur.fromString(t,...n)),new Bd(e,null,new lr(r));if(!(e instanceof Bd||e instanceof qd))throw new Ks(Gs.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");var r=e._path.child(ur.fromString(t,...n));return Nd(r),new Bd(e.firestore,e instanceof qd?e.converter:null,new lr(r))}function $d(e,t){return e=I(e),t=I(t),(e instanceof Bd||e instanceof qd)&&(t instanceof Bd||t instanceof qd)&&e.firestore===t.firestore&&e.path===t.path&&e.converter===t.converter}function Qd(e,t){return e=I(e),t=I(t),e instanceof Ud&&t instanceof Ud&&e.firestore===t.firestore&&lo(e._query,t._query)&&e.converter===t.converter}function zd(t,n=10240){let r=0;return{async read(){var e;return r<t.byteLength?(e={value:t.slice(r,r+n),done:!1},r+=n,e):{done:!0}},async cancel(){},releaseLock(){},closed:Promise.reject("unimplemented")}}class Hd{constructor(e){this.observer=e,this.muted=!1}next(e){this.observer.next&&this.Rc(this.observer.next,e)}error(e){this.observer.error?this.Rc(this.observer.error,e):Os("Uncaught Error in snapshot listener:",e.toString())}bc(){this.muted=!0}Rc(e,t){this.muted||setTimeout(()=>{this.muted||e(t)},0)}}class Wd{constructor(e,t){this.Pc=e,this.It=t,this.metadata=new js,this.buffer=new Uint8Array,this.vc=new TextDecoder("utf-8"),this.Vc().then(e=>{e&&e.Ou()?this.metadata.resolve(e.ku.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is
             `+JSON.stringify(null==e?void 0:e.ku)))},e=>this.metadata.reject(e))}close(){return this.Pc.cancel()}async getMetadata(){return this.metadata.promise}async mc(){return await this.getMetadata(),this.Vc()}async Vc(){var e=await this.Sc();if(null===e)return null;var t=this.vc.decode(e),n=Number(t),t=(isNaN(n)&&this.Dc(`length string (${t}) is not valid number`),await this.Cc(n));return new Ul(JSON.parse(t),e.length+n)}xc(){return this.buffer.findIndex(e=>e==="{".charCodeAt(0))}async Sc(){for(;this.xc()<0&&!await this.Nc(););if(0===this.buffer.length)return null;var e=this.xc(),t=(e<0&&this.Dc("Reached the end of bundle when a length string is expected."),this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t}async Cc(e){for(;this.buffer.length<e;)await this.Nc()&&this.Dc("Reached the end of bundle when more is expected.");var t=this.vc.decode(this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t}Dc(e){throw this.Pc.cancel(),new Error("Invalid bundle format: "+e)}async Nc(){var e=await this.Pc.read();if(!e.done){const t=new Uint8Array(this.buffer.length+e.value.length);t.set(this.buffer),t.set(e.value,this.buffer.length),this.buffer=t}return e.done}}class Yd{constructor(){this.type="AggregateField"}}class Xd{constructor(e,t){this._data=t,this.type="AggregateQuerySnapshot",this.query=e}data(){return this._data}}class Jd{constructor(e,t,n){this.query=e,this.datastore=t,this.userDataWriter=n}run(){return async function(e,t){const n=qs(e),r={structuredAggregationQuery:{aggregations:[{count:{},alias:"count_alias"}],structuredQuery:(e=$a(n.It,co(t))).structuredQuery},parent:e.parent},s=r.parent;return n.connection.co||delete r.parent,(await n._o("RunAggregationQuery",s,r,1)).filter(e=>!!e.result).map(e=>e.result.aggregateFields)}(this.datastore,this.query._query).then(e=>{Bs(void 0!==e[0]);e=Object.entries(e[0]).filter(([e])=>"count_alias"===e).map(([,e])=>this.userDataWriter.convertValue(e))[0];return Bs("number"==typeof e),Promise.resolve(new Xd(this.query,{count:e}))})}}class Zd{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}async lookup(e){if(this.ensureCommitNotCalled(),0<this.mutations.length)throw new Ks(Gs.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");const t=await async function(e,t){const o=qs(e),n=Pa(o.It)+"/documents",r={documents:t.map(e=>Ma(o.It,e))},s=await o._o("BatchGetDocuments",n,r,t.length),a=new Map,i=(s.forEach(e=>{n=o.It;const t="found"in(e=e)?(r=n,Bs(!!(s=e).found),s.found.name,s.found.updateTime,r=Oa(r,s.found.name),i=ka(s.found.updateTime),s=new Ni({mapValue:{fields:s.found.fields}}),Ri.newFoundDocument(r,i,s)):"missing"in e?(r=n,Bs(!!(i=e).missing),Bs(!!i.readTime),r=Oa(r,i.missing),i=ka(i.readTime),Ri.newNoDocument(r,i)):Ps();var n,r,s,i;a.set(t.key.toString(),t)}),[]);return t.forEach(e=>{e=a.get(e.toString());Bs(!!e),i.push(e)}),i}(this.datastore,e);return t.forEach(e=>this.recordVersion(e)),t}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(e){this.lastWriteError=e}this.writtenDocs.add(e.toString())}delete(e){this.write(new Wo(e,this.precondition(e))),this.writtenDocs.add(e.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;const t=this.readVersions;this.mutations.forEach(e=>{t.delete(e.key.toString())}),t.forEach((e,t)=>{t=lr.fromPath(t);this.mutations.push(new Yo(t,this.precondition(t)))});{var e=this.datastore,n=this.mutations;const r=qs(e),s=Pa(r.It)+"/documents",i={writes:n.map(e=>Ga(r.It,e))};await r.ao("Commit",s,i)}await 0,this.committed=!0}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw Ps();t=or.min()}var n=this.readVersions.get(e.key.toString());if(n){if(!t.isEqual(n))throw new Ks(Gs.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){const t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?t.isEqual(or.min())?Vo.exists(!1):Vo.updateTime(t):Vo.none()}preconditionForUpdate(e){const t=this.readVersions.get(e.toString());if(this.writtenDocs.has(e.toString())||!t)return Vo.exists(!0);if(t.isEqual(or.min()))throw new Ks(Gs.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return Vo.updateTime(t)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}}class tf{constructor(e,t,n,r,s){this.asyncQueue=e,this.datastore=t,this.options=n,this.updateFunction=r,this.deferred=s,this.kc=n.maxAttempts,this.xo=new Qh(this.asyncQueue,"transaction_retry")}run(){--this.kc,this.Oc()}Oc(){this.xo.Ro(async()=>{const t=new Zd(this.datastore),e=this.Mc(t);e&&e.then(e=>{this.asyncQueue.enqueueAndForget(()=>t.commit().then(()=>{this.deferred.resolve(e)}).catch(e=>{this.Fc(e)}))}).catch(e=>{this.Fc(e)})})}Mc(e){try{var t=this.updateFunction(e);return!oi(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}}Fc(e){0<this.kc&&this.$c(e)?(--this.kc,this.asyncQueue.enqueueAndForget(()=>(this.Oc(),Promise.resolve()))):this.deferred.reject(e)}$c(e){return"FirebaseError"===e.name&&("aborted"===(e=e.code)||"failed-precondition"===e||"already-exists"===e||!ta(e))}}class ef{constructor(e,t,n,r){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=r,this.user=Cs.UNAUTHENTICATED,this.clientId=er.R(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,async e=>{Ms("FirestoreClient","Received user=",e.uid),await this.authCredentialListener(e),this.user=e}),this.appCheckCredentials.start(n,e=>(Ms("FirestoreClient","Received new app check token=",e),this.appCheckCredentialListener(e,this.user)))}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new Ks(Gs.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const n=new js;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this.onlineComponents&&await this.onlineComponents.terminate(),this.offlineComponents&&await this.offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),n.resolve()}catch(e){var t=Dl(e,"Failed to shutdown persistence");n.reject(t)}}),n.promise}}async function nf(e,t){e.asyncQueue.verifyOperationInProgress(),Ms("FirestoreClient","Initializing OfflineComponentProvider");var n=await e.getConfiguration();await t.initialize(n);let r=n.initialUser;e.setCredentialChangeListener(async e=>{r.isEqual(e)||(await yh(t.localStore,e),r=e)}),t.persistence.setDatabaseDeletedListener(()=>e.terminate()),e.offlineComponents=t}async function sf(e,n){e.asyncQueue.verifyOperationInProgress();var t=await rf(e),r=(Ms("FirestoreClient","Initializing OnlineComponentProvider"),await e.getConfiguration());await n.initialize(t,r),e.setCredentialChangeListener(e=>Tl(n.remoteStore,e)),e.setAppCheckTokenChangeListener((e,t)=>Tl(n.remoteStore,t)),e.onlineComponents=n}async function rf(e){return e.offlineComponents||(Ms("FirestoreClient","Using default OfflineComponentProvider"),await nf(e,new Sd)),e.offlineComponents}async function of(e){return e.onlineComponents||(Ms("FirestoreClient","Using default OnlineComponentProvider"),await sf(e,new Ad)),e.onlineComponents}function af(e){return rf(e).then(e=>e.persistence)}function uf(e){return rf(e).then(e=>e.localStore)}function cf(e){return of(e).then(e=>e.remoteStore)}function hf(e){return of(e).then(e=>e.syncEngine)}function lf(e){return of(e).then(e=>e.datastore)}async function df(e){const t=await of(e),n=t.eventManager;return n.onListen=Yl.bind(null,t.syncEngine),n.onUnlisten=Jl.bind(null,t.syncEngine),n}function ff(t,u,c={}){const h=new js;return t.asyncQueue.enqueueAndForget(async()=>{{var n=await df(t),r=t.asyncQueue,s=u,i=c,o=h;const e=new Hd({next:e=>{r.enqueueAndForget(()=>Ol(n,a));var t=e.docs.has(s);!t&&e.fromCache?o.reject(new Ks(Gs.UNAVAILABLE,"Failed to get document because the client is offline.")):t&&e.fromCache&&i&&"server"===i.source?o.reject(new Ks(Gs.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):o.resolve(e)},error:e=>o.reject(e)}),a=new Bl(so(s.path),e,{includeMetadataChanges:!0,Nu:!0});return Ml(n,a)}}),h.promise}function mf(a,u,c={}){const h=new js;return a.asyncQueue.enqueueAndForget(async()=>{{var t=await df(a),n=a.asyncQueue,e=u,r=c,s=h;const i=new Hd({next:e=>{n.enqueueAndForget(()=>Ol(t,o)),e.fromCache&&"server"===r.source?s.reject(new Ks(Gs.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):s.resolve(e)},error:e=>s.reject(e)}),o=new Bl(e,i,{includeMetadataChanges:!0,Nu:!0});return Ml(t,o)}}),h.promise}function gf(s,e,t,i){t=t,e=$h(e),t=function(e){if(e instanceof Uint8Array)return zd(e,void 0);if(e instanceof ArrayBuffer)return zd(new Uint8Array(e),void 0);if(e instanceof ReadableStream)return e.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(t="string"==typeof t?(new TextEncoder).encode(t):t),e=e;const o=new Wd(t,e);s.asyncQueue.enqueueAndForget(async()=>{{var e=await hf(s),t=o,n=i;const r=qs(e);return void async function(t,n,r){try{var s=await n.getMetadata();if(await function(e,t){const n=qs(e),r=ka(t.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",e=>n.Ns.getBundleMetadata(e,t.id)).then(e=>!!e&&0<=e.createTime.compareTo(r))}(t.localStore,s))return await n.close(),r._completeWith({taskState:"Success",documentsLoaded:s.totalDocuments,bytesLoaded:s.totalBytes,totalDocuments:s.totalDocuments,totalBytes:s.totalBytes}),Promise.resolve(new Set);r._updateProgress(Kl(s));const o=new Gl(s,t.localStore,n.It);let e=await n.mc();for(;e;){const t=await o.Fu(e);t&&r._updateProgress(t),e=await n.mc()}var i=await o.complete();return await ld(t,i.Lu,void 0),await function(e,t){const n=qs(e);return n.persistence.runTransaction("Save bundle","readwrite",e=>n.Ns.saveBundleMetadata(e,t))}(t.localStore,s),r._completeWith(i.progress),Promise.resolve(i.Bu)}catch(t){return Vs("SyncEngine","Loading bundle failed with "+t),r._failWith(t),Promise.resolve(new Set)}}(r,t,n).then(e=>{r.sharedClientState.notifyBundleLoaded(e)})}})}class pf{constructor(){this.Bc=Promise.resolve(),this.Lc=[],this.Uc=!1,this.qc=[],this.Kc=null,this.Gc=!1,this.Qc=!1,this.jc=[],this.xo=new Qh(this,"async_queue_retry"),this.Wc=()=>{var e=jh();e&&Ms("AsyncQueue","Visibility state changed to "+e.visibilityState),this.xo.Po()};const e=jh();e&&"function"==typeof e.addEventListener&&e.addEventListener("visibilitychange",this.Wc)}get isShuttingDown(){return this.Uc}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.zc(),this.Hc(e)}enterRestrictedMode(e){if(!this.Uc){this.Uc=!0,this.Qc=e||!1;const t=jh();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.Wc)}}enqueue(e){if(this.zc(),this.Uc)return new Promise(()=>{});const t=new js;return this.Hc(()=>this.Uc&&this.Qc?Promise.resolve():(e().then(t.resolve,t.reject),t.promise)).then(()=>t.promise)}enqueueRetryable(e){this.enqueueAndForget(()=>(this.Lc.push(e),this.Jc()))}async Jc(){if(0!==this.Lc.length){try{await this.Lc[0](),this.Lc.shift(),this.xo.reset()}catch(e){if(!kr(e))throw e;Ms("AsyncQueue","Operation failed with retryable error: "+e)}0<this.Lc.length&&this.xo.Ro(()=>this.Jc())}}Hc(e){var t=this.Bc.then(()=>(this.Gc=!0,e().catch(e=>{throw this.Kc=e,this.Gc=!1,Os("INTERNAL UNHANDLED ERROR: ",function(e){let t=e.message||"";return t=e.stack?e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack:t}(e)),e}).then(e=>(this.Gc=!1,e))));return this.Bc=t}enqueueAfterDelay(e,t,n){this.zc(),-1<this.jc.indexOf(e)&&(t=0);e=Al.createAndSchedule(this,e,t,n,e=>this.Yc(e));return this.qc.push(e),e}zc(){this.Kc&&Ps()}verifyOperationInProgress(){}async Xc(){for(var e;await(e=this.Bc),e!==this.Bc;);}Zc(e){for(const t of this.qc)if(t.timerId===e)return!0;return!1}ta(t){return this.Xc().then(()=>{this.qc.sort((e,t)=>e.targetTimeMs-t.targetTimeMs);for(const e of this.qc)if(e.skipDelay(),"all"!==t&&e.timerId===t)break;return this.Xc()})}ea(e){this.jc.push(e)}Yc(e){e=this.qc.indexOf(e);this.qc.splice(e,1)}}function yf(e){var t=e;if("object"!=typeof t||null===t)return!1;var n=t;for(const t of["next","error","complete"])if(t in n&&"function"==typeof n[t])return!0;return!1}class wf{constructor(){this._progressObserver={},this._taskCompletionResolver=new js,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,n){this._progressObserver={next:e,error:t,complete:n}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}}const vf=-1;class If extends Fd{constructor(e,t,n,r){super(e,t,n,r),this.type="firestore",this._queue=new pf,this._persistenceKey=(null==r?void 0:r.name)||"[DEFAULT]"}_terminate(){return this._firestoreClient||Sf(this),this._firestoreClient.terminate()}}function bf(e,t,r){r=r||"(default)";const s=n(e,"firestore");if(s.isInitialized(r)){const e=s.getImmediate({identifier:r});if(w(s.getOptions(r),t))return e;throw new Ks(Gs.FAILED_PRECONDITION,"initializeFirestore() has already been called with different options. To avoid this error, call initializeFirestore() with the same options as when it was originally called, or call getFirestore() to return the already initialized instance.")}if(void 0!==t.cacheSizeBytes&&-1!==t.cacheSizeBytes&&t.cacheSizeBytes<1048576)throw new Ks(Gs.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");return s.initialize({options:t,instanceIdentifier:r})}function Ef(e,t){var r="object"==typeof e?e:s(),e="string"==typeof e?e:t||"(default)",t=n(r,"firestore").getImmediate({identifier:e});if(!t._initialized){const e=m("firestore");e&&Pd(t,...e)}return t}function Tf(e){return e._firestoreClient||Sf(e),e._firestoreClient.verifyNotTerminated(),e._firestoreClient}function Sf(e){var t,n,r=e._freezeSettings(),s=(s=e._databaseId,t=(null==(t=e._app)?void 0:t.options.appId)||"",n=e._persistenceKey,r=r,new ri(s,t,n,r.host,r.ssl,r.experimentalForceLongPolling,r.experimentalAutoDetectLongPolling,r.useFetchStreams));e._firestoreClient=new ef(e._authCredentials,e._appCheckCredentials,e._queue,s)}function _f(e,t){Of(e=Ld(e,If));var n=Tf(e),e=e._freezeSettings(),r=new Ad;return Af(n,r,new _d(r,e.cacheSizeBytes,null==t?void 0:t.forceOwnership))}function xf(e){Of(e=Ld(e,If));var t=Tf(e),e=e._freezeSettings(),n=new Ad;return Af(t,n,new xd(n,e.cacheSizeBytes))}function Af(e,n,r){const s=new js;return e.asyncQueue.enqueue(async()=>{try{await nf(e,r),await sf(e,n),s.resolve()}catch(e){const n=e;if(!("FirebaseError"===(t=n).name?t.code===Gs.FAILED_PRECONDITION||t.code===Gs.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||22===t.code||20===t.code||11===t.code))throw n;Vs("Error enabling offline persistence. Falling back to persistence disabled: "+n),s.reject(n)}var t}).then(()=>s.promise)}function Df(e){if(e._initialized&&!e._terminated)throw new Ks(Gs.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const t=new js;return e._queue.enqueueAndForgetEvenWhileRestricted(async()=>{try{await async function(e){if(!Dr.C())return Promise.resolve();e+="main";await Dr.delete(e)}(dh(e._databaseId,e._persistenceKey)),t.resolve()}catch(e){t.reject(e)}}),t.promise}function Cf(e){{var t=Tf(e=Ld(e,If));const n=new js;return t.asyncQueue.enqueueAndForget(async()=>async function(e,t){const n=qs(e);al(n.remoteStore)||Ms("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const e=await function(){const t=qs(n.localStore);return t.persistence.runTransaction("Get highest unacknowledged batch id","readonly",e=>t.mutationQueue.getHighestUnacknowledgedBatchId(e))}();if(-1===e)return void t.resolve();const r=n.lc.get(e)||[];r.push(t),n.lc.set(e,r)}catch(e){const n=Dl(e,"Initialization of waitForPendingWrites() operation failed");t.reject(n)}}(await hf(t),n)),n.promise}}function Nf(e){return(r=Tf(e=Ld(e,If))).asyncQueue.enqueue(async()=>{const e=await af(r),t=await cf(r);e.setNetworkEnabled(!0);{const n=qs(t);return n._u.delete(0),Zh(n)}});var r}function kf(e){return(n=Tf(e=Ld(e,If))).asyncQueue.enqueue(async()=>{const e=await af(n),t=await cf(n);return e.setNetworkEnabled(!1),async function(){const e=qs(t);e._u.add(0),await tl(e),e.gu.set("Offline")}()});var n}function Rf(e){return r(e.app,"firestore",e._databaseId.database),e._delete()}function Lf(e,t){var n=Tf(e=Ld(e,If)),r=new wf;return gf(n,e._databaseId,t,r),r}function Mf(t,e){return r=Tf(t=Ld(t,If)),s=e,r.asyncQueue.enqueue(async()=>{{var e=await uf(r),t=s;const n=qs(e);return n.persistence.runTransaction("Get named query","readonly",e=>n.Ns.getNamedQuery(e,t))}}).then(e=>e?new Ud(t,null,e.query):null);var r,s}function Of(e){if(e._initialized||e._terminated)throw new Ks(Gs.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class Vf{constructor(e){this._byteString=e}static fromBase64String(e){try{return new Vf(Yr.fromBase64String(e))}catch(e){throw new Ks(Gs.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new Vf(Yr.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class Ff{constructor(...t){for(let e=0;e<t.length;++e)if(0===t[e].length)throw new Ks(Gs.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new hr(t)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}function Pf(){return new Ff("__name__")}class Bf{constructor(e){this._methodName=e}}class Uf{constructor(e,t){if(!isFinite(e)||e<-90||90<e)throw new Ks(Gs.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||180<t)throw new Ks(Gs.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return nr(this._lat,e._lat)||nr(this._long,e._long)}}const qf=/^__.*__$/;class Gf{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new $o(e,this.data,this.fieldMask,t,this.fieldTransforms):new jo(e,this.data,t,this.fieldTransforms)}}class Kf{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new $o(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function jf(e){switch(e){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw Ps()}}class $f{constructor(e,t,n,r,s,i){this.settings=e,this.databaseId=t,this.It=n,this.ignoreUndefinedProperties=r,void 0===s&&this.na(),this.fieldTransforms=s||[],this.fieldMask=i||[]}get path(){return this.settings.path}get sa(){return this.settings.sa}ia(e){return new $f(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.It,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}ra(e){var t;const n=null==(t=this.path)?void 0:t.child(e),r=this.ia({path:n,oa:!1});return r.ua(e),r}ca(e){var t;const n=null==(t=this.path)?void 0:t.child(e),r=this.ia({path:n,oa:!1});return r.na(),r}aa(e){return this.ia({path:void 0,oa:!0})}ha(e){return lm(e,this.settings.methodName,this.settings.la||!1,this.path,this.settings.fa)}contains(t){return void 0!==this.fieldMask.find(e=>t.isPrefixOf(e))||void 0!==this.fieldTransforms.find(e=>t.isPrefixOf(e.field))}na(){if(this.path)for(let e=0;e<this.path.length;e++)this.ua(this.path.get(e))}ua(e){if(0===e.length)throw this.ha("Document fields must not be empty");if(jf(this.sa)&&qf.test(e))throw this.ha('Document fields cannot begin and end with "__"')}}class Qf{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.It=n||$h(e)}da(e,t,n,r=!1){return new $f({sa:e,methodName:t,fa:n,path:hr.emptyPath(),oa:!1,la:r},this.databaseId,this.It,this.ignoreUndefinedProperties)}}function zf(e){var t=e._freezeSettings(),n=$h(e._databaseId);return new Qf(e._databaseId,!!t.ignoreUndefinedProperties,n)}function Hf(e,t,n,r,s,i={}){const o=e.da(i.merge||i.mergeFields?2:0,t,n,s);am("Data must be an object, but it was:",o,r);e=im(r,o);let a,u;if(i.merge)a=new Hr(o.fieldMask),u=o.fieldTransforms;else if(i.mergeFields){const e=[];for(const r of i.mergeFields){const s=um(t,r,n);if(!o.contains(s))throw new Ks(Gs.INVALID_ARGUMENT,`Field '${s}' is specified in your field mask but missing from your input data.`);dm(e,s)||e.push(s)}a=new Hr(e),u=o.fieldTransforms.filter(e=>a.covers(e.field))}else a=null,u=o.fieldTransforms;return new Gf(new Ni(e),a,u)}class Wf extends Bf{_toFieldTransform(e){if(2!==e.sa)throw 1===e.sa?e.ha(this._methodName+"() can only appear at the top level of your update data"):e.ha(this._methodName+"() cannot be used with set() unless you pass {merge:true}");return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof Wf}}function Yf(e,t,n){return new $f({sa:3,fa:t.settings.fa,methodName:e._methodName,oa:n},t.databaseId,t.It,t.ignoreUndefinedProperties)}class Xf extends Bf{_toFieldTransform(e){return new Mo(e.path,new xo)}isEqual(e){return e instanceof Xf}}class Jf extends Bf{constructor(e,t){super(e),this._a=t}_toFieldTransform(e){const t=Yf(this,e,!0),n=this._a.map(e=>rm(e,t)),r=new Ao(n);return new Mo(e.path,r)}isEqual(e){return this===e}}class Zf extends Bf{constructor(e,t){super(e),this._a=t}_toFieldTransform(e){const t=Yf(this,e,!0),n=this._a.map(e=>rm(e,t)),r=new Co(n);return new Mo(e.path,r)}isEqual(e){return this===e}}class tm extends Bf{constructor(e,t){super(e),this.wa=t}_toFieldTransform(e){var t=new ko(e.It,bo(e.It,this.wa));return new Mo(e.path,t)}isEqual(e){return this===e}}function em(e,s,i,t){const o=e.da(1,s,i),a=(am("Data must be an object, but it was:",o,t),[]),u=Ni.empty();Ur(t,(e,t)=>{var n=hm(s,e,i),r=(t=I(t),o.ca(n));if(t instanceof Wf)a.push(n);else{const e=rm(t,r);null!=e&&(a.push(n),u.set(n,e))}});e=new Hr(a);return new Kf(u,e,o.fieldTransforms)}function nm(t,n,e,r,s,i){const o=t.da(1,n,e),a=[um(n,r,e)],u=[s];if(i.length%2!=0)throw new Ks(Gs.INVALID_ARGUMENT,`Function ${n}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let e=0;e<i.length;e+=2)a.push(um(n,i[e])),u.push(i[e+1]);const c=[],h=Ni.empty();for(let e=a.length-1;0<=e;--e)if(!dm(c,a[e])){const n=a[e];var l=I(u[e]);const r=o.ca(n);if(l instanceof Wf)c.push(n);else{const t=rm(l,r);null!=t&&(c.push(n),h.set(n,t))}}t=new Hr(c);return new Kf(h,t,o.fieldTransforms)}function sm(e,t,n,r=!1){return rm(n,e.da(r?4:3,t))}function rm(e,n){if(om(e=I(e)))return am("Unsupported field value:",n,e),im(e,n);if(e instanceof Bf){{var t=e;var r=n;if(!jf(r.sa))throw r.ha(t._methodName+"() can only be used with update() and set()");if(!r.path)throw r.ha(t._methodName+"() is not currently supported inside arrays");t=t._toFieldTransform(r);t&&r.fieldTransforms.push(t)}return null}if(void 0===e&&n.ignoreUndefinedProperties)return null;if(n.path&&n.fieldMask.push(n.path),e instanceof Array){if(n.settings.oa&&4!==n.sa)throw n.ha("Nested arrays are not supported");{var s=n;const o=[];let t=0;for(const a of e){let e=rm(a,s.aa(t));null==e&&(e={nullValue:"NULL_VALUE"}),o.push(e),t++}return{arrayValue:{values:o}}}}var i,r=0,t=n;if(null===(r=I(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof r)return bo(t.It,r);if("boolean"==typeof r)return{booleanValue:r};if("string"==typeof r)return{stringValue:r};if(r instanceof Date)return i=ir.fromDate(r),{timestampValue:Da(t.It,i)};if(r instanceof ir)return i=new ir(r.seconds,1e3*Math.floor(r.nanoseconds/1e3)),{timestampValue:Da(t.It,i)};if(r instanceof Uf)return{geoPointValue:{latitude:r.latitude,longitude:r.longitude}};if(r instanceof Vf)return{bytesValue:Ca(t.It,r._byteString)};if(r instanceof Bd){const u=t.databaseId,c=r.firestore._databaseId;if(c.isEqual(u))return{referenceValue:Ra(r.firestore._databaseId||t.databaseId,r._key.path)};throw t.ha(`Document reference is for database ${c.projectId}/${c.database} but should be for database ${u.projectId}/`+u.database)}throw t.ha("Unsupported field value: "+Rd(r))}function im(e,n){const r={};return qr(e)?n.path&&0<n.path.length&&n.fieldMask.push(n.path):Ur(e,(e,t)=>{t=rm(t,n.ra(e));null!=t&&(r[e]=t)}),{mapValue:{fields:r}}}function om(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof ir||e instanceof Uf||e instanceof Vf||e instanceof Bd||e instanceof Bf)}function am(e,t,n){var r;if(!om(n)||("object"!=typeof(r=n)||null===r||Object.getPrototypeOf(r)!==Object.prototype&&null!==Object.getPrototypeOf(r)))throw"an object"===(r=Rd(n))?t.ha(e+" a custom object"):t.ha(e+" "+r)}function um(e,t,n){if((t=I(t))instanceof Ff)return t._internalPath;if("string"==typeof t)return hm(e,t);throw lm("Field path arguments must be of type string or ",e,!1,void 0,n)}const cm=new RegExp("[~\\*/\\[\\]]");function hm(t,n,r){if(0<=n.search(cm))throw lm(`Invalid field path (${n}). Paths must not contain '~', '*', '/', '[', or ']'`,t,!1,void 0,r);try{return new Ff(...n.split("."))._internalPath}catch(e){throw lm(`Invalid field path (${n}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,t,!1,void 0,r)}}function lm(e,t,n,r,s){var i=r&&!r.isEmpty(),o=void 0!==s;let a=`Function ${t}() called with invalid data`,u=(n&&(a+=" (via `toFirestore()`)"),a+=". ","");return(i||o)&&(u+=" (found",i&&(u+=" in field "+r),o&&(u+=" in document "+s),u+=")"),new Ks(Gs.INVALID_ARGUMENT,a+e+u)}function dm(e,t){return e.some(e=>e.isEqual(t))}class fm{constructor(e,t,n,r,s){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=r,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new Bd(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){var e;if(this._document)return this._converter?(e=new mm(this._firestore,this._userDataWriter,this._key,this._document,null),this._converter.fromFirestore(e)):this._userDataWriter.convertValue(this._document.data.value)}get(e){if(this._document){e=this._document.data.field(gm("DocumentSnapshot.get",e));if(null!==e)return this._userDataWriter.convertValue(e)}}}class mm extends fm{data(){return super.data()}}function gm(e,t){return"string"==typeof t?hm(e,t):(t instanceof Ff?t:t._delegate)._internalPath}function pm(e){if("L"===e.limitType&&0===e.explicitOrderBy.length)throw new Ks(Gs.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class ym{}function wm(e,...t){for(const n of t)e=n._apply(e);return e}class vm extends ym{constructor(e,t,n){super(),this.ma=e,this.ga=t,this.ya=n,this.type="where"}_apply(e){var t=zf(e.firestore),t=function(e,t,n,r,s,i){let o;if(r.isKeyField()){if("array-contains"===s||"array-contains-any"===s)throw new Ks(Gs.INVALID_ARGUMENT,`Invalid Query. You can't perform '${s}' queries on documentId().`);if("in"===s||"not-in"===s){Mm(i,s);const u=[];for(const t of i)u.push(Lm(n,e,t));o={arrayValue:{values:u}}}else o=Lm(n,e,i)}else"in"!==s&&"not-in"!==s&&"array-contains-any"!==s||Mm(i,s),o=sm(t,"where",i,"in"===s||"not-in"===s);t=qi.create(r,s,o);{i=e;var a=t;if(a.dt()){const c=oo(i);if(null!==c&&!c.isEqual(a.field))throw new Ks(Gs.INVALID_ARGUMENT,`Invalid query. All where filters with an inequality (<, <=, !=, not-in, >, or >=) must be on the same field. But you have inequality filters on '${c.toString()}' and '${a.field.toString()}'`);r=io(i);null!==r&&Om(i,a.field,r)}const c=function(e,t){for(const n of e.filters)if(0<=t.indexOf(n.op))return n.op;return null}(i,function(){switch(a.op){case"!=":return["!=","not-in"];case"array-contains":return["array-contains","array-contains-any","not-in"];case"in":return["array-contains-any","in","not-in"];case"array-contains-any":return["array-contains","array-contains-any","in","not-in"];case"not-in":return["array-contains","array-contains-any","in","not-in","!="];default:return[]}}());if(null!==c)throw c===a.op?new Ks(Gs.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${a.op.toString()}' filter.`):new Ks(Gs.INVALID_ARGUMENT,`Invalid query. You cannot use '${a.op.toString()}' filters with '${c.toString()}' filters.`)}return t}(e._query,t,e.firestore._databaseId,this.ma,this.ga,this.ya);return new Ud(e.firestore,e.converter,(e=e._query,t=e.filters.concat([t]),new eo(e.path,e.collectionGroup,e.explicitOrderBy.slice(),t,e.limit,e.limitType,e.startAt,e.endAt)))}}function Im(e,t,n){e=gm("where",e);return new vm(e,t,n)}class bm extends ym{constructor(e,t){super(),this.ma=e,this.pa=t,this.type="orderBy"}_apply(e){var t=function(e,t,n){if(null!==e.startAt)throw new Ks(Gs.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new Ks(Gs.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");var r,t=new Xi(t,n);return n=t,null===io(e=e)&&null!==(r=oo(e))&&Om(e,r,n.field),t}(e._query,this.ma,this.pa);return new Ud(e.firestore,e.converter,(e=e._query,t=e.explicitOrderBy.concat([t]),new eo(e.path,e.collectionGroup,t,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)))}}function Em(e,t="asc"){e=gm("orderBy",e);return new bm(e,t)}class Tm extends ym{constructor(e,t,n){super(),this.type=e,this.Ia=t,this.Ta=n}_apply(e){return new Ud(e.firestore,e.converter,ho(e._query,this.Ia,this.Ta))}}function Sm(e){return Md("limit",e),new Tm("limit",e,"F")}function _m(e){return Md("limitToLast",e),new Tm("limitToLast",e,"L")}class xm extends ym{constructor(e,t,n){super(),this.type=e,this.Ea=t,this.Aa=n}_apply(e){var t=Rm(e,this.type,this.Ea,this.Aa);return new Ud(e.firestore,e.converter,(e=e._query,t=t,new eo(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,t,e.endAt)))}}function Am(...e){return new xm("startAt",e,!0)}function Dm(...e){return new xm("startAfter",e,!1)}class Cm extends ym{constructor(e,t,n){super(),this.type=e,this.Ea=t,this.Aa=n}_apply(e){var t=Rm(e,this.type,this.Ea,this.Aa);return new Ud(e.firestore,e.converter,(e=e._query,t=t,new eo(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,t)))}}function Nm(...e){return new Cm("endBefore",e,!1)}function km(...e){return new Cm("endAt",e,!0)}function Rm(e,t,n,r){if(n[0]=I(n[0]),n[0]instanceof fm){var s=e._query,i=e.firestore._databaseId,o=t,a=n[0]._document,u=r;if(!a)throw new Ks(Gs.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${o}().`);const m=[];for(const o of uo(s))if(o.field.isKeyField())m.push(wi(i,a.key));else{const s=a.data.field(o.field);if(ei(s))throw new Ks(Gs.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+o.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===s){const s=o.field.canonicalString();throw new Ks(Gs.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${s}' (used as the orderBy) does not exist.`)}m.push(s)}return new Yi(m,u)}o=zf(e.firestore);{var c=e._query,h=e.firestore._databaseId,l=o,d=t,f=n,s=r;const g=c.explicitOrderBy;if(f.length>g.length)throw new Ks(Gs.INVALID_ARGUMENT,`Too many arguments provided to ${d}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const p=[];for(let e=0;e<f.length;e++){const y=f[e];if(g[e].field.isKeyField()){if("string"!=typeof y)throw new Ks(Gs.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${d}(), but got a `+typeof y);if(!ao(c)&&-1!==y.indexOf("/"))throw new Ks(Gs.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${d}() must be a plain document ID, but '${y}' contains a slash.`);const l=c.path.child(ur.fromString(y));if(!lr.isDocumentKey(l))throw new Ks(Gs.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${d}() must result in a valid document path, but '${l}' is not because it contains an odd number of segments.`);const f=new lr(l);p.push(wi(h,f))}else{const c=sm(l,d,y);p.push(c)}}return new Yi(p,s)}}function Lm(e,t,n){if("string"==typeof(n=I(n))){if(""===n)throw new Ks(Gs.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!ao(t)&&-1!==n.indexOf("/"))throw new Ks(Gs.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);t=t.path.child(ur.fromString(n));if(lr.isDocumentKey(t))return wi(e,new lr(t));throw new Ks(Gs.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${t}' is not because it has an odd number of segments (${t.length}).`)}if(n instanceof Bd)return wi(e,n._key);throw new Ks(Gs.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${Rd(n)}.`)}function Mm(e,t){if(!Array.isArray(e)||0===e.length)throw new Ks(Gs.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`);if(10<e.length)throw new Ks(Gs.INVALID_ARGUMENT,`Invalid Query. '${t.toString()}' filters support a maximum of 10 elements in the value array.`)}function Om(e,t,n){if(!n.isEqual(t))throw new Ks(Gs.INVALID_ARGUMENT,`Invalid query. You have a where filter with an inequality (<, <=, !=, not-in, >, or >=) on field '${t.toString()}' and so you must also use '${t.toString()}' as your first argument to orderBy(), but your first orderBy() is on field '${n.toString()}' instead.`)}class Vm{convertValue(e,t="none"){switch(li(e)){case 0:return null;case 1:return e.booleanValue;case 2:return Zr(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(ti(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 10:return this.convertObject(e.mapValue,t);default:throw Ps()}}convertObject(e,n){const r={};return Ur(e.fields,(e,t)=>{r[e]=this.convertValue(t,n)}),r}convertGeoPoint(e){return new Uf(Zr(e.latitude),Zr(e.longitude))}convertArray(e,t){return(e.values||[]).map(e=>this.convertValue(e,t))}convertServerTimestamp(e,t){switch(t){case"previous":var n=ni(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(si(e));default:return null}}convertTimestamp(e){e=Jr(e);return new ir(e.seconds,e.nanos)}convertDocumentKey(e,t){const n=ur.fromString(e),r=(Bs(eu(n)),new ii(n.get(1),n.get(3))),s=new lr(n.popFirst(5));return r.isEqual(t)||Os(`Document ${s} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),s}}function Fm(e,t,n){return e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t}class Pm extends Vm{constructor(e){super(),this.firestore=e}convertBytes(e){return new Vf(e)}convertReference(e){e=this.convertDocumentKey(e,this.firestore._databaseId);return new Bd(this.firestore,null,e)}}class Bm{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class Um extends fm{constructor(e,t,n,r,s,i){super(e,t,n,r,i),this._firestore=e,this._firestoreImpl=e,this.metadata=s}exists(){return super.exists()}data(e={}){var t;if(this._document)return this._converter?(t=new qm(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null),this._converter.fromFirestore(t,e)):this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}get(e,t={}){if(this._document){e=this._document.data.field(gm("DocumentSnapshot.get",e));if(null!==e)return this._userDataWriter.convertValue(e,t.serverTimestamps)}}}class qm extends Um{data(e={}){return super.data(e)}}class Gm{constructor(e,t,n,r){this._firestore=e,this._userDataWriter=t,this._snapshot=r,this.metadata=new Bm(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const t=[];return this.forEach(e=>t.push(e)),t}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(t,n){this._snapshot.docs.forEach(e=>{t.call(n,new qm(this._firestore,this._userDataWriter,e.key,e,new Bm(this._snapshot.mutatedKeys.has(e.key),this._snapshot.fromCache),this.query.converter))})}docChanges(e={}){e=!!e.includeMetadataChanges;if(e&&this._snapshot.excludesMetadataChanges)throw new Ks(Gs.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=function(i,t){if(i._snapshot.oldDocs.isEmpty()){let n=0;return i._snapshot.docChanges.map(e=>{var t=new qm(i._firestore,i._userDataWriter,e.doc.key,e.doc,new Bm(i._snapshot.mutatedKeys.has(e.doc.key),i._snapshot.fromCache),i.query.converter);return e.doc,{type:"added",doc:t,oldIndex:-1,newIndex:n++}})}{let s=i._snapshot.oldDocs;return i._snapshot.docChanges.filter(e=>t||3!==e.type).map(e=>{var t=new qm(i._firestore,i._userDataWriter,e.doc.key,e.doc,new Bm(i._snapshot.mutatedKeys.has(e.doc.key),i._snapshot.fromCache),i.query.converter);let n=-1,r=-1;return 0!==e.type&&(n=s.indexOf(e.doc.key),s=s.delete(e.doc.key)),1!==e.type&&(s=s.add(e.doc),r=s.indexOf(e.doc.key)),{type:Km(e.type),doc:t,oldIndex:n,newIndex:r}})}}(this,e),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges}}function Km(e){switch(e){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return Ps()}}function jm(e,t){return e instanceof Um&&t instanceof Um?e._firestore===t._firestore&&e._key.isEqual(t._key)&&(null===e._document?null===t._document:e._document.isEqual(t._document))&&e._converter===t._converter:e instanceof Gm&&t instanceof Gm&&e._firestore===t._firestore&&Qd(e.query,t.query)&&e.metadata.isEqual(t.metadata)&&e._snapshot.isEqual(t._snapshot)}function $m(t){t=Ld(t,Bd);const n=Ld(t.firestore,If);return ff(Tf(n),t._key).then(e=>ig(n,t,e))}class Qm extends Vm{constructor(e){super(),this.firestore=e}convertBytes(e){return new Vf(e)}convertReference(e){e=this.convertDocumentKey(e,this.firestore._databaseId);return new Bd(this.firestore,null,e)}}function zm(t){t=Ld(t,Bd);const n=Ld(t.firestore,If),e=Tf(n),r=new Qm(n);return function(e,t){const n=new js;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t,n){try{const r=await function(t){const n=qs(e);return n.persistence.runTransaction("read document","readonly",e=>n.localDocuments.getDocument(e,t))}(t);r.isFoundDocument()?n.resolve(r):r.isNoDocument()?n.resolve(null):n.reject(new Ks(Gs.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(e){t=Dl(e,`Failed to get document '${t} from cache`);n.reject(t)}}(await uf(e),t,n)),n.promise}(e,t._key).then(e=>new Um(n,r,t._key,e,new Bm(null!==e&&e.hasLocalMutations,!0),t.converter))}function Hm(t){t=Ld(t,Bd);const n=Ld(t.firestore,If);return ff(Tf(n),t._key,{source:"server"}).then(e=>ig(n,t,e))}function Wm(t){t=Ld(t,Ud);const n=Ld(t.firestore,If),e=Tf(n),r=new Qm(n);return pm(t._query),mf(e,t._query).then(e=>new Gm(n,r,t,e))}function Ym(t){t=Ld(t,Ud);const n=Ld(t.firestore,If),e=Tf(n),r=new Qm(n);return function(e,t){const n=new js;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t,n){try{const r=await Th(e,t,!0),s=new Ql(t,r.Hi),i=s.Wu(r.documents),o=s.applyChanges(i,!1);n.resolve(o.snapshot)}catch(e){t=Dl(e,`Failed to execute query '${t} against cache`);n.reject(t)}}(await uf(e),t,n)),n.promise}(e,t._query).then(e=>new Gm(n,r,t,e))}function Xm(t){t=Ld(t,Ud);const n=Ld(t.firestore,If),e=Tf(n),r=new Qm(n);return mf(e,t._query,{source:"server"}).then(e=>new Gm(n,r,t,e))}function Jm(e,t,n){e=Ld(e,Bd);var r=Ld(e.firestore,If),t=Fm(e.converter,t,n);return rg(r,[Hf(zf(r),"setDoc",e._key,t,null!==e.converter,n).toMutation(e._key,Vo.none())])}function Zm(e,t,n,...r){e=Ld(e,Bd);var s=Ld(e.firestore,If),i=zf(s);let o;return rg(s,[(o="string"==typeof(t=I(t))||t instanceof Ff?nm(i,"updateDoc",e._key,t,n,r):em(i,"updateDoc",e._key,t)).toMutation(e._key,Vo.exists(!0))])}function tg(e){return rg(Ld(e.firestore,If),[new Wo(e._key,Vo.none())])}function eg(e,t){const n=Ld(e.firestore,If),r=jd(e),s=Fm(e.converter,t);return rg(n,[Hf(zf(e.firestore),"addDoc",r._key,s,null!==e.converter,{}).toMutation(r._key,Vo.exists(!1))]).then(()=>r)}function ng(t,...n){t=I(t);let e={includeMetadataChanges:!1},r=0;"object"!=typeof n[r]||yf(n[r])||(e=n[r],r++);var s={includeMetadataChanges:e.includeMetadataChanges};if(yf(n[r])){const t=n[r];n[r]=null==(h=t.next)?void 0:h.bind(t),n[r+1]=null==(c=t.error)?void 0:c.bind(t),n[r+2]=null==(h=t.complete)?void 0:h.bind(t)}let i,o,a;if(t instanceof Bd)o=Ld(t.firestore,If),a=so(t._key.path),i={next:e=>{n[r]&&n[r](ig(o,t,e))},error:n[r+1],complete:n[r+2]};else{const h=Ld(t,Ud),c=(o=Ld(h.firestore,If),a=h._query,new Qm(o));i={next:e=>{n[r]&&n[r](new Gm(o,c,h,e))},error:n[r+1],complete:n[r+2]},pm(t._query)}{var u=Tf(o),c=a,h=s;s=i;const l=new Hd(s),d=new Bl(c,l,h);return u.asyncQueue.enqueueAndForget(async()=>Ml(await df(u),d)),()=>{l.bc(),u.asyncQueue.enqueueAndForget(async()=>Ol(await df(u),d))}}}function sg(e,t){{var n=Tf(e=Ld(e,If));e=yf(t)?t:{next:t};const r=new Hd(e);return n.asyncQueue.enqueueAndForget(async()=>{var e=await df(n),t=r;qs(e).Ru.add(t),t.next()}),()=>{r.bc(),n.asyncQueue.enqueueAndForget(async()=>{var e=await df(n),t=r;qs(e).Ru.delete(t)})}}}function rg(e,t){{var n=Tf(e),r=t;const s=new js;return n.asyncQueue.enqueueAndForget(async()=>async function(t,e,n){const r=Td(t);try{const t=await function(e,s){const i=qs(e),o=ir.now(),a=s.reduce((e,t)=>e.add(t.key),fa());let u,c;return i.persistence.runTransaction("Locally write mutations","readwrite",n=>{let t=ra(),r=fa();return i.Gi.getEntries(n,a).next(e=>{(t=e).forEach((e,t)=>{t.isValidDocument()||(r=r.add(e))})}).next(()=>i.localDocuments.getOverlayedDocuments(n,t)).next(e=>{u=e;const t=[];for(const n of s){const s=Go(n,u.get(n.key).overlayedDocument);null!=s&&t.push(new $o(n.key,s,ki(s.value.mapValue),Vo.exists(!0)))}return i.mutationQueue.addMutationBatch(n,o,t,s)}).next(e=>{var t=(c=e).applyToLocalDocumentSet(u,r);return i.documentOverlayCache.saveOverlays(n,e.batchId,t)})}).then(()=>({batchId:c.batchId,changes:aa(u)}))}(r.localStore,e);r.sharedClientState.addPendingMutation(t.batchId);{var s=r;var i=t.batchId;var o=n;let e=s.hc[s.currentUser.toKey()];e=(e=e||new Gr(nr)).insert(i,o),s.hc[s.currentUser.toKey()]=e}await ld(r,t.changes),await ml(r.remoteStore)}catch(t){const e=Dl(t,"Failed to persist write");n.reject(e)}}(await hf(n),r,s)),s.promise}}function ig(e,t,n){var r=n.docs.get(t._key),s=new Qm(e);return new Um(e,s,t._key,r,new Bm(n.hasPendingWrites,n.fromCache),t.converter)}function og(e,t){return Qd(e.query,t.query)&&w(e.data(),t.data())}function ag(e){var t=Ld(e.firestore,If);{var n=Tf(t),r=e,s=new Qm(t);const i=new js;return n.asyncQueue.enqueueAndForget(async()=>{try{var e,t;al(await cf(n))?(e=await lf(n),t=new Jd(r,e,s).run(),i.resolve(t)):i.reject(new Ks(Gs.UNAVAILABLE,"Failed to get count result because the client is offline."))}catch(e){i.reject(e)}}),i.promise}}const ug={maxAttempts:5};class cg{constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=zf(e)}set(e,t,n){this._verifyNotCommitted();const r=hg(e,this._firestore),s=Fm(r.converter,t,n),i=Hf(this._dataReader,"WriteBatch.set",r._key,s,null!==r.converter,n);return this._mutations.push(i.toMutation(r._key,Vo.none())),this}update(e,t,n,...r){this._verifyNotCommitted();e=hg(e,this._firestore);let s;return s="string"==typeof(t=I(t))||t instanceof Ff?nm(this._dataReader,"WriteBatch.update",e._key,t,n,r):em(this._dataReader,"WriteBatch.update",e._key,t),this._mutations.push(s.toMutation(e._key,Vo.exists(!0))),this}delete(e){this._verifyNotCommitted();e=hg(e,this._firestore);return this._mutations=this._mutations.concat(new Wo(e._key,Vo.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,0<this._mutations.length?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new Ks(Gs.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function hg(e,t){if((e=I(e)).firestore!==t)throw new Ks(Gs.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}class lg extends class{constructor(e,t){this._firestore=e,this._transaction=t,this._dataReader=zf(e)}get(e){const n=hg(e,this._firestore),r=new Pm(this._firestore);return this._transaction.lookup([n._key]).then(e=>{if(!e||1!==e.length)return Ps();const t=e[0];if(t.isFoundDocument())return new fm(this._firestore,r,t.key,t,n.converter);if(t.isNoDocument())return new fm(this._firestore,r,n._key,null,n.converter);throw Ps()})}set(e,t,n){e=hg(e,this._firestore),t=Fm(e.converter,t,n),t=Hf(this._dataReader,"Transaction.set",e._key,t,null!==e.converter,n);return this._transaction.set(e._key,t),this}update(e,t,n,...r){e=hg(e,this._firestore),n="string"==typeof(t=I(t))||t instanceof Ff?nm(this._dataReader,"Transaction.update",e._key,t,n,r):em(this._dataReader,"Transaction.update",e._key,t);return this._transaction.update(e._key,n),this}delete(e){e=hg(e,this._firestore);return this._transaction.delete(e._key),this}}{constructor(e,t){super(e,t),this._firestore=e}get(e){const t=hg(e,this._firestore),n=new Qm(this._firestore);return super.get(e).then(e=>new Um(this._firestore,n,t._key,e._document,new Bm(!1,!1),t.converter))}}function dg(t,n,e){t=Ld(t,If);e=Object.assign(Object.assign({},ug),e);if(e.maxAttempts<1)throw new Ks(Gs.INVALID_ARGUMENT,"Max attempts must be at least 1");{var r=Tf(t),s=e=>n(new lg(t,e)),i=e;const o=new js;return r.asyncQueue.enqueueAndForget(async()=>{var e=await lf(r);new tf(r.asyncQueue,e,i,s,o).run()}),o.promise}}function fg(){return new Wf("deleteField")}function mg(){return new Xf("serverTimestamp")}function gg(...e){return new Jf("arrayUnion",e)}function pg(...e){return new Zf("arrayRemove",e)}function yg(e){return new tm("increment",e)}function wg(t){return Tf(t=Ld(t,If)),new cg(t,e=>rg(t,e))}function vg(e,t){var n,e=Tf(e=Ld(e,If));if(null==(n=e.offlineComponents)||!n.indexBackfillerScheduler)return Vs("Cannot enable indexes when persistence is disabled"),Promise.resolve();const r=function(e){const t="string"==typeof e?function(e){var t;try{return JSON.parse(e)}catch(e){throw new Ks(Gs.INVALID_ARGUMENT,"Failed to parse JSON: "+(null==(t=e)?void 0:t.message))}}(e):e,n=[];if(Array.isArray(t.indexes))for(const e of t.indexes){const t=Ig(e,"collectionGroup"),r=[];if(Array.isArray(e.fields))for(const t of e.fields){const e=hm("setIndexConfiguration",Ig(t,"fieldPath"));"CONTAINS"===t.arrayConfig?r.push(new pr(e,2)):"ASCENDING"===t.order?r.push(new pr(e,0)):"DESCENDING"===t.order&&r.push(new pr(e,1))}n.push(new dr(dr.UNKNOWN_ID,t,r,wr.empty()))}return n}(t);return uf(e).then(e=>async function(e,l){const t=qs(e),d=t.indexManager,f=[];return t.persistence.runTransaction("Configure indexes","readwrite",h=>d.getFieldIndexes(h).next(n=>{{var r=n,s=l,i=gr,o=e=>{f.push(d.addFieldIndex(h,e))},a=e=>{f.push(d.deleteFieldIndex(h,e))};r=[...r],s=[...s],r.sort(i),s.sort(i);const u=r.length,c=s.length;let e=0,t=0;for(;e<c&&t<u;){const u=i(r[t],s[e]);u<0?a(r[t++]):0<u?o(s[e++]):(e++,t++)}for(;e<c;)o(s[e++]);for(;t<u;)a(r[t++]);return}}).next(()=>xr.waitFor(f)))}(e,r))}function Ig(e,t){if("string"!=typeof e[t])throw new Ks(Gs.INVALID_ARGUMENT,"Missing string value for: "+t);return e[t]}Ns=i,t(new b("firestore",(e,{instanceIdentifier:t,options:n})=>{const r=e.getProvider("app").getImmediate(),s=new If(new Hs(e.getProvider("auth-internal")),new Js(e.getProvider("app-check-internal")),function(e,t){if(Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))return new ii(e.options.projectId,t);throw new Ks(Gs.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.')}(r,t),r);return n=Object.assign({useFetchStreams:!0},n),s._setSettings(n),s},"PUBLIC").setMultipleInstances(!0)),e(Ds,"3.7.3",void 0),e(Ds,"3.7.3","esm2017");export{Vm as AbstractUserDataWriter,Yd as AggregateField,Xd as AggregateQuerySnapshot,Vf as Bytes,vf as CACHE_SIZE_UNLIMITED,qd as CollectionReference,Bd as DocumentReference,Um as DocumentSnapshot,Ff as FieldPath,Bf as FieldValue,If as Firestore,Ks as FirestoreError,Uf as GeoPoint,wf as LoadBundleTask,Ud as Query,ym as QueryConstraint,qm as QueryDocumentSnapshot,Gm as QuerySnapshot,Bm as SnapshotMetadata,ir as Timestamp,lg as Transaction,cg as WriteBatch,ii as _DatabaseId,lr as _DocumentKey,Zs as _EmptyAppCheckTokenProvider,Qs as _EmptyAuthCredentialsProvider,hr as _FieldPath,Ld as _cast,Us as _debugAssert,Wr as _isBase64Available,Vs as _logWarn,Cd as _validateIsNotUsedTogether,eg as addDoc,og as aggregateQuerySnapshotEqual,pg as arrayRemove,gg as arrayUnion,Df as clearIndexedDbPersistence,Gd as collection,Kd as collectionGroup,Pd as connectFirestoreEmulator,tg as deleteDoc,fg as deleteField,kf as disableNetwork,jd as doc,Pf as documentId,_f as enableIndexedDbPersistence,xf as enableMultiTabIndexedDbPersistence,Nf as enableNetwork,km as endAt,Nm as endBefore,Tf as ensureFirestoreConfigured,rg as executeWrite,ag as getCountFromServer,$m as getDoc,zm as getDocFromCache,Hm as getDocFromServer,Wm as getDocs,Ym as getDocsFromCache,Xm as getDocsFromServer,Ef as getFirestore,yg as increment,bf as initializeFirestore,Sm as limit,_m as limitToLast,Lf as loadBundle,Mf as namedQuery,ng as onSnapshot,sg as onSnapshotsInSync,Em as orderBy,wm as query,Qd as queryEqual,$d as refEqual,dg as runTransaction,mg as serverTimestamp,Jm as setDoc,vg as setIndexConfiguration,Ls as setLogLevel,jm as snapshotEqual,Dm as startAfter,Am as startAt,Rf as terminate,Zm as updateDoc,Cf as waitForPendingWrites,Im as where,wg as writeBatch};